{% extends "consumer_base.html" %}

{% block title %}User Management - SkyCareLink{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">User Management</h1>
                <div>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-plus me-2"></i>Add User
                    </button>
                    <a href="{{ url_for('portal_views') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Portal
                    </a>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Filter by Role</label>
                            <select class="form-select" id="roleFilter" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="family">Individual/Family</option>
                                <option value="hospital">Hospital/Clinic</option>
                                <option value="affiliate">Affiliate Provider</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Filter by Sub-Role</label>
                            <select class="form-select" id="subRoleFilter" onchange="filterUsers()">
                                <option value="">All Sub-Roles</option>
                                <option value="PowerUser">PowerUser</option>
                                <option value="TeamUser">TeamUser</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Search Users</label>
                            <input type="text" class="form-control" id="userSearch" placeholder="Name, email, or company..." onkeyup="filterUsers()">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="resetFilters()">
                                <i class="fas fa-refresh"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Users</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>User Info</th>
                                    <th>Role</th>
                                    <th>Sub-Role</th>
                                    <th>Referrals</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-role="{{ user.role }}" data-sub-role="{{ user.sub_role }}" data-search="{{ user.name|lower }} {{ user.email|lower }} {{ user.company|lower }}">
                                    <td>
                                        <div>
                                            <strong>{{ user.name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ user.email }}</small>
                                            {% if user.company %}
                                            <br>
                                            <small class="text-info">{{ user.company }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ user.role_color }}">{{ user.role_display }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if user.sub_role == 'PowerUser' else 'secondary' }}">
                                            {{ user.sub_role }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="small">
                                            <div class="fw-bold text-primary">{{ user.referrals_total or 0 }}</div>
                                            <div class="text-muted">Total</div>
                                            <div class="fw-bold text-success">{{ user.referrals_completed or 0 }}</div>
                                            <div class="text-muted">Completed</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small">
                                            <div class="fw-bold">{{ user.service_type or 'Free Trial' }}</div>
                                            <div class="text-muted">Expires: {{ user.service_expires or 'N/A' }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>

                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editUser({{ user.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown">
                                                    <i class="fas fa-user-cog"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    {% if user.sub_role == 'TeamUser' %}
                                                    <li><a class="dropdown-item" onclick="promoteUser({{ user.id }}, 'PowerUser')">
                                                        <i class="fas fa-arrow-up text-success me-2"></i>Promote to PowerUser
                                                    </a></li>
                                                    {% else %}
                                                    <li><a class="dropdown-item" onclick="demoteUser({{ user.id }}, 'TeamUser')">
                                                        <i class="fas fa-arrow-down text-warning me-2"></i>Demote to TeamUser
                                                    </a></li>
                                                    {% endif %}
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item" onclick="managePermissions({{ user.id }})">
                                                        <i class="fas fa-key text-info me-2"></i>Manage Permissions
                                                    </a></li>
                                                    {% if user.is_active %}
                                                    <li><a class="dropdown-item" onclick="deactivateUser({{ user.id }})">
                                                        <i class="fas fa-ban text-danger me-2"></i>Deactivate
                                                    </a></li>
                                                    {% else %}
                                                    <li><a class="dropdown-item" onclick="activateUser({{ user.id }})">
                                                        <i class="fas fa-check text-success me-2"></i>Activate
                                                    </a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="userPhone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company/Organization</label>
                            <input type="text" class="form-control" id="userCompany">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-select" id="userRole" required>
                                <option value="">Select Role</option>
                                <option value="family">Individual/Family</option>
                                <option value="hospital">Hospital/Clinic</option>
                                <option value="affiliate">Affiliate Provider</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sub-Role *</label>
                            <select class="form-select" id="userSubRole" required>
                                <option value="TeamUser">TeamUser</option>
                                <option value="PowerUser">PowerUser</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Permissions Section -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Permissions</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permRequestTransport" value="Request Transport">
                                    <label class="form-check-label" for="permRequestTransport">Request Transport</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permViewBookings" value="View Bookings">
                                    <label class="form-check-label" for="permViewBookings">View Bookings</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permViewReports" value="View Reports">
                                    <label class="form-check-label" for="permViewReports">View Reports</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permManageTeam" value="Manage Team">
                                    <label class="form-check-label" for="permManageTeam">Manage Team</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permViewAnalytics" value="View Analytics">
                                    <label class="form-check-label" for="permViewAnalytics">View Analytics</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permManageStaff" value="Manage Staff">
                                    <label class="form-check-label" for="permManageStaff">Manage Staff</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permEditProfiles" value="Edit Profiles">
                                    <label class="form-check-label" for="permEditProfiles">Edit Profiles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permManageInvoices" value="Manage Invoices">
                                    <label class="form-check-label" for="permManageInvoices">Manage Invoices</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="permSystemAdmin" value="System Administration">
                                    <label class="form-check-label" for="permSystemAdmin">System Administration</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveUserBtn">Save User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Permissions Modal -->
<div class="modal fade" id="permissionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Permissions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Select permissions for this user based on their role and responsibilities:</p>
                <div class="row">
                    <div class="col-12">
                        <div class="permission-category mb-3">
                            <h6 class="fw-bold text-primary">Core Permissions</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageRequestTransport" value="Request Transport">
                                <label class="form-check-label" for="permManageRequestTransport">Request Transport Services</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageViewBookings" value="View Bookings">
                                <label class="form-check-label" for="permManageViewBookings">View Booking History</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageViewReports" value="View Reports">
                                <label class="form-check-label" for="permManageViewReports">Access Reports</label>
                            </div>
                        </div>
                        
                        <div class="permission-category mb-3">
                            <h6 class="fw-bold text-success">Management Permissions</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageManageTeam" value="Manage Team">
                                <label class="form-check-label" for="permManageManageTeam">Manage Team Members</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageViewAnalytics" value="View Analytics">
                                <label class="form-check-label" for="permManageViewAnalytics">Access Analytics Dashboard</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageEditProfiles" value="Edit Profiles">
                                <label class="form-check-label" for="permManageEditProfiles">Edit User Profiles</label>
                            </div>
                        </div>
                        
                        <div class="permission-category mb-3">
                            <h6 class="fw-bold text-danger">Administrative Permissions</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageManageInvoices" value="Manage Invoices">
                                <label class="form-check-label" for="permManageManageInvoices">Manage Invoices & Billing</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permManageSystemAdmin" value="System Administration">
                                <label class="form-check-label" for="permManageSystemAdmin">System Administration Access</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePermissions()">Save Permissions</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentUserId = null;
let isEditMode = false;

function showAddUserModal() {
    isEditMode = false;
    currentUserId = null;
    document.getElementById('userModalTitle').textContent = 'Add New User';
    document.getElementById('saveUserBtn').textContent = 'Add User';
    document.getElementById('userForm').reset();
    
    // Clear all permission checkboxes
    document.querySelectorAll('input[type="checkbox"][id^="perm"]').forEach(cb => cb.checked = false);
    
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

async function editUser(userId) {
    isEditMode = true;
    currentUserId = userId;
    document.getElementById('userModalTitle').textContent = 'Edit User';
    document.getElementById('saveUserBtn').textContent = 'Update User';
    
    try {
        const response = await fetch(`/api/users/edit/${userId}`);
        const data = await response.json();
        
        if (data.success) {
            const user = data.user;
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userCompany').value = user.company || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userSubRole').value = user.sub_role;
            
            // Set permissions
            document.querySelectorAll('input[type="checkbox"][id^="perm"]').forEach(cb => cb.checked = false);
            if (user.permissions) {
                user.permissions.forEach(perm => {
                    const checkbox = document.querySelector(`input[value="${perm}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            new bootstrap.Modal(document.getElementById('userModal')).show();
        } else {
            alert('Error loading user details: ' + data.error);
        }
    } catch (error) {
        alert('Error loading user details: ' + error.message);
    }
}

async function promoteUser(userId, newSubRole) {
    try {
        const response = await fetch('/api/users/update-subrole', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, sub_role: newSubRole })
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error promoting user: ' + error.message);
    }
}

async function demoteUser(userId, newSubRole) {
    try {
        const response = await fetch('/api/users/update-subrole', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, sub_role: newSubRole })
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error demoting user: ' + error.message);
    }
}

function managePermissions(userId) {
    currentUserId = userId;
    
    // Get current user's permissions and populate modal
    const userRow = document.querySelector(`tr:has([onclick*="${userId}"])`);
    // Reset all checkboxes
    document.querySelectorAll('#permissionsModal input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    new bootstrap.Modal(document.getElementById('permissionsModal')).show();
}

function savePermissions() {
    const selectedPermissions = Array.from(document.querySelectorAll('#permissionsModal input[type="checkbox"]:checked'))
        .map(cb => cb.value);
    
    console.log('Saving permissions for user', currentUserId, ':', selectedPermissions);
    alert('Permissions updated successfully!');
    bootstrap.Modal.getInstance(document.getElementById('permissionsModal')).hide();
}

function activateUser(userId) {
    console.log('Activating user', userId);
    alert('User activated successfully!');
    location.reload();
}

function deactivateUser(userId) {
    if (confirm('Are you sure you want to deactivate this user?')) {
        console.log('Deactivating user', userId);
        alert('User deactivated successfully!');
        location.reload();
    }
}

// Form submission
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        phone: document.getElementById('userPhone').value,
        company: document.getElementById('userCompany').value,
        role: document.getElementById('userRole').value,
        sub_role: document.getElementById('userSubRole').value,
        permissions: Array.from(document.querySelectorAll('#userModal input[type="checkbox"]:checked')).map(cb => cb.value)
    };
    
    try {
        let url, method;
        if (isEditMode && currentUserId) {
            url = `/api/users/update/${currentUserId}`;
            method = 'POST';
        } else {
            url = '/api/users/create';
            method = 'POST';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error saving user: ' + error.message);
    }
});

// Filter functions
function filterUsers() {
    const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
    const subRoleFilter = document.getElementById('subRoleFilter').value.toLowerCase();
    const searchText = document.getElementById('userSearch').value.toLowerCase();
    
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const role = row.dataset.role || '';
        const subRole = row.dataset.subRole || '';
        const searchData = row.dataset.search || '';
        
        const matchesRole = !roleFilter || role.includes(roleFilter);
        const matchesSubRole = !subRoleFilter || subRole.includes(subRoleFilter);
        const matchesSearch = !searchText || searchData.includes(searchText);
        
        row.style.display = matchesRole && matchesSubRole && matchesSearch ? '' : 'none';
    });
}

function resetFilters() {
    document.getElementById('roleFilter').value = '';
    document.getElementById('subRoleFilter').value = '';
    document.getElementById('userSearch').value = '';
    filterUsers();
}
</script>
</div>

<script>
// User management functionality
function filterUsers() {
    const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
    const subRoleFilter = document.getElementById('subRoleFilter').value.toLowerCase();
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    
    const rows = document.querySelectorAll('#usersTable tbody tr');
    rows.forEach(row => {
        const role = row.dataset.role;
        const subRole = row.dataset.subRole;
        const searchText = row.dataset.search;
        
        const roleMatch = !roleFilter || role === roleFilter;
        const subRoleMatch = !subRoleFilter || subRole === subRoleFilter;
        const searchMatch = !searchTerm || searchText.includes(searchTerm);
        
        row.style.display = (roleMatch && subRoleMatch && searchMatch) ? '' : 'none';
    });
}

function resetFilters() {
    document.getElementById('roleFilter').value = '';
    document.getElementById('subRoleFilter').value = '';
    document.getElementById('userSearch').value = '';
    filterUsers();
}

function showAddUserModal() {
    document.getElementById('userModalTitle').textContent = 'Add New User';
    document.getElementById('userForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function editUser(userId) {
    // Populate form with user data
    document.getElementById('userModalTitle').textContent = 'Edit User';
    // TODO: Load user data from backend
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function promoteUser(userId, newSubRole) {
    if (confirm(`Promote user to ${newSubRole}? This will grant additional permissions.`)) {
        updateUserSubRole(userId, newSubRole);
    }
}

function demoteUser(userId, newSubRole) {
    if (confirm(`Demote user to ${newSubRole}? This will restrict certain permissions.`)) {
        updateUserSubRole(userId, newSubRole);
    }
}

function updateUserSubRole(userId, subRole) {
    fetch('/api/users/update-subrole', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, sub_role: subRole })
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              showToast(`User ${subRole === 'PowerUser' ? 'promoted' : 'demoted'} successfully`, 'success');
              location.reload();
          } else {
              showToast('Error updating user role', 'error');
          }
      });
}

function managePermissions(userId) {
    showToast('Permission management interface opening...', 'info');
}

function activateUser(userId) {
    updateUserStatus(userId, true);
}

function deactivateUser(userId) {
    if (confirm('Deactivate this user? They will lose access to the system.')) {
        updateUserStatus(userId, false);
    }
}

function updateUserStatus(userId, isActive) {
    fetch('/api/users/update-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, is_active: isActive })
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              showToast(`User ${isActive ? 'activated' : 'deactivated'} successfully`, 'success');
              location.reload();
          }
      });
}

function updateSubRoleOptions() {
    const role = document.getElementById('userRole').value;
    const subRoleSelect = document.getElementById('userSubRole');
    
    // All roles can have PowerUser or TeamUser sub-roles
    // PowerUser: Can manage team members, access advanced features
    // TeamUser: Basic access, managed by PowerUsers
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `${message} <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Form submission
document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userData = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        role: document.getElementById('userRole').value,
        sub_role: document.getElementById('userSubRole').value,
        phone: document.getElementById('userPhone').value,
        company: document.getElementById('userCompany').value
    };
    
    fetch('/api/users/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
              showToast('User created successfully', 'success');
              location.reload();
          } else {
              showToast('Error creating user', 'error');
          }
      });
});
</script>

{% endblock %}
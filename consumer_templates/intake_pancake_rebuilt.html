{% extends "consumer_base.html" %}

{% block title %}Medical Transport Request - SkyCareLink{% endblock %}

{% block content %}
<style>
/* Enhanced Pancake Stepper Styles */
.pancake-stack {
    max-width: 900px;
    margin: 0 auto;
}

.pancake-step {
    border: 1px solid #e3f2fd;
    border-radius: 4px;
    margin-bottom: 0.35rem;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
}

.pancake-step.active {
    border-color: #1976d2;
    box-shadow: 0 4px 16px rgba(25,118,210,0.2);
}

.pancake-step.completed {
    border-color: #4caf50;
    background: #f8fff8;
}

.pancake-step.collapsed {
    border-color: #e0e0e0;
    background: #fafafa;
}

.pancake-header {
    padding: 0.4rem 0.6rem;
    cursor: pointer;
    border-bottom: 1px solid transparent;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.pancake-step.active .pancake-header {
    border-bottom-color: #e3f2fd;
    background: linear-gradient(135deg, #e3f2fd 0%, #f3f9ff 100%);
}

.pancake-step.completed .pancake-header {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
}

.pancake-step.collapsed .pancake-header {
    background: #f5f5f5;
}

.pancake-content {
    padding: 0.6rem;
    display: none;
}

.pancake-step.active .pancake-content {
    display: block;
    animation: slideDown 0.3s ease;
}

.step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #1976d2;
    color: white;
    font-weight: bold;
    margin-right: 0.4rem;
    font-size: 0.75rem;
}

.pancake-step.completed .step-number {
    background: #4caf50;
}

.pancake-step.collapsed .step-number {
    background: #9e9e9e;
}

.pancake-icon {
    transition: transform 0.3s ease;
}

.pancake-step.active .pancake-icon {
    transform: rotate(180deg);
}

.service-card, .severity-card {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 0.3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    height: auto;
    min-height: 60px;
    font-size: 0.8rem;
}

.service-card:hover, .severity-card:hover {
    border-color: #1976d2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.service-card.selected, .severity-card.selected {
    border-color: #1976d2;
    background: #e3f2fd;
    transform: translateY(-2px);
}

.severity-row {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.severity-card {
    flex: 1;
    min-height: 95px;
    max-width: 160px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.pancake-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding-top: 0.4rem;
    border-top: 1px solid #e0e0e0;
}

/* Compact Form Controls */
.pancake-content .form-control,
.pancake-content .form-select {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    height: calc(1.5em + 0.5rem + 2px);
}

.pancake-content .form-control-sm,
.pancake-content .form-select-sm {
    padding: 0.2rem 0.4rem;
    font-size: 0.8rem;
    height: calc(1.5em + 0.4rem + 2px);
}

.pancake-content textarea.form-control-sm {
    height: auto;
    min-height: calc(1.5em + 0.4rem + 2px);
}

.family-seat-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.5rem;
}

.seat-counter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.seat-btn {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 4px;
    background: #1976d2;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.seat-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.mfa-requirement {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 1rem;
    margin: 1rem 0;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.equipment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
    margin: 1rem 0;
}

.equipment-item {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.equipment-item:hover {
    border-color: #1976d2;
    background: #f8f9fa;
}

.equipment-item.selected {
    border-color: #1976d2;
    background: #e3f2fd;
}

.equipment-description {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}
</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">


                    <form id="intakeForm" method="POST">
                        <div class="pancake-stack">
                            
                            <!-- Step 1: Service Type Selection -->
                            <div class="pancake-step active" id="step-1" data-step="1">
                                <div class="pancake-header" onclick="toggleStep(1)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">1</span>
                                            Service Type Selection
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <p class="text-muted mb-3">Select the type of medical transport service you need</p>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="service-card" data-service="critical" onclick="selectService('critical')">
                                                <div class="service-icon mb-2">
                                                    <i class="fas fa-exclamation-triangle text-danger fa-2x"></i>
                                                </div>
                                                <h6>Critical Transport</h6>
                                                <p class="small text-muted">Immediate, life-threatening situations</p>
                                                <span class="badge bg-danger">Urgent</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="service-card" data-service="non-critical" onclick="selectService('non-critical')">
                                                <div class="service-icon mb-2">
                                                    <i class="fas fa-calendar-alt text-primary fa-2x"></i>
                                                </div>
                                                <h6>Scheduled Transport</h6>
                                                <p class="small text-muted">Planned medical transfers</p>
                                                <span class="badge bg-primary">Standard rates</span>
                                            </div>
                                        </div>

                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <div></div>
                                        <button type="button" class="btn btn-primary btn-sm" id="nextStep1" onclick="nextStep()" disabled>
                                            Next: Patient Severity <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Patient Severity Level -->
                            <div class="pancake-step" id="step-2" data-step="2">
                                <div class="pancake-header" onclick="toggleStep(2)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">2</span>
                                            Patient Severity Level
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <p class="text-muted mb-3">Select the patient's medical condition severity level</p>
                                    <div class="severity-row">
                                        <div class="severity-card" data-severity="low" onclick="selectSeverity('low')">
                                            <i class="fas fa-user text-success fa-2x mb-2"></i>
                                            <h6>Level 1 - Low Severity</h6>
                                            <p class="small text-muted">Stable condition, routine transport</p>
                                            <span class="badge bg-success">Standard equipment</span>
                                        </div>
                                        <div class="severity-card" data-severity="medium" onclick="selectSeverity('medium')">
                                            <i class="fas fa-heartbeat text-warning fa-2x mb-2"></i>
                                            <h6>Level 2 - Medium Severity</h6>
                                            <p class="small text-muted">Monitoring required, stable but complex</p>
                                            <span class="badge bg-warning">Enhanced monitoring</span>
                                        </div>
                                        <div class="severity-card" data-severity="high" onclick="selectSeverity('high')">
                                            <i class="fas fa-ambulance text-danger fa-2x mb-2"></i>
                                            <h6>Level 3 - High Severity</h6>
                                            <p class="small text-muted">Critical condition, intensive care</p>
                                            <span class="badge bg-danger">Full life support</span>
                                        </div>
                                    </div>

                                    <!-- Medical Equipment Section - Moved from Step 4 to Step 2 -->
                                    <div class="mt-4" id="equipmentSectionFromStep4">
                                        <h6 class="mb-3">
                                            <i class="fas fa-medical-case me-2"></i>Required Medical Equipment
                                            <small class="text-muted">(Auto-selected based on severity level)</small>
                                        </h6>
                                        
                                        <!-- Required Equipment Display -->
                                        <div id="severityEquipmentSection" style="display: none;">
                                            <div class="equipment-grid" id="severityEquipmentGrid">
                                                <!-- Equipment options will be populated based on severity selection -->
                                            </div>
                                        </div>

                                        <!-- Additional Equipment Options -->
                                        <div class="mt-3" id="additionalEquipmentSection" style="display: none;">
                                            <h6 class="mb-2">
                                                <i class="fas fa-plus-circle me-2"></i>Additional Equipment
                                                <small class="text-muted">(Select if needed beyond standard level)</small>
                                            </h6>
                                            <div class="equipment-grid" id="additionalEquipmentGrid">
                                                <div class="equipment-item" data-equipment="oxygen">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="oxygen_supply" id="equipOxygen">
                                                        <label class="form-check-label flex-grow-1" for="equipOxygen">
                                                            <strong>Oxygen Supply</strong>
                                                            <div class="equipment-description">Basic oxygen therapy for respiratory support</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="ventilator">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="advanced_ventilator" id="equipVentilator">
                                                        <label class="form-check-label flex-grow-1" for="equipVentilator">
                                                            <strong>Advanced Ventilator</strong>
                                                            <div class="equipment-description">Full mechanical ventilation with multiple modes</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="cardiac">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="cardiac_monitor" id="equipCardiac">
                                                        <label class="form-check-label flex-grow-1" for="equipCardiac">
                                                            <strong>Cardiac Monitor</strong>
                                                            <div class="equipment-description">Advanced heart rhythm and vital signs monitoring</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="defibrillator">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="defibrillator" id="equipDefib">
                                                        <label class="form-check-label flex-grow-1" for="equipDefib">
                                                            <strong>Defibrillator</strong>
                                                            <div class="equipment-description">Emergency cardiac rhythm correction device</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="balloon">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="balloon_pump" id="equipBalloon">
                                                        <label class="form-check-label flex-grow-1" for="equipBalloon">
                                                            <strong>Balloon Pump</strong>
                                                            <div class="equipment-description">Intra-aortic balloon pump for cardiac support</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="ecmo">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="ecmo" id="equipEcmo">
                                                        <label class="form-check-label flex-grow-1" for="equipEcmo">
                                                            <strong>ECMO</strong>
                                                            <div class="equipment-description">Extracorporeal membrane oxygenation for critical life support</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="iv_pump">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="iv_pump" id="equipIv">
                                                        <label class="form-check-label flex-grow-1" for="equipIv">
                                                            <strong>IV Pump</strong>
                                                            <div class="equipment-description">Intravenous medication delivery system</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="suction">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="suction_unit" id="equipSuction">
                                                        <label class="form-check-label flex-grow-1" for="equipSuction">
                                                            <strong>Suction Unit</strong>
                                                            <div class="equipment-description">Airway clearance and secretion management</div>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="equipment-item" data-equipment="incubator">
                                                    <div class="d-flex align-items-center">
                                                        <input class="form-check-input me-2" type="checkbox" name="additional_equipment" value="transport_incubator" id="equipIncubator">
                                                        <label class="form-check-label flex-grow-1" for="equipIncubator">
                                                            <strong>Transport Incubator</strong>
                                                            <div class="equipment-description">Neonatal intensive care transport unit</div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Specialized Care Needs -->
                                        <div class="mt-3" id="specializedCareSection" style="display: none;">
                                            <h6 class="mb-2">
                                                <i class="fas fa-tags me-2"></i>Specialized Care Needs
                                                <small class="text-muted">(Select if applicable)</small>
                                            </h6>
                                            <div class="row g-2">
                                                <div class="col-md-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="specialized_care" value="pediatric" id="carePediatric">
                                                        <label class="form-check-label" for="carePediatric">Pediatric</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="specialized_care" value="nicu" id="careNicu">
                                                        <label class="form-check-label" for="careNicu">NICU</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="specialized_care" value="cardiac" id="careCardiac">
                                                        <label class="form-check-label" for="careCardiac">Cardiac</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="specialized_care" value="neurological" id="careNeuro">
                                                        <label class="form-check-label" for="careNeuro">Neurological</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-primary btn-sm" id="nextStep2" onclick="nextStep()" disabled>
                                            Next: Locations <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Location Details -->
                            <div class="pancake-step" id="step-3" data-step="3">
                                <div class="pancake-header" onclick="toggleStep(3)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">3</span>
                                            Location Details
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <div class="row g-3">
                                        <!-- From Location -->
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-2">
                                                <i class="fas fa-map-marker-alt me-2"></i>From Location
                                            </h6>
                                            <div class="mb-2">
                                                <label class="form-label small">Hospital/Facility Name</label>
                                                <input type="text" class="form-control form-control-sm compact-input" name="from_hospital" id="fromHospital" 
                                                       placeholder="Enter hospital or facility name" autocomplete="off">
                                                <div id="fromHospitalSuggestions" class="dropdown-menu w-100" style="max-height: 150px; overflow-y: auto;"></div>
                                                <div class="form-text small">Start typing for suggestions</div>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">Address</label>
                                                <input type="text" class="form-control form-control-sm compact-input" name="from_address" id="fromAddress" 
                                                       placeholder="Street address">
                                            </div>
                                            <div class="row g-2">
                                                <div class="col-8">
                                                    <label class="form-label small">City</label>
                                                    <input type="text" class="form-control form-control-sm compact-input" name="from_city" id="fromCity" 
                                                           placeholder="City">
                                                </div>
                                                <div class="col-4">
                                                    <label class="form-label small">State</label>
                                                    <select class="form-select form-select-sm compact-input" name="from_state" id="fromState">
                                                        <option value="">State</option>
                                                        <!-- US States will be populated -->
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- To Location -->
                                        <div class="col-md-6">
                                            <h6 class="text-success mb-2">
                                                <i class="fas fa-map-marker-alt me-2"></i>To Location
                                            </h6>
                                            <div class="mb-2">
                                                <label class="form-label small">Hospital/Facility Name</label>
                                                <input type="text" class="form-control form-control-sm compact-input" name="to_hospital" id="toHospital" 
                                                       placeholder="Enter destination hospital" autocomplete="off">
                                                <div id="toHospitalSuggestions" class="dropdown-menu w-100" style="max-height: 150px; overflow-y: auto;"></div>
                                                <div class="form-text small">Start typing for suggestions</div>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">Address</label>
                                                <input type="text" class="form-control form-control-sm compact-input" name="to_address" id="toAddress" 
                                                       placeholder="Street address">
                                            </div>
                                            <div class="row g-2">
                                                <div class="col-8">
                                                    <label class="form-label small">City</label>
                                                    <input type="text" class="form-control form-control-sm compact-input" name="to_city" id="toCity" 
                                                           placeholder="City">
                                                </div>
                                                <div class="col-4">
                                                    <label class="form-label small">State</label>
                                                    <select class="form-select form-select-sm compact-input" name="to_state" id="toState">
                                                        <option value="">State</option>
                                                        <!-- US States will be populated -->
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Preferred Time -->
                                    <div class="row g-2 mt-2">
                                        <div class="col-md-6">
                                            <label class="form-label small">Preferred Transport Time</label>
                                            <select class="form-select form-select-sm compact-input" name="preferred_time" id="preferredTime">
                                                <option value="">Select preferred time</option>
                                                <option value="flexible">Flexible</option>
                                                <option value="morning">Morning (6 AM - 12 PM)</option>
                                                <option value="afternoon">Afternoon (12 PM - 6 PM)</option>
                                                <option value="evening">Evening (6 PM - 12 AM)</option>
                                                <option value="overnight">Overnight (12 AM - 6 AM)</option>
                                                <option value="asap">ASAP</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Family Seating Requirements</label>
                                            <div class="family-seat-selector">
                                                <span class="me-2 small">Additional family seats:</span>
                                                <div class="seat-counter">
                                                    <button type="button" class="seat-btn" onclick="adjustFamilySeats(-1)" id="seatMinus">-</button>
                                                    <span class="mx-2 fw-bold" id="familySeatsCount">0</span>
                                                    <button type="button" class="seat-btn" onclick="adjustFamilySeats(1)" id="seatPlus">+</button>
                                                </div>
                                                <small class="text-muted ms-2">(Up to 3 seats)</small>
                                            </div>
                                            <div class="form-text small">Most aircraft can accommodate 1-3 additional passengers</div>
                                        </div>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-primary btn-sm" id="nextStep3" onclick="nextStep()" disabled>
                                            Next: Patient Info <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Patient Information -->
                            <div class="pancake-step" id="step-4" data-step="4">
                                <div class="pancake-header" onclick="toggleStep(4)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">4</span>
                                            Patient Information
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <div class="row g-2">
                                        <!-- Contact Name First/Last (Required) -->
                                        <div class="col-md-6">
                                            <label class="form-label small">Contact First Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control form-control-sm compact-input" name="contact_first_name" id="contactFirstName" 
                                                   placeholder="First name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Contact Last Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control form-control-sm compact-input" name="contact_last_name" id="contactLastName" 
                                                   placeholder="Last name" required>
                                        </div>

                                        <!-- Patient Last Name & Relation (Optional) -->
                                        <div class="col-md-6">
                                            <label class="form-label small">Patient Last Name</label>
                                            <input type="text" class="form-control form-control-sm compact-input" name="patient_last_name" id="patientLastName" 
                                                   placeholder="Patient's last name (optional)">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Relation to Patient</label>
                                            <select class="form-select form-select-sm compact-input" name="relation_to_patient" id="relationToPatient">
                                                <option value="">Select relation (optional)</option>
                                                <option value="parent">Parent</option>
                                                <option value="spouse">Spouse</option>
                                                <option value="child">Child</option>
                                                <option value="sibling">Sibling</option>
                                                <option value="guardian">Legal Guardian</option>
                                                <option value="healthcare_proxy">Healthcare Proxy</option>
                                                <option value="medical_staff">Medical Staff</option>
                                                <option value="social_worker">Social Worker</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>

                                        <!-- Gender -->
                                        <div class="col-md-4">
                                            <label class="form-label small">Gender</label>
                                            <select class="form-select form-select-sm compact-input" name="patient_gender" id="patientGender" required>
                                                <option value="">Select gender</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="unknown">Unknown</option>
                                            </select>
                                        </div>

                                        <!-- Age Range -->
                                        <div class="col-md-4">
                                            <label class="form-label small">Age Range</label>
                                            <select class="form-select form-select-sm compact-input" name="patient_age_range" id="patientAgeRange">
                                                <option value="">Select age range</option>
                                                <option value="newborn">Newborn (0-1 month)</option>
                                                <option value="infant">Infant (1-12 months)</option>
                                                <option value="toddler">Toddler (1-3 years)</option>
                                                <option value="child">Child (4-12 years)</option>
                                                <option value="teen">Teen (13-17 years)</option>
                                                <option value="adult">Adult (18-64 years)</option>
                                                <option value="senior">Senior (65+ years)</option>
                                            </select>
                                        </div>

                                        <!-- Weight Range -->
                                        <div class="col-md-4">
                                            <label class="form-label small">Weight Range</label>
                                            <select class="form-select form-select-sm compact-input" name="patient_weight" id="patientWeight">
                                                <option value="">Select weight range</option>
                                                <option value="under-50">Under 50 lbs</option>
                                                <option value="50-100">50-100 lbs</option>
                                                <option value="100-150">100-150 lbs</option>
                                                <option value="150-200">150-200 lbs</option>
                                                <option value="200-250">200-250 lbs</option>
                                                <option value="250-300">250-300 lbs</option>
                                                <option value="over-300">Over 300 lbs</option>
                                            </select>
                                        </div>
                                    </div>



                                    <!-- Additional Information -->
                                    <div class="mt-3">
                                        <label class="form-label small">
                                            Additional Medical Information
                                            <small class="text-muted">(No PII/PHI - Personally Identifiable Information / Protected Health Information)</small>
                                        </label>
                                        <textarea class="form-control form-control-sm compact-input" name="additional_info" id="additionalInfo" rows="2" 
                                                  placeholder="Brief description of medical needs, special requirements, or concerns (avoid patient names, dates of birth, SSN, etc.)"></textarea>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-primary btn-sm" id="nextStep4" onclick="nextStep()" disabled>
                                            Next: Review & Submit <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 5: Review and Submit -->
                            <div class="pancake-step" id="step-5" data-step="5">
                                <div class="pancake-header" onclick="toggleStep(5)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">5</span>
                                            Review & Submit
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <div id="reviewSummary">
                                        <!-- Review content will be populated dynamically -->
                                    </div>

                                    <!-- Disclaimers -->
                                    <div class="alert alert-warning mt-4">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Disclaimers</h6>
                                        <ul class="mb-0 small">
                                            <li>All quotes are estimates and final pricing may vary based on actual requirements</li>
                                            <li>Family seating is subject to aircraft availability and weight limitations</li>
                                            <li>Medical equipment availability confirmed at time of booking</li>
                                            <li>Same-day transport subject to provider availability and weather conditions</li>
                                            <li>Excessive quote requests (4+) incur a $99 processing fee</li>
                                        </ul>
                                    </div>

                                    <!-- Terms Agreement -->
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                        <label class="form-check-label" for="agreeTerms">
                                            I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>
                                        </label>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="submit" class="btn btn-success btn-sm" id="submitRequest" disabled>
                                            <i class="fas fa-paper-plane me-2"></i>Submit Quote Request
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>
                    
                    <!-- MFA Requirement Notice - Moved to bottom -->
                    {% if not session.get('logged_in') %}
                    <div class="mfa-requirement mt-4">
                        <h6><i class="fas fa-shield-alt me-2"></i>Security Requirements</h6>
                        <p class="mb-2">To submit a quote request, you must:</p>
                        <ul class="mb-2">
                            <li>Create a verified account with email and phone confirmation</li>
                            <li>Complete multi-factor authentication (MFA)</li>
                            <li>Agree to $99 fee for excessive quote requests (4+ quotes)</li>
                        </ul>
                        <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">Login/Register Now</a>
                        <span class="text-muted ms-2">or continue to save your progress</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced Pancake Stepper JavaScript
let currentStep = 1;
let formData = {};
let familySeats = 0;

// US States data
const US_STATES = [
    'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
    'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
    'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
    'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
    'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
];

// Medical equipment data
const MEDICAL_EQUIPMENT = {
    basic: [
        { id: 'oxygen', name: 'Oxygen Supply', description: 'Basic oxygen therapy for respiratory support', cost: 0 },
        { id: 'monitor', name: 'Basic Monitor', description: 'Vital signs monitoring during transport', cost: 0 },
        { id: 'stretcher', name: 'Medical Stretcher', description: 'Standard patient transport stretcher', cost: 0 }
    ],
    intermediate: [
        { id: 'oxygen', name: 'Oxygen Supply', description: 'Basic oxygen therapy for respiratory support', cost: 0 },
        { id: 'cardiac_monitor', name: 'Cardiac Monitor', description: 'Advanced heart rhythm and vital signs monitoring', cost: 0 },
        { id: 'iv_pump', name: 'IV Pump', description: 'Intravenous medication delivery system', cost: 0 },
        { id: 'suction', name: 'Suction Unit', description: 'Airway clearance and secretion management', cost: 0 },
        { id: 'transport_vent', name: 'Transport Ventilator', description: 'Mechanical breathing support during transport', cost: 0 }
    ],
    advanced: [
        { id: 'oxygen', name: 'Oxygen Supply', description: 'Basic oxygen therapy for respiratory support', cost: 0 },
        { id: 'ventilator', name: 'Advanced Ventilator', description: 'Full mechanical ventilation with multiple modes', cost: 0 },
        { id: 'cardiac_monitor', name: 'Cardiac Monitor', description: 'Advanced heart rhythm and vital signs monitoring', cost: 0 },
        { id: 'defibrillator', name: 'Defibrillator', description: 'Emergency cardiac rhythm correction device', cost: 0 },
        { id: 'balloon_pump', name: 'Balloon Pump', description: 'Intra-aortic balloon pump for cardiac support', cost: 0 },
        { id: 'ecmo', name: 'ECMO', description: 'Extracorporeal membrane oxygenation for critical life support', cost: 0 },
        { id: 'iv_pump', name: 'IV Pump', description: 'Intravenous medication delivery system', cost: 0 },
        { id: 'suction', name: 'Suction Unit', description: 'Airway clearance and secretion management', cost: 0 },
        { id: 'incubator', name: 'Transport Incubator', description: 'Neonatal intensive care transport unit', cost: 0 }
    ]
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    populateStates();
    restoreFormData();
    updateStepValidation();
    
    // Auto-save form data on input changes
    document.getElementById('intakeForm').addEventListener('input', saveFormData);
    document.getElementById('intakeForm').addEventListener('change', saveFormData);
    
    console.log('Enhanced SkyCareLink Pancake Stepper Loaded');
});

// Populate state dropdowns
function populateStates() {
    const fromState = document.getElementById('fromState');
    const toState = document.getElementById('toState');
    
    US_STATES.forEach(state => {
        fromState.innerHTML += `<option value="${state}">${state}</option>`;
        toState.innerHTML += `<option value="${state}">${state}</option>`;
    });
}

// Service selection
function selectService(serviceType) {
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    document.querySelector(`[data-service="${serviceType}"]`).classList.add('selected');
    formData.serviceType = serviceType;
    
    updateStepValidation();
    saveFormData();
}

// Severity selection
function selectSeverity(severity) {
    document.querySelectorAll('.severity-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    document.querySelector(`[data-severity="${severity}"]`).classList.add('selected');
    formData.severity = severity;
    
    // Populate equipment in Step 2 based on severity
    populateEquipmentInStep2(severity);
    
    updateStepValidation();
    saveFormData();
}

// Populate equipment in Step 2 based on severity level
function populateEquipmentInStep2(severityLevel) {
    const severityEquipmentSection = document.getElementById('severityEquipmentSection');
    const severityEquipmentGrid = document.getElementById('severityEquipmentGrid');
    const additionalEquipmentSection = document.getElementById('additionalEquipmentSection');
    const specializedCareSection = document.getElementById('specializedCareSection');
    
    // Show equipment sections
    severityEquipmentSection.style.display = 'block';
    additionalEquipmentSection.style.display = 'block';
    specializedCareSection.style.display = 'block';
    
    // Clear previous equipment
    severityEquipmentGrid.innerHTML = '';
    
    // Remove any existing hidden inputs for severity equipment
    const existingInputs = document.querySelectorAll('input[name="severity_equipment"]');
    existingInputs.forEach(input => input.remove());
    
    // Define equipment mapping based on severity
    const equipmentMapping = {
        'low': ['monitor'], // Level 1
        'medium': ['monitor', 'stretcher'], // Level 2  
        'high': ['monitor', 'stretcher', 'oxygen'] // Level 3
    };
    
    const equipmentLabels = {
        'monitor': 'Basic Monitoring',
        'stretcher': 'Medical Stretcher',
        'oxygen': 'Oxygen Support'
    };
    
    const requiredEquipment = equipmentMapping[severityLevel] || [];
    
    // Populate required equipment (auto-selected, read-only)
    requiredEquipment.forEach(equipment => {
        const equipmentDiv = document.createElement('div');
        equipmentDiv.className = 'equipment-item required-equipment';
        equipmentDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <input class="form-check-input me-2" type="checkbox" name="required_equipment" 
                       value="${equipment}" id="req${equipment}" checked disabled>
                <label class="form-check-label flex-grow-1" for="req${equipment}">
                    <strong>${equipmentLabels[equipment]}</strong>
                    <div class="equipment-description text-success">Included with ${severityLevel === 'low' ? 'Level 1' : severityLevel === 'medium' ? 'Level 2' : 'Level 3'} severity</div>
                </label>
            </div>
        `;
        severityEquipmentGrid.appendChild(equipmentDiv);
        
        // Add hidden input for form submission
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'severity_equipment';
        hiddenInput.value = equipment;
        document.getElementById('intakeForm').appendChild(hiddenInput);
    });
}

// Populate equipment based on severity
function populateEquipment(severity) {
    const equipmentGrid = document.getElementById('equipmentGrid');
    let equipmentList = [];
    
    switch(severity) {
        case 'low':
            equipmentList = MEDICAL_EQUIPMENT.basic;
            break;
        case 'medium':
            equipmentList = MEDICAL_EQUIPMENT.intermediate;
            break;
        case 'high':
            equipmentList = MEDICAL_EQUIPMENT.advanced;
            break;
    }
    
    equipmentGrid.innerHTML = '';
    
    equipmentList.forEach(equipment => {
        const equipmentItem = document.createElement('div');
        equipmentItem.className = 'equipment-item';
        equipmentItem.setAttribute('data-equipment', equipment.id);
        equipmentItem.onclick = () => toggleEquipment(equipment.id);
        
        equipmentItem.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="eq_${equipment.id}" name="equipment" value="${equipment.id}">
                <label class="form-check-label" for="eq_${equipment.id}">
                    <strong>${equipment.name}</strong>
                    <div class="equipment-description">${equipment.description}</div>
                </label>
            </div>
        `;
        
        equipmentGrid.appendChild(equipmentItem);
    });
    
    // Auto-select basic equipment for medium/high severity
    if (severity === 'medium' || severity === 'high') {
        ['oxygen', 'cardiac_monitor'].forEach(eqId => {
            const checkbox = document.getElementById(`eq_${eqId}`);
            if (checkbox) {
                checkbox.checked = true;
                document.querySelector(`[data-equipment="${eqId}"]`).classList.add('selected');
            }
        });
    }
    
    if (severity === 'high') {
        const ventilatorCheckbox = document.getElementById('eq_ventilator');
        if (ventilatorCheckbox) {
            ventilatorCheckbox.checked = true;
            document.querySelector('[data-equipment="ventilator"]').classList.add('selected');
        }
    }
}

// Toggle equipment selection
function toggleEquipment(equipmentId) {
    const checkbox = document.getElementById(`eq_${equipmentId}`);
    const item = document.querySelector(`[data-equipment="${equipmentId}"]`);
    
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        item.classList.add('selected');
    } else {
        item.classList.remove('selected');
    }
    
    saveFormData();
}

// Family seats adjustment
function adjustFamilySeats(change) {
    const newCount = familySeats + change;
    
    if (newCount >= 0 && newCount <= 3) {
        familySeats = newCount;
        document.getElementById('familySeatsCount').textContent = familySeats;
        formData.familySeats = familySeats;
        
        // Update button states
        document.getElementById('seatMinus').disabled = familySeats === 0;
        document.getElementById('seatPlus').disabled = familySeats === 3;
        
        saveFormData();
    }
}

// Step navigation
function nextStep() {
    if (currentStep < 5 && validateCurrentStep()) {
        // Mark current step as completed
        const currentStepElement = document.getElementById(`step-${currentStep}`);
        currentStepElement.classList.remove('active');
        currentStepElement.classList.add('completed');
        
        // Move to next step
        currentStep++;
        const nextStepElement = document.getElementById(`step-${currentStep}`);
        nextStepElement.classList.add('active');
        
        // Scroll to new step
        nextStepElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        updateStepValidation();
        saveFormData();
    }
}

function prevStep() {
    if (currentStep > 1) {
        // Mark current step as inactive
        const currentStepElement = document.getElementById(`step-${currentStep}`);
        currentStepElement.classList.remove('active');
        
        // Move to previous step
        currentStep--;
        const prevStepElement = document.getElementById(`step-${currentStep}`);
        prevStepElement.classList.remove('completed');
        prevStepElement.classList.add('active');
        
        // Scroll to previous step
        prevStepElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        updateStepValidation();
    }
}

// Toggle step (for manual navigation)
function toggleStep(stepNumber) {
    if (stepNumber <= currentStep || isStepCompleted(stepNumber - 1)) {
        // Allow navigation to current step or completed previous steps
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        
        currentStep = stepNumber;
        const targetStep = document.getElementById(`step-${currentStep}`);
        targetStep.classList.add('active');
        targetStep.classList.remove('completed');
        
        updateStepValidation();
    }
}

// Validate current step
function validateCurrentStep() {
    switch(currentStep) {
        case 1:
            return formData.serviceType;
        case 2:
            return formData.severity;
        case 3:
            return document.getElementById('fromHospital').value && 
                   document.getElementById('toHospital').value &&
                   document.getElementById('fromCity').value &&
                   document.getElementById('toCity').value &&
                   document.getElementById('fromState').value &&
                   document.getElementById('toState').value;
        case 4:
            return document.getElementById('contactFirstName').value &&
                   document.getElementById('contactLastName').value &&
                   document.getElementById('patientGender').value;
        case 5:
            return document.getElementById('agreeTerms').checked;
        default:
            return true;
    }
}

// Update step validation and button states
function updateStepValidation() {
    // Update next buttons
    for (let i = 1; i <= 4; i++) {
        const nextButton = document.getElementById(`nextStep${i}`);
        if (nextButton && currentStep === i) {
            nextButton.disabled = !validateCurrentStep();
        }
    }
    
    // Update submit button
    const submitButton = document.getElementById('submitRequest');
    if (submitButton && currentStep === 5) {
        submitButton.disabled = !validateCurrentStep();
    }
    
    // Update step completion indicators
    updateStepIndicators();
}

// Update step visual indicators
function updateStepIndicators() {
    for (let i = 1; i <= 5; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        const completionStatus = stepElement.querySelector('.completion-status');
        
        if (i < currentStep) {
            completionStatus.innerHTML = '<i class="fas fa-check text-success"></i>';
        } else if (i === currentStep) {
            completionStatus.innerHTML = '<i class="fas fa-edit text-primary"></i>';
        } else {
            completionStatus.innerHTML = '';
        }
    }
}

// Check if step is completed
function isStepCompleted(stepNumber) {
    return stepNumber < currentStep;
}

// Save form data to localStorage
function saveFormData() {
    try {
        // Collect current form values
        const form = document.getElementById('intakeForm');
        const formDataNew = new FormData(form);
        
        // Convert to object
        const dataObject = {};
        for (let [key, value] of formDataNew.entries()) {
            if (dataObject[key]) {
                // Handle multiple values (like checkboxes)
                if (Array.isArray(dataObject[key])) {
                    dataObject[key].push(value);
                } else {
                    dataObject[key] = [dataObject[key], value];
                }
            } else {
                dataObject[key] = value;
            }
        }
        
        // Add non-form data
        dataObject.currentStep = currentStep;
        dataObject.familySeats = familySeats;
        dataObject.serviceType = formData.serviceType;
        dataObject.severity = formData.severity;
        
        localStorage.setItem('mediflyIntakeData', JSON.stringify(dataObject));
        console.log('Form data saved to localStorage');
    } catch (error) {
        console.error('Error saving form data:', error);
    }
}

// Restore form data from localStorage
function restoreFormData() {
    try {
        const savedData = localStorage.getItem('mediflyIntakeData');
        if (savedData) {
            const dataObject = JSON.parse(savedData);
            
            // Restore form values
            Object.entries(dataObject).forEach(([key, value]) => {
                const element = document.querySelector(`[name="${key}"]`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = Array.isArray(value) ? value.includes(element.value) : value === element.value;
                    } else {
                        element.value = value;
                    }
                }
            });
            
            // Restore special data
            if (dataObject.familySeats) {
                familySeats = parseInt(dataObject.familySeats);
                document.getElementById('familySeatsCount').textContent = familySeats;
            }
            
            if (dataObject.serviceType) {
                formData.serviceType = dataObject.serviceType;
                const serviceCard = document.querySelector(`[data-service="${dataObject.serviceType}"]`);
                if (serviceCard) serviceCard.classList.add('selected');
            }
            
            if (dataObject.severity) {
                formData.severity = dataObject.severity;
                const severityCard = document.querySelector(`[data-severity="${dataObject.severity}"]`);
                if (severityCard) severityCard.classList.add('selected');
                populateEquipment(dataObject.severity);
            }
            
            console.log('Form data restored from localStorage');
        }
    } catch (error) {
        console.error('Error restoring form data:', error);
    }
}

// Form submission
document.getElementById('intakeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateCurrentStep()) {
        alert('Please complete all required fields before submitting.');
        return;
    }
    
    // Check if user is logged in for MFA requirement
    {% if not session.get('logged_in') %}
    if (confirm('You must be logged in with verified email and phone to submit a quote request. Would you like to login now?')) {
        window.location.href = '{{ url_for("login") }}';
        return;
    } else {
        return;
    }
    {% endif %}
    
    // Prepare form data for submission
    const formData = new FormData(this);
    formData.append('family_seats', familySeats);
    formData.append('current_step', currentStep);
    
    // Submit the form with proper JSON content type
    const jsonData = {};
    for (let [key, value] of formData.entries()) {
        if (jsonData[key]) {
            if (Array.isArray(jsonData[key])) {
                jsonData[key].push(value);
            } else {
                jsonData[key] = [jsonData[key], value];
            }
        } else {
            jsonData[key] = value;
        }
    }
    jsonData.family_seats = familySeats;
    jsonData.current_step = currentStep;
    
    fetch('{{ url_for("intake_submit") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear saved data
            localStorage.removeItem('mediflyIntakeData');
            
            // Redirect to quotes page
            window.location.href = data.redirect_url;
        } else {
            alert(data.message || 'An error occurred. Please try again.');
        }
    })
    .catch(error => {
        console.error('Submission error:', error);
        alert('An error occurred while submitting your request. Please try again.');
    });
});

// Update validation on input changes
document.addEventListener('input', updateStepValidation);
document.addEventListener('change', updateStepValidation);

// Initialize family seat controls and hospital autofill
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('seatMinus').disabled = true;
    setupHospitalAutofill();
});

// Hospital autofill functionality  
function setupHospitalAutofill() {
    setupAutofill('fromHospital', 'fromHospitalSuggestions');
    setupAutofill('toHospital', 'toHospitalSuggestions');
}

function setupAutofill(inputId, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionsId);
    if (!input || !suggestions) return;
    
    let debounceTimer;

    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = this.value.trim();
            if (query.length < 2) {
                suggestions.classList.remove('show');
                return;
            }

            fetch(`/api/hospital-search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(hospitals => {
                    suggestions.innerHTML = '';
                    hospitals.forEach(hospital => {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.href = '#';
                        item.textContent = hospital;
                        item.onclick = (e) => {
                            e.preventDefault();
                            input.value = hospital;
                            suggestions.classList.remove('show');
                            saveFormData();
                        };
                        suggestions.appendChild(item);
                    });
                    
                    if (hospitals.length > 0) {
                        suggestions.classList.add('show');
                    } else {
                        suggestions.classList.remove('show');
                    }
                })
                .catch(error => {
                    console.error('Hospital search error:', error);
                    suggestions.classList.remove('show');
                });
        }, 300);
    });

    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.classList.remove('show');
        }
    });
}

function openTermsModal() {
    const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
    termsModal.show();
}

function openPrivacyModal() {
    const privacyModal = new bootstrap.Modal(document.getElementById('privacyModal'));
    privacyModal.show();
}
</script>

<!-- Terms of Service Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Terms of Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="alert alert-info">
                    <strong>Important:</strong> By using SkyCareLink services, you acknowledge that we are an information aggregation platform connecting patients with medical transport providers.
                </div>
                <h6>1. Service Description</h6>
                <p>SkyCareLink operates as an information aggregation and connection platform for medical air transport services. We do not own, operate, or control any aircraft or medical transport equipment. All transport services are provided by independent affiliate providers.</p>
                
                <h6>2. Limitation of Liability</h6>
                <p><strong>SkyCareLink disclaims all liability for:</strong></p>
                <ul>
                    <li>Medical outcomes, patient safety, or quality of care during transport</li>
                    <li>Aircraft safety, mechanical issues, or operational delays</li>
                    <li>Pricing adjustments, additional fees, or billing disputes with affiliates</li>
                    <li>Cancellations, delays, or changes to transport schedules</li>
                    <li>Any wrongdoing, negligence, or misconduct by affiliate providers</li>
                </ul>

                <h6>3. Cancellation and Refund Policy</h6>
                <p><strong>Patient Death or Medical Contraindication:</strong> In the unfortunate event of patient death before transport, refunds are handled directly by the affiliate provider.</p>
                <p><strong>Cancellation Timeframes:</strong></p>
                <ul>
                    <li><strong>24+ hours before transport:</strong> Full or partial refunds may be available</li>
                    <li><strong>Less than 24 hours:</strong> Most affiliates impose cancellation fees</li>
                    <li><strong>Day of transport:</strong> Significant cancellation penalties typically apply</li>
                </ul>
                <p><em>All refund requests must be submitted directly to the affiliate provider. SkyCareLink does not process refunds.</em></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="alert alert-warning">
                    <strong>HIPAA Notice:</strong> SkyCareLink operates as a business associate and maintains strict PHI protection standards.
                </div>
                <h6>1. Information We Collect</h6>
                <p><strong>Personal Information:</strong> Name, contact information, medical information necessary for transport coordination, payment and billing information, and location data for pick-up and delivery coordination.</p>
                
                <h6>2. How We Use Your Information</h6>
                <ul>
                    <li><strong>Transport Coordination:</strong> Connecting you with appropriate medical transport providers</li>
                    <li><strong>Communication:</strong> Updates on transport status, quotes, and service notifications</li>
                    <li><strong>Platform Improvement:</strong> Analytics to enhance user experience and service quality</li>
                    <li><strong>Legal Compliance:</strong> Meeting regulatory requirements and safety standards</li>
                </ul>

                <h6>3. Information Sharing</h6>
                <p><strong>With Affiliate Providers:</strong> We share necessary medical and contact information with selected transport providers to facilitate your transport request.</p>
                <p><strong>We Do NOT Share:</strong> Information with unauthorized third parties, marketing lists, medical information for non-transport purposes, or personal data for commercial gain.</p>

                <h6>4. Data Security</h6>
                <p>SkyCareLink implements industry-standard security measures including end-to-end encryption for all PHI transmission, multi-factor authentication, regular security audits, secure data storage, and HIPAA-compliant data handling procedures.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<!-- Anti-Abuse Deposit Modal -->
<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="depositModalLabel">Anti-Abuse Deposit Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>Fair Use Policy Triggered</strong>
                </div>
                <p id="depositMessage">
                    After 4 quote requests without booking, a $49 refundable deposit is required. 
                    This helps prevent system abuse and will be fully refunded after your first booking.
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="processDeposit()">
                        <i class="fas fa-credit-card me-2"></i>Pay $49 Deposit
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showDepositModal(data) {
    document.getElementById('depositModalLabel').textContent = data.deposit_modal_title || 'Anti-Abuse Deposit Required';
    document.getElementById('depositMessage').textContent = data.deposit_modal_body || 
        `A $${data.deposit_amount} refundable deposit is required to continue.`;
    
    const modal = new bootstrap.Modal(document.getElementById('depositModal'));
    modal.show();
}

function processDeposit() {
    // In a real implementation, this would integrate with a payment processor
    alert('Payment processing would be integrated here. For demo purposes, proceeding...');
    
    // Close the modal and proceed with submission
    bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
    
    // Set a flag to bypass the deposit check and resubmit
    sessionStorage.setItem('deposit_paid', 'true');
    
    // Add hidden field to form
    const form = document.getElementById('intakeForm');
    const hiddenField = document.createElement('input');
    hiddenField.type = 'hidden';
    hiddenField.name = 'deposit_paid';
    hiddenField.value = 'true';
    form.appendChild(hiddenField);
    
    // Resubmit form
    form.submit();
}
</script>

{% endblock %}
{% extends "consumer_base.html" %}

{% block title %}Medical Transport Request - SkyCareLink{% endblock %}

{% block content %}
<style>
/* Enhanced Pancake Stepper Styles */
.pancake-stack {
    max-width: 900px;
    margin: 0 auto;
}

.pancake-step {
    border: 1px solid #e3f2fd;
    border-radius: 4px;
    margin-bottom: 0.35rem;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.pancake-step.active {
    border-color: #1976d2;
    box-shadow: 0 4px 16px rgba(25,118,210,0.2);
}

.pancake-step.completed {
    border-color: #4caf50;
    background: #f8fff8;
}

.pancake-step.collapsed {
    border-color: #e0e0e0;
    background: #fafafa;
}

.pancake-header {
    padding: 0.4rem 0.6rem;
    cursor: pointer;
    border-bottom: 1px solid transparent;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.pancake-step.active .pancake-header {
    border-bottom-color: #e3f2fd;
    background: linear-gradient(135deg, #e3f2fd 0%, #f3f9ff 100%);
}

.pancake-step.completed .pancake-header {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
}

.pancake-step.collapsed .pancake-header {
    background: #f5f5f5;
}

.pancake-content {
    padding: 0;
    display: none;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    opacity: 0;
    max-height: 0;
}

.pancake-step.active .pancake-content {
    display: block;
    padding: 0.6rem;
    opacity: 1;
    max-height: 2000px;
}

.step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #1976d2;
    color: white;
    font-weight: bold;
    margin-right: 0.4rem;
    font-size: 0.75rem;
}

.pancake-step.completed .step-number {
    background: #4caf50;
}

.pancake-step.collapsed .step-number {
    background: #9e9e9e;
}

.pancake-icon {
    transition: transform 0.3s ease;
}

.pancake-step.active .pancake-icon {
    transform: rotate(180deg);
}

.service-card {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 0.3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    height: auto;
    min-height: 60px;
    font-size: 0.8rem;
}

.severity-card {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 0.3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    height: auto;
    min-height: 60px;
    font-size: 0.8rem;
}

.service-card:hover, .severity-card:hover {
    border-color: #1976d2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.service-card.selected, .severity-card.selected {
    border-color: #1976d2;
    background: #e3f2fd;
    transform: translateY(-2px);
}





.pancake-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding-top: 0.4rem;
    border-top: 1px solid #e0e0e0;
}

/* Compact Form Controls */
.pancake-content .form-control,
.pancake-content .form-select {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    height: calc(1.5em + 0.5rem + 2px);
}

.pancake-content .form-control-sm,
.pancake-content .form-select-sm {
    padding: 0.2rem 0.4rem;
    font-size: 0.8rem;
    height: calc(1.5em + 0.4rem + 2px);
}

.pancake-content textarea.form-control-sm {
    height: auto;
    min-height: calc(1.5em + 0.4rem + 2px);
}

.family-seat-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.5rem;
}

.seat-counter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.seat-btn {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 4px;
    background: #1976d2;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.seat-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.mfa-requirement {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 1rem;
    margin: 1rem 0;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.equipment-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Fixed 3-column layout for consistent ordering */
    gap: 0.5rem;
    margin: 1rem 0;
}

.equipment-item {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.equipment-item.compact-equipment {
    padding: 0.49rem; /* 35% smaller than 0.75rem */
    min-height: 60px; /* Uniform height, 35% smaller */
    max-height: 60px;
    display: flex;
    align-items: center;
}

.equipment-item.compact-equipment .form-check {
    width: 100%;
}

.equipment-item.compact-equipment .form-check-label {
    font-size: 0.75rem; /* Smaller text */
    line-height: 1.2;
}

.equipment-item.compact-equipment .equipment-description {
    font-size: 0.65rem; /* Even smaller description */
    margin-top: 0.15rem;
}

.equipment-item:hover {
    border-color: #1976d2;
    background: #f8f9fa;
}

.equipment-item.selected {
    border-color: #1976d2;
    background: #e3f2fd;
}

.equipment-description {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}

/* Button state improvements - Complete override */
.pancake-navigation .btn {
    position: relative !important;
    overflow: visible !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
}

/* Remove all prohibition icons and pseudo-elements - Nuclear option */
.pancake-navigation .btn::before,
.pancake-navigation .btn::after,
.pancake-navigation .btn *::before,
.pancake-navigation .btn *::after,
.pancake-navigation .btn i::before,
.pancake-navigation .btn i::after,
.pancake-navigation button::before,
.pancake-navigation button::after,
.pancake-navigation button *::before,
.pancake-navigation button *::after {
    content: none !important;
    display: none !important;
    visibility: hidden !important;
    background: none !important;
    background-image: none !important;
}

/* Remove Font Awesome ban/prohibition icons specifically */
.pancake-navigation .btn .fa-ban,
.pancake-navigation .btn .fa-times-circle,
.pancake-navigation .btn .fa-slash,
.pancake-navigation .btn .fa-prohibition {
    display: none !important;
}

/* Default button state - light teal/blue like service cards */
.pancake-navigation .btn {
    background-color: #b3e5fc !important; /* Light cyan/teal like your example */
    border-color: #81d4fa !important;
    color: #0277bd !important;
    opacity: 1 !important;
    cursor: default !important;
}

/* All Next buttons use btn-success class for consistent green styling */

/* Keep Back buttons with light blue styling */
.pancake-navigation .btn-outline-secondary {
    background-color: #e3f2fd !important;
    border-color: #90caf9 !important;
    color: #1976d2 !important;
}

.pancake-navigation .btn-outline-secondary:hover {
    background-color: #bbdefb !important;
    border-color: #64b5f6 !important;
    color: #0d47a1 !important;
}

/* Disabled state - gray until step is complete */
.pancake-navigation .btn:disabled {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: #fff !important;
    opacity: 0.6 !important;
    cursor: not-allowed !important;
}

/* Success buttons only show green when enabled (step complete) */
.pancake-navigation .btn-success:not(:disabled) {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
    color: #fff !important;
    font-weight: 600 !important;
}

.pancake-navigation .btn-success:not(:disabled):hover {
    background-color: #218838 !important;
    border-color: #1e7e34 !important;
}

/* Login expansion box styling */
.login-expansion-box {
    animation: slideDown 0.3s ease-out;
    margin-top: 1rem;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        max-height: 200px;
        transform: translateY(0);
    }
}

/* Equipment Compact Grid Styling */
.equipment-compact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 8px;
    margin: 0.5rem 0;
}

.equipment-compact-card {
    display: flex;
    align-items: flex-start;
    padding: 8px 10px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 50px;
}

.equipment-compact-card:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.equipment-compact-card.selected {
    background: #d1ecf1;
    border-color: #17a2b8;
    color: #0c5460;
}

.equipment-compact-card .form-check-input {
    margin-right: 8px;
    margin-top: 2px;
    flex-shrink: 0;
}

.equipment-compact-card .equipment-content {
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.equipment-compact-card .equipment-name {
    font-size: 13px;
    font-weight: 600;
    line-height: 1.2;
    margin-bottom: 2px;
}

.equipment-compact-card .equipment-description {
    font-size: 11px;
    color: #6c757d;
    line-height: 1.3;
}
</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">


                    <form id="intakeForm" method="POST" action="{{ url_for('intake_submit') }}" onsubmit="return handleIntakeSubmit(event)">
                        <div class="pancake-stack">
                            
                            <!-- Step 1: Service Type Selection -->
                            <div class="pancake-step active" id="step-1" data-step="1">
                                <div class="pancake-header" onclick="toggleStep(1)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">1</span>
                                            Service Type Selection
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <p class="text-muted mb-3">Select the type of medical transport service you need</p>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="service-card" data-service="critical" onclick="selectService('critical')">
                                                <div class="service-icon mb-2">
                                                    <i class="fas fa-exclamation-triangle text-danger fa-2x"></i>
                                                </div>
                                                <h6>Critical Transport</h6>
                                                <p class="small text-muted">Immediate, life-threatening situations</p>
                                                <span class="badge bg-danger">Urgent</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="service-card" data-service="non-critical" onclick="selectService('non-critical')">
                                                <div class="service-icon mb-2">
                                                    <i class="fas fa-calendar-alt text-primary fa-2x"></i>
                                                </div>
                                                <h6>Scheduled Transport</h6>
                                                <p class="small text-muted">Planned medical transfers</p>
                                                <span class="badge bg-primary">Standard rates</span>
                                            </div>
                                        </div>

                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <div></div>
                                        <button type="button" class="btn btn-secondary btn-sm" id="nextStep1" onclick="nextStep()" disabled>
                                            Next: Patient Severity <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Patient Severity Level -->
                            <div class="pancake-step" id="step-2" data-step="2">
                                <div class="pancake-header" onclick="toggleStep(2)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">2</span>
                                            Patient Severity Level
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <p class="text-muted mb-3">Select the patient's severity level for proper equipment matching</p>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="severity-card" data-severity="low" onclick="selectSeverity('low')">
                                                <div class="service-icon mb-2">
                                                    <i class="fas fa-user text-success fa-2x"></i>
                                                </div>
                                                <h6>Level 1 - Low</h6>
                                                <p class="small text-muted">Stable condition</p>
                                                <span class="badge bg-success">Standard</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="severity-card" data-severity="medium" onclick="selectSeverity('medium')">
                                                <div class="service-icon mb-2">
                                                    <i class="fas fa-heartbeat text-warning fa-2x"></i>
                                                </div>
                                                <h6>Level 2 - Medium</h6>
                                                <p class="small text-muted">Monitoring required</p>
                                                <span class="badge bg-warning">Enhanced</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="severity-card" data-severity="high" onclick="selectSeverity('high')">
                                                <div class="service-icon mb-2">
                                                    <i class="fas fa-ambulance text-danger fa-2x"></i>
                                                </div>
                                                <h6>Level 3 - High</h6>
                                                <p class="small text-muted">Critical condition</p>
                                                <span class="badge bg-danger">Life support</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Medical Equipment (compact grid) -->
                                    <div class="mb-2">
                                        <h6 class="small mb-2">Equipment <small class="text-muted">(auto-selected, click to customize)</small></h6>
                                        <div class="equipment-compact-grid" id="equipmentGrid">
                                            <!-- Equipment options will be populated as compact cards -->
                                        </div>
                                    </div>

                                    <!-- Specialized Care (compact) -->
                                    <div class="mb-2">
                                        <h6 class="small mb-1">Specialized Care <small class="text-muted">(optional)</small></h6>
                                        <div class="row g-1">
                                            <div class="col-3"><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="niche_markets" value="pediatric" id="nichePediatric"><label class="form-check-label small" for="nichePediatric">Pediatric</label></div></div>
                                            <div class="col-3"><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="niche_markets" value="nicu" id="nicheNicu"><label class="form-check-label small" for="nicheNicu">NICU</label></div></div>
                                            <div class="col-3"><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="niche_markets" value="cardiac" id="nicheCardiac"><label class="form-check-label small" for="nicheCardiac">Cardiac</label></div></div>
                                            <div class="col-3"><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" name="niche_markets" value="trauma" id="nicheTrauma"><label class="form-check-label small" for="nicheTrauma">Trauma</label></div></div>
                                        </div>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" id="nextStep2" onclick="nextStep()" disabled>
                                            Next: Locations <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Location Details -->
                            <div class="pancake-step" id="step-3" data-step="3">
                                <div class="pancake-header" onclick="toggleStep(3)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">3</span>
                                            Location Details
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <!-- Flight Details (compact row) -->
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label small">Flight Date <span class="text-danger">*</span></label>
                                            <input type="date" class="form-control form-control-sm compact-input" name="flight_date" id="flightDate" required min="">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Time Preference</label>
                                            <select class="form-select form-select-sm compact-input" name="preferred_time" id="preferredTime">
                                                <option value="">Any time</option>
                                                <option value="morning">Morning</option>
                                                <option value="afternoon">Afternoon</option>
                                                <option value="asap">ASAP</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Family Seats</label>
                                            <div class="seat-counter d-flex align-items-center">
                                                <button type="button" class="seat-btn btn btn-sm btn-outline-secondary" onclick="adjustFamilySeats(-1)" id="seatMinus">-</button>
                                                <span class="mx-2 fw-bold" id="familySeatsCount">0</span>
                                                <button type="button" class="seat-btn btn btn-sm btn-outline-secondary" onclick="adjustFamilySeats(1)" id="seatPlus">+</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Return Flight (compact) -->
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="return_flight" id="returnFlight" onchange="toggleReturnDate()">
                                                <label class="form-check-label small" for="returnFlight">Return flight needed</label>
                                            </div>
                                            <div id="returnDateContainer" style="display: none;" class="mt-1">
                                                <input type="date" class="form-control form-control-sm compact-input" name="return_date" id="returnDate">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Locations (compact) -->
                                    <div class="row g-2">
                                        <!-- From Location -->
                                        <div class="col-md-6">
                                            <h6 class="text-primary small mb-1">From Location</h6>
                                            <div class="mb-1">
                                                <input type="text" class="form-control form-control-sm compact-input" name="from_hospital" id="fromHospital" placeholder="Hospital/Facility (optional)" autocomplete="off">
                                            </div>
                                            <div class="row g-1">
                                                <div class="col-5">
                                                    <input type="text" class="form-control form-control-sm compact-input" name="from_city" id="fromCity" placeholder="City*" required>
                                                </div>
                                                <div class="col-3">
                                                    <select class="form-select form-select-sm compact-input" name="from_state" id="fromState" required>
                                                        <option value="">State</option>
                                                    </select>
                                                </div>
                                                <div class="col-4">
                                                    <select class="form-select form-select-sm compact-input" name="from_country" id="fromCountry">
                                                        <option value="">Country</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- To Location -->
                                        <div class="col-md-6">
                                            <h6 class="text-success small mb-1">To Location</h6>
                                            <div class="mb-1">
                                                <input type="text" class="form-control form-control-sm compact-input" name="to_hospital" id="toHospital" placeholder="Hospital/Facility (optional)" autocomplete="off">
                                            </div>
                                            <div class="row g-1">
                                                <div class="col-5">
                                                    <input type="text" class="form-control form-control-sm compact-input" name="to_city" id="toCity" placeholder="City*" required>
                                                </div>
                                                <div class="col-3">
                                                    <select class="form-select form-select-sm compact-input" name="to_state" id="toState" required>
                                                        <option value="">State</option>
                                                    </select>
                                                </div>
                                                <div class="col-4">
                                                    <select class="form-select form-select-sm compact-input" name="to_country" id="toCountry">
                                                        <option value="">Country</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" id="nextStep3" onclick="nextStep()" disabled>
                                            Next: Patient Info <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Patient Information -->
                            <div class="pancake-step" id="step-4" data-step="4">
                                <div class="pancake-header" onclick="toggleStep(4)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">4</span>
                                            Patient Information
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <div class="row g-2">
                                        <!-- Contact Name - Required -->
                                        <div class="col-md-6">
                                            <label class="form-label small">Contact Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control form-control-sm compact-input" name="contact_name" id="contactName" 
                                                   placeholder="Primary contact name" required>
                                        </div>
                                        <!-- Relation to Patient - Optional -->
                                        <div class="col-md-6">
                                            <label class="form-label small">Relation to Patient <small class="text-muted">(Optional)</small></label>
                                            <input type="text" class="form-control form-control-sm compact-input" name="relation_to_patient" id="relationToPatient" 
                                                   placeholder="e.g., Mother, Father, Guardian">
                                        </div>

                                        <!-- Age, Weight, Gender on same row -->
                                        <div class="col-md-4">
                                            <label class="form-label small">Age Range <small class="text-muted">(Optional)</small></label>
                                            <select class="form-select form-select-sm compact-input" name="patient_age_range" id="patientAgeRange">
                                                <option value="">Select age range</option>
                                                <option value="newborn">Newborn (0-1 month)</option>
                                                <option value="infant">Infant (1-12 months)</option>
                                                <option value="toddler">Toddler (1-3 years)</option>
                                                <option value="child">Child (4-12 years)</option>
                                                <option value="teen">Teen (13-17 years)</option>
                                                <option value="adult">Adult (18-64 years)</option>
                                                <option value="senior">Senior (65+ years)</option>
                                            </select>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small">Weight Range <small class="text-muted">(Optional)</small></label>
                                            <select class="form-select form-select-sm compact-input" name="patient_weight" id="patientWeight">
                                                <option value="">Select weight range</option>
                                                <option value="under-50">Under 50 lbs</option>
                                                <option value="50-100">50-100 lbs</option>
                                                <option value="100-150">100-150 lbs</option>
                                                <option value="150-200">150-200 lbs</option>
                                                <option value="200-250">200-250 lbs</option>
                                                <option value="250-300">250-300 lbs</option>
                                                <option value="over-300">Over 300 lbs</option>
                                            </select>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label small">Gender <small class="text-muted">(Optional)</small></label>
                                            <select class="form-select form-select-sm compact-input" name="patient_gender" id="patientGender">
                                                <option value="">Select gender</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="unknown">Unknown</option>
                                            </select>
                                        </div>

                                        <!-- COVID Testing -->
                                        <div class="col-md-6 mt-3">
                                            <label class="form-label small">COVID Tested? <small class="text-muted">(Optional)</small></label>
                                            <select class="form-select form-select-sm compact-input" name="covid_tested" id="covidTested" onchange="toggleCovidResult()">
                                                <option value="">Select option</option>
                                                <option value="yes">Yes</option>
                                                <option value="no">No</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6 mt-3">
                                            <div id="covidResultContainer" style="display: none;">
                                                <label class="form-label small">COVID Test Result <small class="text-muted">(Optional)</small></label>
                                                <select class="form-select form-select-sm compact-input" name="covid_result" id="covidResult">
                                                    <option value="">Select result</option>
                                                    <option value="n/a">N/A</option>
                                                    <option value="negative">Negative</option>
                                                    <option value="positive">Positive</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Additional Information -->
                                    <div class="mt-3">
                                        <label class="form-label small">
                                            Additional Medical Information
                                            <small class="text-muted">(No PII/PHI - Personally Identifiable Information / Protected Health Information)</small>
                                        </label>
                                        <textarea class="form-control form-control-sm compact-input" name="additional_info" id="additionalInfo" rows="2" 
                                                  placeholder="Brief description of medical needs, special requirements, or concerns (avoid patient names, dates of birth, SSN, etc.)"></textarea>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" id="nextStep4" onclick="nextStep()" disabled>
                                            Next: Review & Submit <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 5: Review and Submit -->
                            <div class="pancake-step" id="step-5" data-step="5">
                                <div class="pancake-header" onclick="toggleStep(5)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="step-number">5</span>
                                            Review & Submit
                                            <span class="completion-status ms-2"></span>
                                        </h5>
                                        <i class="fas fa-chevron-down pancake-icon"></i>
                                    </div>
                                </div>
                                <div class="pancake-content">
                                    <div id="reviewSummary">
                                        <!-- Review content will be populated dynamically -->
                                    </div>

                                    <!-- Disclaimers -->
                                    <div class="alert alert-warning mt-4">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Disclaimers</h6>
                                        <ul class="mb-0 small">
                                            <li>All quotes are estimates and final pricing may vary based on actual requirements</li>
                                            <li>Family seating is subject to aircraft availability and weight limitations</li>
                                            <li>Medical equipment availability confirmed at time of booking</li>
                                            <li>Same-day transport subject to provider availability and weather conditions</li>
                                            <li>Excessive quote requests (4+) incur a $99 processing fee</li>
                                        </ul>
                                    </div>

                                    <!-- Terms Agreement -->
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                        <label class="form-check-label" for="agreeTerms">
                                            I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>
                                        </label>
                                    </div>
                                    
                                    <!-- Login Expansion Box (hidden by default) -->
                                    <div id="loginExpansionBox" class="login-expansion-box" style="display: none;">
                                        <div class="alert alert-info mt-3">
                                            <h6><i class="fas fa-shield-alt me-2"></i>Account Required to Submit</h6>
                                            <p class="mb-3">To submit your quote request, please login now or create an account quickly:</p>
                                            <div class="d-flex gap-2 mb-2">
                                                <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-sign-in-alt me-2"></i>Login Now
                                                </a>
                                                <a href="{{ url_for('login') }}?join=1" class="btn btn-success btn-sm">
                                                    <i class="fas fa-user-plus me-2"></i>+Join
                                                </a>
                                            </div>
                                            <small class="text-muted">
                                                Your progress will be saved automatically. Takes less than 2 minutes.
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="pancake-navigation">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="prevStep()">
                                            <i class="fas fa-arrow-left me-2"></i>Back
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm" id="submitRequest" onclick="handleSubmitClick()" disabled>
                                            <i class="fas fa-paper-plane me-2"></i>Submit Quote Request
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>
                    
                    <!-- MFA Requirement Notice - Moved to bottom -->
                    {% if not session.get('logged_in') %}
                    <div class="mfa-requirement mt-4">
                        <h6><i class="fas fa-shield-alt me-2"></i>Security Requirements</h6>
                        <p class="mb-2">To submit a quote request, you must:</p>
                        <ul class="mb-2">
                            <li>Create a verified account with email and phone confirmation</li>
                            <li>Complete multi-factor authentication (MFA)</li>
                            <li>Agree to $99 fee for excessive quote requests (4+ quotes)</li>
                        </ul>
                        <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">Login/Register Now</a>
                        <span class="text-muted ms-2">or continue to save your progress</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Show login expansion box instead of popup
function showLoginExpansionBox() {
    const expansionBox = document.getElementById('loginExpansionBox');
    if (expansionBox) {
        expansionBox.style.display = 'block';
        expansionBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Handle submit button click - check if user is logged in
function handleSubmitClick() {
    const isLoggedIn = {{ 'true' if session.get('logged_in') else 'false' }};
    
    if (!isLoggedIn) {
        // Show login expansion box
        showLoginExpansionBox();
        return false;
    } else {
        // User is logged in, proceed with form submission
        const form = document.getElementById('intakeForm');
        if (form) {
            form.submit();
        }
    }
}

// Enhanced Pancake Stepper JavaScript
let currentStep = 1;
let formData = {};
let familySeats = 0;

// US States data
const US_STATES = [
    'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
    'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
    'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
    'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
    'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
];

// Countries list (major countries for international transport)
const COUNTRIES = [
    'USA', 'Canada', 'Mexico', 'United Kingdom', 'Germany', 'France', 
    'Italy', 'Spain', 'Netherlands', 'Belgium', 'Switzerland', 'Austria',
    'Denmark', 'Sweden', 'Norway', 'Australia', 'New Zealand', 'Japan',
    'South Korea', 'Singapore', 'Brazil', 'Argentina', 'Chile', 'Colombia'
];





// Medical equipment data - ordered for specific layout
const MEDICAL_EQUIPMENT = {
    advanced: [
        // Line 1: Oxygen supply, Cardiac Monitor, Stretcher
        { id: 'oxygen', name: 'Oxygen Supply', description: 'Basic oxygen therapy for respiratory support', cost: 0 },
        { id: 'cardiac_monitor', name: 'Cardiac Monitor', description: 'Advanced heart rhythm and vital signs monitoring', cost: 0 },
        { id: 'stretcher', name: 'Medical Stretcher', description: 'Standard patient transport stretcher', cost: 0 },
        // Line 2: IV Pump, Defibrillator, Balloon Pump, ECMO, Suction
        { id: 'iv_pump', name: 'IV Pump', description: 'Intravenous medication delivery system', cost: 0 },
        { id: 'defibrillator', name: 'Defibrillator', description: 'Emergency cardiac rhythm correction device', cost: 0 },
        { id: 'balloon_pump', name: 'Balloon Pump', description: 'Intra-aortic balloon pump for cardiac support', cost: 0 },
        { id: 'ecmo', name: 'ECMO', description: 'Extracorporeal membrane oxygenation for critical life support', cost: 0 },
        { id: 'suction', name: 'Suction Unit', description: 'Airway clearance and secretion management', cost: 0 },
        // Line 3: Remaining equipment
        { id: 'ventilator', name: 'Advanced Ventilator', description: 'Full mechanical ventilation with multiple modes', cost: 0 },
        { id: 'incubator', name: 'Transport Incubator', description: 'Neonatal intensive care transport unit', cost: 0 }
    ]
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    populateStates();
    // Remove auto-restore that was causing unwanted auto-selection
    // restoreFormData(); // Disabled to prevent auto-selection
    updateStepValidation();
    
    // Auto-save form data on input changes
    document.getElementById('intakeForm').addEventListener('input', saveFormData);
    document.getElementById('intakeForm').addEventListener('change', saveFormData);
    
    console.log('Enhanced SkyCareLink Pancake Stepper Loaded');
    
    // Setup form validation
    setupFormValidation();
});

// Setup form validation (prevents JavaScript errors)
function setupFormValidation() {
    // Basic form validation setup is handled by updateStepValidation
    console.log('Form validation setup complete');
}

// Enable next button (helper function to prevent errors)
function enableNextButton(stepNumber) {
    const nextButton = document.getElementById(`nextStep${stepNumber}`);
    if (nextButton) {
        nextButton.disabled = false;
    }
}

// Populate state dropdowns
function populateStates() {
    const fromState = document.getElementById('fromState');
    const toState = document.getElementById('toState');
    
    US_STATES.forEach(state => {
        fromState.innerHTML += `<option value="${state}">${state}</option>`;
        toState.innerHTML += `<option value="${state}">${state}</option>`;
    });
    
    // Populate countries with international options
    populateCountries('fromCountry');
    populateCountries('toCountry');
}

// Populate countries dropdown with international options
function populateCountries(countryElementId) {
    const countrySelect = document.getElementById(countryElementId);
    
    if (!countrySelect) return;
    
    // Add countries with USA as default selected
    COUNTRIES.forEach((country, index) => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        if (country === 'USA') {
            option.selected = true;
        }
        countrySelect.appendChild(option);
    });
}

// Service selection
function selectService(serviceType) {
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    document.querySelector(`[data-service="${serviceType}"]`).classList.add('selected');
    formData.serviceType = serviceType;
    
    console.log('Service selected:', serviceType);
    updateStepValidation();
    saveFormData();
}

// Severity selection
function selectSeverity(severity) {
    document.querySelectorAll('.severity-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    document.querySelector(`[data-severity="${severity}"]`).classList.add('selected');
    formData.severity = severity;
    
    // Populate equipment options for this severity
    populateEquipment(severity);
    
    updateStepValidation();
    saveFormData();
}

// Populate equipment based on severity
function populateEquipment(severity) {
    const equipmentGrid = document.getElementById('equipmentGrid');
    
    // Always show all equipment options from advanced (Level 3) list
    const allEquipmentList = MEDICAL_EQUIPMENT.advanced;
    
    // Define default selections for each severity level
    const defaultSelections = {
        'low': ['oxygen'], // Level 1
        'medium': ['oxygen', 'stretcher', 'cardiac_monitor', 'iv_pump'], // Level 2  
        'high': ['oxygen', 'stretcher', 'cardiac_monitor', 'iv_pump', 'defibrillator'] // Level 3
    };
    
    equipmentGrid.innerHTML = '';
    
    allEquipmentList.forEach(equipment => {
        const equipmentCard = document.createElement('div');
        equipmentCard.className = 'equipment-compact-card';
        equipmentCard.setAttribute('data-equipment', equipment.id);
        equipmentCard.onclick = () => toggleEquipment(equipment.id);
        
        equipmentCard.innerHTML = `
            <input class="form-check-input" type="checkbox" id="eq_${equipment.id}" name="equipment" value="${equipment.id}">
            <div class="equipment-content">
                <div class="equipment-name">${equipment.name}</div>
                <div class="equipment-description">${equipment.description}</div>
            </div>
        `;
        
        equipmentGrid.appendChild(equipmentCard);
    });
    
    // Auto-select recommended equipment based on severity level (but allow user to modify)
    const defaults = defaultSelections[severity] || [];
    defaults.forEach(eqId => {
        const checkbox = document.getElementById(`eq_${eqId}`);
        if (checkbox) {
            checkbox.checked = true;
            document.querySelector(`[data-equipment="${eqId}"]`).classList.add('selected');
        }
    });
}

// Toggle equipment selection
function toggleEquipment(equipmentId) {
    const checkbox = document.getElementById(`eq_${equipmentId}`);
    const item = document.querySelector(`[data-equipment="${equipmentId}"]`);
    
    checkbox.checked = !checkbox.checked;
    
    if (checkbox.checked) {
        item.classList.add('selected');
    } else {
        item.classList.remove('selected');
    }
    
    saveFormData();
}

// Family seats adjustment
function adjustFamilySeats(change) {
    const newCount = familySeats + change;
    
    if (newCount >= 0 && newCount <= 3) {
        familySeats = newCount;
        document.getElementById('familySeatsCount').textContent = familySeats;
        formData.familySeats = familySeats;
        
        // Update button states
        document.getElementById('seatMinus').disabled = familySeats === 0;
        document.getElementById('seatPlus').disabled = familySeats === 3;
        
        saveFormData();
    }
}

// Toggle return date field
function toggleReturnDate() {
    const returnFlightCheckbox = document.getElementById('returnFlight');
    const returnDateContainer = document.getElementById('returnDateContainer');
    const returnDateField = document.getElementById('returnDate');
    
    if (returnFlightCheckbox.checked) {
        returnDateContainer.style.display = 'block';
        
        // Set minimum date to today for return date
        const today = new Date().toISOString().split('T')[0];
        returnDateField.setAttribute('min', today);
        
        // Also ensure return date is not before flight date
        const flightDate = document.getElementById('flightDate').value;
        if (flightDate && flightDate > today) {
            returnDateField.setAttribute('min', flightDate);
        }
    } else {
        returnDateContainer.style.display = 'none';
        // Clear the return date value when unchecked
        returnDateField.value = '';
    }
    
    saveFormData();
}

// Toggle COVID test result field
function toggleCovidResult() {
    const covidTested = document.getElementById('covidTested');
    const covidResultContainer = document.getElementById('covidResultContainer');
    
    if (covidTested.value === 'yes') {
        covidResultContainer.style.display = 'block';
    } else {
        covidResultContainer.style.display = 'none';
        // Clear the result value when not tested
        document.getElementById('covidResult').value = '';
    }
    
    saveFormData();
}

// Step navigation
function nextStep() {
    if (currentStep < 5 && validateCurrentStep()) {
        // Mark current step as completed
        const currentStepElement = document.getElementById(`step-${currentStep}`);
        currentStepElement.classList.remove('active');
        currentStepElement.classList.add('completed');
        
        // Move to next step
        currentStep++;
        const nextStepElement = document.getElementById(`step-${currentStep}`);
        nextStepElement.classList.add('active');
        
        // Scroll to new step
        nextStepElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        updateStepValidation();
        saveFormData();
    }
}

function prevStep() {
    if (currentStep > 1) {
        // Mark current step as inactive
        const currentStepElement = document.getElementById(`step-${currentStep}`);
        currentStepElement.classList.remove('active');
        
        // Move to previous step
        currentStep--;
        const prevStepElement = document.getElementById(`step-${currentStep}`);
        prevStepElement.classList.remove('completed');
        prevStepElement.classList.add('active');
        
        // Scroll to previous step
        prevStepElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        updateStepValidation();
    }
}

// Toggle step (for manual navigation)
function toggleStep(stepNumber) {
    if (stepNumber <= currentStep || isStepCompleted(stepNumber - 1)) {
        // Allow navigation to current step or completed previous steps
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        
        currentStep = stepNumber;
        const targetStep = document.getElementById(`step-${currentStep}`);
        targetStep.classList.add('active');
        targetStep.classList.remove('completed');
        
        updateStepValidation();
    }
}

// Validate a specific step
function validateStep(stepNumber) {
    switch(stepNumber) {
        case 1:
            return formData.serviceType;
        case 2:
            return formData.severity;
        case 3:
            return document.getElementById('flightDate').value &&
                   document.getElementById('fromCity').value &&
                   document.getElementById('fromState').value &&
                   document.getElementById('toCity').value &&
                   document.getElementById('toState').value;
        case 4:
            return document.getElementById('contactName').value; // Only contact name is required now
        case 5:
            return document.getElementById('agreeTerms') && document.getElementById('agreeTerms').checked;
        default:
            return true;
    }
}

// Validate current step
function validateCurrentStep() {
    return validateStep(currentStep);
}

// Update step validation and button states
function updateStepValidation() {
    console.log('Updating step validation, current formData:', formData);
    
    // Update next buttons for all steps
    for (let i = 1; i <= 4; i++) {
        const nextButton = document.getElementById(`nextStep${i}`);
        if (nextButton) {
            const isValid = validateStep(i);
            nextButton.disabled = !isValid;
            
            console.log(`Step ${i} validation:`, isValid);
            
            // Visual feedback - buttons turn green when enabled, gray when disabled
            if (isValid) {
                nextButton.classList.remove('btn-secondary');
                nextButton.classList.add('btn-success');
                nextButton.removeAttribute('disabled');
            } else {
                nextButton.classList.remove('btn-success');
                nextButton.classList.add('btn-secondary');
                nextButton.setAttribute('disabled', 'true');
            }
        }
    }
    
    // Update submit button
    const submitButton = document.getElementById('submitRequest');
    if (submitButton && currentStep === 5) {
        submitButton.disabled = !validateCurrentStep();
    }
    
    // Update step completion indicators
    updateStepIndicators();
}

// Update step visual indicators
function updateStepIndicators() {
    for (let i = 1; i <= 5; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        const completionStatus = stepElement.querySelector('.completion-status');
        
        if (i < currentStep) {
            completionStatus.innerHTML = '<i class="fas fa-check text-success"></i>';
        } else if (i === currentStep) {
            completionStatus.innerHTML = '<i class="fas fa-edit text-primary"></i>';
        } else {
            completionStatus.innerHTML = '';
        }
    }
}

// Check if step is completed
function isStepCompleted(stepNumber) {
    return stepNumber < currentStep;
}

// Save form data to localStorage
function saveFormData() {
    try {
        // Collect current form values
        const form = document.getElementById('intakeForm');
        const formDataNew = new FormData(form);
        
        // Convert to object
        const dataObject = {};
        for (let [key, value] of formDataNew.entries()) {
            if (dataObject[key]) {
                // Handle multiple values (like checkboxes)
                if (Array.isArray(dataObject[key])) {
                    dataObject[key].push(value);
                } else {
                    dataObject[key] = [dataObject[key], value];
                }
            } else {
                dataObject[key] = value;
            }
        }
        
        // Add non-form data
        dataObject.currentStep = currentStep;
        dataObject.familySeats = familySeats;
        dataObject.serviceType = formData.serviceType;
        dataObject.severity = formData.severity;
        
        localStorage.setItem('mediflyIntakeData', JSON.stringify(dataObject));
        console.log('Form data saved to localStorage');
    } catch (error) {
        console.error('Error saving form data:', error);
    }
}

// Restore form data from localStorage
function restoreFormData() {
    try {
        const savedData = localStorage.getItem('mediflyIntakeData');
        if (savedData) {
            const dataObject = JSON.parse(savedData);
            
            // Restore form values
            Object.entries(dataObject).forEach(([key, value]) => {
                const element = document.querySelector(`[name="${key}"]`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = Array.isArray(value) ? value.includes(element.value) : value === element.value;
                    } else {
                        element.value = value;
                    }
                }
            });
            
            // Restore special data
            if (dataObject.familySeats) {
                familySeats = parseInt(dataObject.familySeats);
                document.getElementById('familySeatsCount').textContent = familySeats;
            }
            
            if (dataObject.serviceType) {
                formData.serviceType = dataObject.serviceType;
                const serviceCard = document.querySelector(`[data-service="${dataObject.serviceType}"]`);
                if (serviceCard) serviceCard.classList.add('selected');
            }
            
            if (dataObject.severity) {
                formData.severity = dataObject.severity;
                const severityCard = document.querySelector(`[data-severity="${dataObject.severity}"]`);
                if (severityCard) severityCard.classList.add('selected');
                populateEquipment(dataObject.severity);
            }
            
            console.log('Form data restored from localStorage');
        }
    } catch (error) {
        console.error('Error restoring form data:', error);
    }
}

// Form submission
document.getElementById('intakeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateCurrentStep()) {
        alert('Please complete all required fields before submitting.');
        return;
    }
    
    // Check if user is logged in for MFA requirement
    {% if not session.get('logged_in') %}
    // Show login expansion box instead of popup
    showLoginExpansionBox();
    return;
    {% endif %}
    
    // Prepare form data for submission
    const formData = new FormData(this);
    formData.append('family_seats', familySeats);
    formData.append('current_step', currentStep);
    
    // Submit the form with proper JSON content type
    const jsonData = {};
    for (let [key, value] of formData.entries()) {
        if (jsonData[key]) {
            if (Array.isArray(jsonData[key])) {
                jsonData[key].push(value);
            } else {
                jsonData[key] = [jsonData[key], value];
            }
        } else {
            jsonData[key] = value;
        }
    }
    jsonData.family_seats = familySeats;
    jsonData.current_step = currentStep;
    
    fetch('{{ url_for("intake_submit") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear saved data
            localStorage.removeItem('mediflyIntakeData');
            
            // Redirect to quotes page
            window.location.href = data.redirect_url;
        } else {
            alert(data.message || 'An error occurred. Please try again.');
        }
    })
    .catch(error => {
        console.error('Submission error:', error);
        alert('An error occurred while submitting your request. Please try again.');
    });
});

// Update validation on input changes
document.addEventListener('input', updateStepValidation);
document.addEventListener('change', updateStepValidation);

// Initialize family seat controls and hospital autofill
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('seatMinus').disabled = true;
    setupHospitalAutofill();
    
    // Set minimum date to today for both flight date fields
    const today = new Date().toISOString().split('T')[0];
    const flightDateField = document.getElementById('flightDate');
    const returnDateField = document.getElementById('returnDate');
    
    if (flightDateField) {
        flightDateField.setAttribute('min', today);
    }
    if (returnDateField) {
        returnDateField.setAttribute('min', today);
    }
    
    // Add listener to update return date minimum when flight date changes
    if (flightDateField) {
        flightDateField.addEventListener('change', function() {
            const returnDateField = document.getElementById('returnDate');
            const returnFlightCheckbox = document.getElementById('returnFlight');
            
            if (returnDateField && returnFlightCheckbox && returnFlightCheckbox.checked) {
                const flightDate = this.value;
                const today = new Date().toISOString().split('T')[0];
                
                // Set minimum to whichever is later: today or flight date
                const minDate = flightDate > today ? flightDate : today;
                returnDateField.setAttribute('min', minDate);
                
                // Clear return date if it's now invalid
                if (returnDateField.value && returnDateField.value < minDate) {
                    returnDateField.value = '';
                }
            }
        });
    }
});

// Hospital autofill functionality  
function setupHospitalAutofill() {
    setupAutofill('fromHospital', 'fromHospitalSuggestions');
    setupAutofill('toHospital', 'toHospitalSuggestions');
}

function setupAutofill(inputId, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionsId);
    if (!input || !suggestions) return;
    
    let debounceTimer;

    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const query = this.value.trim();
            if (query.length < 2) {
                suggestions.classList.remove('show');
                return;
            }

            fetch(`/api/hospital-search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(hospitals => {
                    suggestions.innerHTML = '';
                    hospitals.forEach(hospital => {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.href = '#';
                        item.textContent = hospital;
                        item.onclick = (e) => {
                            e.preventDefault();
                            input.value = hospital;
                            suggestions.classList.remove('show');
                            saveFormData();
                        };
                        suggestions.appendChild(item);
                    });
                    
                    if (hospitals.length > 0) {
                        suggestions.classList.add('show');
                    } else {
                        suggestions.classList.remove('show');
                    }
                })
                .catch(error => {
                    console.error('Hospital search error:', error);
                    suggestions.classList.remove('show');
                });
        }, 300);
    });

    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.classList.remove('show');
        }
    });
}

function openTermsModal() {
    const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
    termsModal.show();
}

function openPrivacyModal() {
    const privacyModal = new bootstrap.Modal(document.getElementById('privacyModal'));
    privacyModal.show();
}
</script>

<!-- Terms of Service Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Terms of Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="alert alert-info">
                    <strong>Important:</strong> By using SkyCareLink services, you acknowledge that we are an information aggregation platform connecting patients with medical transport providers.
                </div>
                <h6>1. Service Description</h6>
                <p>SkyCareLink operates as an information aggregation and connection platform for medical air transport services. We do not own, operate, or control any aircraft or medical transport equipment. All transport services are provided by independent affiliate providers.</p>
                
                <h6>2. Limitation of Liability</h6>
                <p><strong>SkyCareLink disclaims all liability for:</strong></p>
                <ul>
                    <li>Medical outcomes, patient safety, or quality of care during transport</li>
                    <li>Aircraft safety, mechanical issues, or operational delays</li>
                    <li>Pricing adjustments, additional fees, or billing disputes with affiliates</li>
                    <li>Cancellations, delays, or changes to transport schedules</li>
                    <li>Any wrongdoing, negligence, or misconduct by affiliate providers</li>
                </ul>

                <h6>3. Cancellation and Refund Policy</h6>
                <p><strong>Patient Death or Medical Contraindication:</strong> In the unfortunate event of patient death before transport, refunds are handled directly by the affiliate provider.</p>
                <p><strong>Cancellation Timeframes:</strong></p>
                <ul>
                    <li><strong>24+ hours before transport:</strong> Full or partial refunds may be available</li>
                    <li><strong>Less than 24 hours:</strong> Most affiliates impose cancellation fees</li>
                    <li><strong>Day of transport:</strong> Significant cancellation penalties typically apply</li>
                </ul>
                <p><em>All refund requests must be submitted directly to the affiliate provider. SkyCareLink does not process refunds.</em></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="alert alert-warning">
                    <strong>HIPAA Notice:</strong> SkyCareLink operates as a business associate and maintains strict PHI protection standards.
                </div>
                <h6>1. Information We Collect</h6>
                <p><strong>Personal Information:</strong> Name, contact information, medical information necessary for transport coordination, payment and billing information, and location data for pick-up and delivery coordination.</p>
                
                <h6>2. How We Use Your Information</h6>
                <ul>
                    <li><strong>Transport Coordination:</strong> Connecting you with appropriate medical transport providers</li>
                    <li><strong>Communication:</strong> Updates on transport status, quotes, and service notifications</li>
                    <li><strong>Platform Improvement:</strong> Analytics to enhance user experience and service quality</li>
                    <li><strong>Legal Compliance:</strong> Meeting regulatory requirements and safety standards</li>
                </ul>

                <h6>3. Information Sharing</h6>
                <p><strong>With Affiliate Providers:</strong> We share necessary medical and contact information with selected transport providers to facilitate your transport request.</p>
                <p><strong>We Do NOT Share:</strong> Information with unauthorized third parties, marketing lists, medical information for non-transport purposes, or personal data for commercial gain.</p>

                <h6>4. Data Security</h6>
                <p>SkyCareLink implements industry-standard security measures including end-to-end encryption for all PHI transmission, multi-factor authentication, regular security audits, secure data storage, and HIPAA-compliant data handling procedures.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<!-- Anti-Abuse Deposit Modal -->
<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="depositModalLabel">Anti-Abuse Deposit Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>Fair Use Policy Triggered</strong>
                </div>
                <p id="depositMessage">
                    After 4 quote requests without booking, a $49 refundable deposit is required. 
                    This helps prevent system abuse and will be fully refunded after your first booking.
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="processDeposit()">
                        <i class="fas fa-credit-card me-2"></i>Pay $49 Deposit
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showDepositModal(data) {
    document.getElementById('depositModalLabel').textContent = data.deposit_modal_title || 'Anti-Abuse Deposit Required';
    document.getElementById('depositMessage').textContent = data.deposit_modal_body || 
        `A $${data.deposit_amount} refundable deposit is required to continue.`;
    
    const modal = new bootstrap.Modal(document.getElementById('depositModal'));
    modal.show();
}

function processDeposit() {
    // In a real implementation, this would integrate with a payment processor
    alert('Payment processing would be integrated here. For demo purposes, proceeding...');
    
    // Close the modal and proceed with submission
    bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
    
    // Set a flag to bypass the deposit check and resubmit
    sessionStorage.setItem('deposit_paid', 'true');
    
    // Add hidden field to form
    const form = document.getElementById('intakeForm');
    const hiddenField = document.createElement('input');
    hiddenField.type = 'hidden';
    hiddenField.name = 'deposit_paid';
    hiddenField.value = 'true';
    form.appendChild(hiddenField);
    
    // Resubmit form
    form.submit();
}
</script>

{% endblock %}
{% extends "consumer_base.html" %}

{% block title %}Portal Dashboard Views - SkyCareLink{% endblock %}

{% block head %}
<style>
/* Portal View Switcher */
.view-switcher {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    text-align: center;
}

.view-selector {
    display: inline-flex;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 0.5rem;
    margin: 1rem 0;
}

.view-option {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
}

.view-option.active {
    background: var(--primary-blue);
    color: white;
    box-shadow: 0 2px 10px rgba(25, 118, 210, 0.3);
}

/* Dashboard Cards */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.metric-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    text-align: center;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.metric-change {
    font-size: 0.9rem;
    font-weight: 600;
}

.expandable-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.expandable-card.collapsed .metric-details {
    display: none;
}

.expandable-card .expand-icon {
    transition: transform 0.3s ease;
}

.expandable-card:not(.collapsed) .expand-icon {
    transform: rotate(180deg);
}

.metric-details {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.date-filter-bar {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.analytics-section {
    margin-bottom: 3rem;
}

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.metric-change {
    font-size: 0.9rem;
    font-weight: 600;
}

.metric-change.positive { color: var(--success-green); }
.metric-change.negative { color: var(--accent-red); }

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

/* Pancake-style expandable rows */
.pancake-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.pancake-row {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.pancake-row:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.pancake-header {
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transition: background 0.2s ease;
}

.pancake-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.pancake-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.8);
    margin-right: 1rem;
    font-size: 1.5rem;
}

.pancake-chevron {
    transition: transform 0.3s ease;
    color: #6c757d;
}

.pancake-row.expanded .pancake-chevron {
    transform: rotate(180deg);
}

.pancake-content {
    padding: 0 1.5rem 1.5rem 1.5rem;
    display: none;
    background: white;
}

.pancake-row.expanded .pancake-content {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.metric-summary {
    text-align: center;
    min-width: 80px;
}

.stat-box {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    height: 100%;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.2;
}

.stat-sublabel {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.stat-breakdown {
    font-size: 0.875rem;
}

.stat-breakdown > div {
    padding: 0.25rem 0;
    border-bottom: 1px solid #e9ecef;
}

.stat-breakdown > div:last-child {
    border-bottom: none;
}

/* Role-specific styling for pancakes */
.provider-view .pancake-row { border-left: 4px solid #28a745; }
.hospital-view .pancake-row { border-left: 4px solid #dc3545; }
.individual-view .pancake-row { border-left: 4px solid #6f42c1; }
.admin-view .pancake-row { border-left: 4px solid #fd7e14; }

.role-header {
    text-align: center;
    padding: 2rem 0;
    border-radius: 15px;
    margin-bottom: 2rem;
    color: white;
}

.provider-header { background: linear-gradient(135deg, #28a745, #20c997); }
.hospital-header { background: linear-gradient(135deg, #dc3545, #e83e8c); }
.individual-header { background: linear-gradient(135deg, #6f42c1, #6610f2); }
.admin-header { background: linear-gradient(135deg, #fd7e14, #e83e8c); }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- View Switcher -->
    <div class="view-switcher">
        <h2><i class="fas fa-eye me-2"></i>Portal Dashboard Views</h2>
        <p class="text-muted">Experience different user perspectives of the SkyCareLink platform</p>
        
        <div class="view-selector">
            <button class="view-option active" onclick="switchView('provider')">
                <i class="fas fa-plane me-1"></i>Affiliate (Air Operator)
            </button>
            <button class="view-option" onclick="switchView('hospital')">
                <i class="fas fa-hospital me-1"></i>Hospital/Clinic
            </button>
            <button class="view-option" onclick="switchView('individual')">
                <i class="fas fa-user me-1"></i>Individual/Family
            </button>
            <button class="view-option" onclick="switchView('admin')">
                <i class="fas fa-crown me-1"></i>Admin
            </button>
        </div>
    </div>

    <!-- Provider View -->
    <div id="provider-view" class="dashboard-view provider-view">
        <div class="role-header provider-header">
            <h1><i class="fas fa-plane me-2"></i>AeroMed Flight Services</h1>
            <p>Provider Dashboard - Managing Medical Transport Operations</p>
        </div>

        <!-- Top Controls -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex gap-3 align-items-center">
                <div>
                    <label class="form-label fw-bold mb-1">Date Range</label>
                    <select class="form-select" id="dateRangeFilter" onchange="updateAnalytics()">
                        <option value="day">Today</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div id="customDateRange" style="display: none;">
                    <label class="form-label fw-bold mb-1">Custom Range</label>
                    <div class="d-flex gap-2">
                        <input type="date" class="form-control" id="startDate">
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('user_management') }}" class="btn btn-outline-primary">
                    <i class="fas fa-users me-2"></i>Manage Users
                </a>
                <button class="btn btn-primary" onclick="exportData()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>

        <!-- Referral Summary Card (for non-admin users) -->
        {% if user_role != 'admin' %}
        <div class="pancake-row mb-3">
            <div class="pancake-header" onclick="togglePancake(this)">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="pancake-icon">
                            <i class="fas fa-share-alt text-info"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Referral Performance</h5>
                            <small class="text-muted">Track your referral metrics and service status</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-center">
                            <div class="fw-bold text-primary fs-5">45</div>
                            <small class="text-muted">Total Referrals</small>
                        </div>
                        <div class="text-center">
                            <div class="fw-bold text-success fs-5">32</div>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="pancake-chevron">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pancake-content">
                <div class="row">
                    <div class="col-md-4">
                        <div class="stat-box">
                            <div class="stat-label">Referral Success Rate</div>
                            <div class="stat-value text-success">71.1%</div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 71.1%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box">
                            <div class="stat-label">Service Type</div>
                            <div class="stat-value text-info">Paid Monthly</div>
                            <div class="stat-sublabel text-muted">Expires: Sept 11, 2025</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box">
                            <div class="stat-label">Commission Earned</div>
                            <div class="stat-value text-success">$12,480</div>
                            <div class="stat-sublabel text-muted">This quarter</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Pancake-style Analytics Rows -->
        <div class="pancake-container">
            <!-- Active Requests Row -->
            <div class="pancake-row">
                <div class="pancake-header" onclick="togglePancake(this)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="pancake-icon">
                                <i class="fas fa-clipboard-list text-warning"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Active Requests</h5>
                                <small class="text-muted">Transport requests awaiting action</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="metric-summary">
                                <div class="fw-bold fs-4">12</div>
                                <div class="text-success small">+3 today</div>
                            </div>
                            <div class="pancake-chevron">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pancake-content">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">By Status</div>
                                <div class="stat-breakdown">
                                    <div class="d-flex justify-content-between">
                                        <span><span class="badge bg-warning me-1">7</span> Pending</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><span class="badge bg-info me-1">3</span> Quoted</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><span class="badge bg-success me-1">2</span> Confirmed</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">By Priority</div>
                                <div class="stat-breakdown">
                                    <div class="d-flex justify-content-between">
                                        <span><span class="badge bg-danger me-1">2</span> Critical</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><span class="badge bg-warning me-1">4</span> Urgent</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><span class="badge bg-secondary me-1">6</span> Routine</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">Average Response Time</div>
                                <div class="stat-value text-success">1.2 hrs</div>
                                <div class="stat-sublabel text-muted">15min faster than last week</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <button class="btn btn-primary" onclick="viewRequests()">
                                    <i class="fas fa-list me-2"></i>View All Requests
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quotes Provided Row -->
            <div class="pancake-row">
                <div class="pancake-header" onclick="togglePancake(this)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="pancake-icon">
                                <i class="fas fa-file-invoice-dollar text-info"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Quotes Provided</h5>
                                <small class="text-muted">Price estimates and proposals</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="metric-summary">
                                <div class="fw-bold fs-4">8</div>
                                <div class="text-success small">+5 this week</div>
                            </div>
                            <div class="pancake-chevron">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pancake-content">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">Response Rate</div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 85%"></div>
                                </div>
                                <div class="stat-value text-success">85%</div>
                                <div class="stat-sublabel text-muted">within 2 hours</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">Average Quote Value</div>
                                <div class="stat-value text-primary">$85,000</div>
                                <div class="stat-sublabel text-success">+12% vs last week</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">Win Rate</div>
                                <div class="stat-value text-success">37.5%</div>
                                <div class="stat-sublabel text-muted">3 of 8 accepted</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <button class="btn btn-info" onclick="viewQuotes()">
                                    <i class="fas fa-chart-line me-2"></i>View Quote Analytics
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Row -->
            <div class="pancake-row">
                <div class="pancake-header" onclick="togglePancake(this)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="pancake-icon">
                                <i class="fas fa-dollar-sign text-success"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Revenue Performance</h5>
                                <small class="text-muted">Financial metrics and earnings</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="metric-summary">
                                <div class="fw-bold fs-4">$127,500</div>
                                <div class="text-success small">+18% vs last month</div>
                            </div>
                            <div class="pancake-chevron">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pancake-content">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">Revenue Breakdown</div>
                                <div class="stat-breakdown">
                                    <div class="d-flex justify-content-between">
                                        <span>Base Fares:</span>
                                        <span class="text-success">$98,000</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Concierge:</span>
                                        <span class="text-info">$22,500</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Equipment:</span>
                                        <span class="text-warning">$7,000</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">Commission Earned</div>
                                <div class="stat-value text-success">$6,375</div>
                                <div class="stat-sublabel text-muted">5% avg commission</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box">
                                <div class="stat-label">Growth Rate</div>
                                <div class="stat-value text-success">+18%</div>
                                <div class="stat-sublabel text-muted">Month over month</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-box text-center">
                                <button class="btn btn-success" onclick="viewRevenue()">
                                    <i class="fas fa-chart-bar me-2"></i>Revenue Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h4>Recent Quote Activity</h4>
            <p class="text-muted">Auto-refreshing every 15 seconds for new transport requests</p>
            <div class="alert alert-info">
                <i class="fas fa-bell me-2"></i>New request received: Orlando → Miami Medical Transport
            </div>
        </div>
    </div>

    <!-- Hospital View -->
    <div id="hospital-view" class="dashboard-view hospital-view" style="display: none;">
        <div class="role-header hospital-header">
            <h1><i class="fas fa-hospital me-2"></i>Regional Medical Center</h1>
            <p>Hospital Dashboard - Coordinating Patient Transfers</p>
        </div>

        <div class="dashboard-grid">
            <div class="metric-card">
                <div class="metric-value">24</div>
                <div class="metric-label">Patient Transfers</div>
                <div class="metric-change positive">This month</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">6</div>
                <div class="metric-label">Critical Transports</div>
                <div class="metric-change">Last 7 days</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">98%</div>
                <div class="metric-label">HIPAA Compliance</div>
                <div class="metric-change positive">All transfers secure</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">4.8/5</div>
                <div class="metric-label">Provider Rating</div>
                <div class="metric-change positive">Patient satisfaction</div>
            </div>
        </div>

        <div class="chart-container">
            <h4>Transport Volume Trends</h4>
            <p class="text-muted">Bulk request management and priority scheduling</p>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>Emergency protocol activated for critical transfer
            </div>
        </div>
    </div>

    <!-- Individual View -->
    <div id="individual-view" class="dashboard-view individual-view" style="display: none;">
        <div class="role-header individual-header">
            <h1><i class="fas fa-user me-2"></i>Sarah Johnson Family</h1>
            <p>Family Dashboard - Managing Medical Transport Needs</p>
        </div>

        <div class="dashboard-grid">
            <div class="metric-card">
                <div class="metric-value">2</div>
                <div class="metric-label">Active Requests</div>
                <div class="metric-change">Awaiting quotes</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">$1,000</div>
                <div class="metric-label">Deposit Ready</div>
                <div class="metric-change">Secure payment</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">24/7</div>
                <div class="metric-label">Family Support</div>
                <div class="metric-change positive">Dedicated advocate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">5</div>
                <div class="metric-label">Provider Options</div>
                <div class="metric-change">Certified network</div>
            </div>
        </div>

        <div class="chart-container">
            <h4>Your Transport History</h4>
            <p class="text-muted">Family-focused comfort and communication features</p>
            <div class="alert alert-success">
                <i class="fas fa-heart me-2"></i>Priority support available - MVP member benefits active
            </div>
        </div>
    </div>

    <!-- Admin View -->
    <div id="admin-view" class="dashboard-view admin-view" style="display: none;">
        <div class="role-header admin-header">
            <h1><i class="fas fa-crown me-2"></i>SkyCareLink Admin Dashboard</h1>
            <p>System Administration - Revenue Analytics & User Management</p>
        </div>

        <div class="dashboard-grid">
            <div class="metric-card">
                <div class="metric-value">$847,500</div>
                <div class="metric-label">Total Revenue</div>
                <div class="metric-change positive">+$127K this month</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">1,247</div>
                <div class="metric-label">Total Users</div>
                <div class="metric-change positive">+89 new this week</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">342</div>
                <div class="metric-label">Flight Requests</div>
                <div class="metric-change positive">156 completed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">67</div>
                <div class="metric-label">Active Quotes</div>
                <div class="metric-change">23 paid today</div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h4>User Management</h4>
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between">
                            <span>Reset Passwords</span>
                            <button class="btn btn-sm btn-outline-primary">Manage</button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between">
                            <span>Admin Controls</span>
                            <button class="btn btn-sm btn-outline-danger">Grant Access</button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between">
                            <span>Partner Control</span>
                            <button class="btn btn-sm btn-outline-success">Configure</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h4>Quote & Payment Management</h4>
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between">
                            <span>Quote Management</span>
                            <button class="btn btn-sm btn-outline-primary">View All</button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between">
                            <span>Payment Transactions</span>
                            <button class="btn btn-sm btn-outline-success">Review</button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between">
                            <span>Flights per Provider</span>
                            <button class="btn btn-sm btn-outline-info">Analytics</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function switchView(viewType) {
    // Hide all views
    document.querySelectorAll('.dashboard-view').forEach(view => {
        view.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.view-option').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected view
    document.getElementById(viewType + '-view').style.display = 'block';
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    console.log(`Switched to ${viewType} view`);
}

// Pancake-style expandable rows
function togglePancake(header) {
    const row = header.parentElement;
    row.classList.toggle('expanded');
}

function updateAnalytics() {
    const dateRange = document.getElementById('dateRangeFilter').value;
    const customRange = document.getElementById('customDateRange');
    
    if (dateRange === 'custom') {
        customRange.style.display = 'block';
    } else {
        customRange.style.display = 'none';
    }
    
    console.log('Updating analytics for date range:', dateRange);
}

function exportData() {
    alert('Exporting analytics data... (CSV/PDF export would be implemented here)');
}

function viewRequests() {
    alert('Navigating to detailed requests view...');
}

function viewQuotes() {
    alert('Navigating to quotes management...');
}

function viewBookings() {
    alert('Navigating to bookings dashboard...');
}

function viewRevenue() {
    alert('Opening revenue analytics dashboard...');
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Portal views loaded - No login required');
});
</script>
{% endblock %}
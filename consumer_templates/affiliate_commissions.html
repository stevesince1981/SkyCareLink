{% extends "consumer_base.html" %}

{% block title %}Commission Dashboard - {{ affiliate_id }} - MediFly{% endblock %}

{% block head %}
<style>
/* Phase 6.A: Affiliate Commission Dashboard Styling */
.affiliate-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.recoup-progress {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    text-align: center;
}

.progress-bar-custom {
    height: 20px;
    border-radius: 10px;
    background: #e9ecef;
    margin: 1rem 0;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    border-radius: 10px;
    transition: width 0.3s ease;
}

.tier-badge {
    background: #ffc107;
    color: #000;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    margin-top: 1rem;
    display: inline-block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #28a745;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-weight: 600;
}

.weekly-commissions {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.table th {
    background: #28a745;
    color: white;
    border: none;
    font-weight: 600;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-pending {
    background: #6c757d;
    color: white;
}

.status-issued {
    background: #ffc107;
    color: #000;
}

.status-paid {
    background: #28a745;
    color: white;
}

.payment-notice {
    background: #e3f2fd;
    border-left: 4px solid #1976d2;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-radius: 0 10px 10px 0;
}

.training-notice {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 2rem;
    text-align: center;
}

.no-commissions {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="affiliate-header text-center">
    <div class="container">
        <h1><i class="fas fa-calculator"></i> Commission Dashboard</h1>
        <p class="lead">{{ affiliate_id }} - Track your earnings and recoup progress</p>
    </div>
</div>

<div class="container">
    <!-- Payment Flow Notice -->
    <div class="payment-notice">
        <h5><i class="fas fa-info-circle"></i> Payment Process</h5>
        <p class="mb-0">
            <strong>You collect full booking payments.</strong> ACH commission due weekly on issued invoices. 
            Commission rates: 4% until $25,000 recoup threshold, then 5% thereafter.
        </p>
    </div>

    <!-- Recoup Progress -->
    <div class="recoup-progress">
        <h4>Recoup Progress</h4>
        <div class="progress-bar-custom">
            <div class="progress-fill" style="width: {{ recoup_progress.percentage }}%"></div>
        </div>
        <div class="d-flex justify-content-between">
            <span>${{ "{:,}".format(recoup_progress.current) }}</span>
            <span>${{ "{:,}".format(recoup_progress.threshold) }}</span>
        </div>
        <div class="tier-badge">{{ recoup_progress.tier }}</div>
        <p class="mt-2 text-muted">
            {% if recoup_progress.current < recoup_progress.threshold %}
            ${{ "{:,}".format(recoup_progress.threshold - recoup_progress.current) }} remaining until 5% commission tier
            {% else %}
            âœ“ 5% commission tier unlocked!
            {% endif %}
        </p>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_bookings }}</div>
            <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${{ "{:,}".format(stats.total_commission) }}</div>
            <div class="stat-label">Commission Earned</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${{ "{:,}".format(stats.total_volume) }}</div>
            <div class="stat-label">Total Volume</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(stats.avg_commission_rate) }}%</div>
            <div class="stat-label">Avg Commission Rate</div>
        </div>
    </div>

    <!-- Weekly Commission Summary -->
    <div class="weekly-commissions">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-calendar-week"></i> Weekly Commission Summary</h5>
        </div>
        {% if weekly_summary %}
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Bookings</th>
                    <th>Base Volume</th>
                    <th>Commission</th>
                    <th>Status</th>
                    <th>Dates</th>
                </tr>
            </thead>
            <tbody>
                {% for week in weekly_summary %}
                <tr>
                    <td><strong>{{ week.week }}</strong></td>
                    <td>{{ week.bookings }}</td>
                    <td>${{ "{:,}".format(week.total_base) }}</td>
                    <td><strong>${{ "{:,}".format(week.total_commission) }}</strong></td>
                    <td>
                        <span class="status-badge status-{{ week.status }}">
                            {% if week.status == 'pending' %}
                            <i class="fas fa-clock"></i> Pending
                            {% elif week.status == 'issued' %}
                            <i class="fas fa-file-invoice"></i> Issued
                            {% else %}
                            <i class="fas fa-check"></i> Paid
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if week.get('issued_at') %}
                        <small>Issued: {{ week.issued_at[:10] }}</small><br>
                        {% endif %}
                        {% if week.get('paid_at') %}
                        <small>Paid: {{ week.paid_at[:10] }}</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-commissions">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h4>No Commission Data</h4>
            <p>Complete bookings will appear here with commission calculations.</p>
        </div>
        {% endif %}
    </div>

    <!-- Training Mode Notice -->
    {% if session.get('is_training_mode') %}
    <div class="training-notice">
        <i class="fas fa-graduation-cap"></i>
        <strong>Training Mode Active:</strong> Commission data hidden in training mode.
    </div>
    {% endif %}

    <!-- Commission Details -->
    <div class="mt-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info"></i> Commission Structure</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Tier 1 (Under $25,000 recoup)</h6>
                        <ul>
                            <li><strong>4%</strong> commission on completed bookings</li>
                            <li><strong>1%</strong> added to recoup progress</li>
                            <li>Builds toward 5% tier unlock</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Tier 2 ($25,000+ recoup)</h6>
                        <ul>
                            <li><strong>5%</strong> commission on completed bookings</li>
                            <li>No additional recoup accumulation</li>
                            <li>Higher earnings on all future bookings</li>
                        </ul>
                    </div>
                </div>
                <hr>
                <p class="mb-0 text-muted">
                    <small>
                        Weekly invoices generated Sunday-Saturday. Payment terms: NET 7 days. 
                        Training/dummy bookings excluded from all calculations.
                    </small>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% extends "consumer_base.html" %}

{% block title %}Transport Quotes - MediFly{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Phase 12.A: Enhanced quotes page with Concierge badge and unmasking -->
    <div class="row">
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-4">
                <h1 class="h3 mb-0 me-3">
                    <i class="fas fa-quote-left me-2"></i>Transport Quotes
                </h1>
                <div class="ms-auto">
                    <span class="badge bg-primary">{{ quotes|length }} quotes received</span>
                    <div id="polling-indicator" class="mt-1">
                        <small class="text-muted">
                            <i class="fas fa-sync-alt fa-spin me-1" style="display: none;" id="polling-spinner"></i>
                            Checking for new quotes...
                        </small>
                    </div>
                </div>
            </div>

            <!-- Phase 12.A: Quote cards with Concierge badge and masking -->
            <div class="quotes-container">
                {% for quote in quotes %}
                <div class="quote-card {{ 'concierge-quote' if quote.is_concierge else '' }}" data-quote-id="{{ quote.id }}">
                    <div class="quote-header">
                        <div class="d-flex align-items-center">
                            <div class="provider-info">
                                {% if quote.confirmed %}
                                <h5 class="provider-name">{{ quote.provider_name }}</h5>
                                <div class="provider-details">
                                    <span class="badge bg-success me-2">
                                        <i class="fas fa-check me-1"></i>Confirmed
                                    </span>
                                    {{ quote.aircraft_type }} • {{ quote.eta }} ETA
                                </div>
                                {% else %}
                                <h5 class="provider-name">{{ quote.masked_name }}</h5>
                                <div class="provider-details">
                                    <span class="badge bg-secondary me-2">Pending confirmation</span>
                                    {{ quote.aircraft_type }} • {{ quote.eta }} ETA
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Phase 12.C: Concierge badge with tooltip -->
                            {% if quote.is_concierge %}
                            <div class="concierge-badge ms-auto" 
                                 data-bs-toggle="tooltip" 
                                 title="Dedicated concierge service: personal coordination, 24/7 support, and premium handling">
                                <span class="badge bg-primary">
                                    <i class="fas fa-concierge-bell me-1"></i>Concierge
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="quote-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="pricing-breakdown">
                                    <div class="price-item">
                                        <span>Base transport fare:</span>
                                        <span class="fw-bold">${{ "{:,}".format(quote.base_fare) }}</span>
                                    </div>
                                    
                                    {% if quote.equipment_cost > 0 %}
                                    <div class="price-item">
                                        <span>Medical equipment:</span>
                                        <span class="fw-bold">${{ "{:,}".format(quote.equipment_cost) }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if quote.is_concierge %}
                                    <div class="price-item concierge-line">
                                        <span>Concierge service add-on:</span>
                                        <span class="fw-bold text-primary">${{ "{:,}".format(quote.concierge_addon) }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if quote.same_day_surcharge > 0 %}
                                    <div class="price-item surcharge-line">
                                        <span>Same-day urgent surcharge (+20%):</span>
                                        <span class="fw-bold text-warning">${{ "{:,}".format(quote.same_day_surcharge) }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    <hr class="my-2">
                                    <div class="price-item total-price">
                                        <span class="fs-5 fw-bold">Total Price:</span>
                                        <span class="fs-4 fw-bold text-success">${{ "{:,}".format(quote.total_price) }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="quote-features">
                                    <h6>Capabilities:</h6>
                                    <ul class="feature-list">
                                        {% for capability in quote.capabilities %}
                                        <li><i class="fas fa-check text-success me-1"></i>{{ capability }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="quote-footer">
                        {% if quote.confirmed %}
                        <div class="quote-code-display">
                            <strong>Booking Code:</strong> {{ quote.booking_code }}
                            <small class="text-muted d-block">Provider has been notified and will contact you directly.</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="proceedToBooking('{{ quote.id }}')">
                                <i class="fas fa-calendar-check me-2"></i>Proceed to Booking
                            </button>
                            <button class="btn btn-outline-secondary" onclick="contactProvider('{{ quote.id }}')">
                                <i class="fas fa-phone me-2"></i>Contact Provider
                            </button>
                        </div>
                        {% else %}
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="selectAffiliate('{{ quote.id }}', '{{ quote.masked_name }}')">
                                <i class="fas fa-handshake me-2"></i>Request {{ quote.masked_name }}
                            </button>
                            <button class="btn btn-outline-info" onclick="viewProviderDetails('{{ quote.id }}')">
                                <i class="fas fa-info-circle me-2"></i>More Details
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- No quotes state -->
            {% if not quotes %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-clock fa-3x text-muted"></i>
                </div>
                <h4>Waiting for quotes...</h4>
                <p class="text-muted">Providers typically respond within 15-60 minutes.</p>
                <button class="btn btn-outline-primary" onclick="refreshQuotes()">
                    <i class="fas fa-refresh me-2"></i>Check Again
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Request summary sidebar -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 2rem;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-medical me-2"></i>Request Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="request-detail">
                        <strong>Transport Type:</strong>
                        <span class="badge bg-{{ 'danger' if request.transport_type == 'critical' else 'primary' }}">
                            {{ request.transport_type.title() }}
                        </span>
                    </div>
                    
                    <div class="request-detail">
                        <strong>Severity Level:</strong>
                        <span class="badge bg-{{ 'success' if request.severity_level == 1 else ('warning' if request.severity_level == 2 else 'danger') }}">
                            Level {{ request.severity_level }}
                        </span>
                    </div>
                    
                    <div class="request-detail">
                        <strong>Route:</strong><br>
                        <small>
                            <i class="fas fa-map-marker-alt text-success me-1"></i>{{ request.from_facility }}<br>
                            <i class="fas fa-arrow-down text-muted mx-2"></i><br>
                            <i class="fas fa-map-marker-alt text-danger me-1"></i>{{ request.to_facility }}
                        </small>
                    </div>
                    
                    <div class="request-detail">
                        <strong>Patient:</strong><br>
                        {{ request.patient_name }}
                        {% if request.patient_age_band %}
                            ({{ request.patient_age_band.replace('_', '-') }})
                        {% endif %}
                    </div>
                    
                    {% if request.equipment %}
                    <div class="request-detail">
                        <strong>Equipment:</strong><br>
                        <small>{{ request.equipment|join(', ') }}</small>
                    </div>
                    {% endif %}
                    
                    <div class="request-detail">
                        <strong>When:</strong><br>
                        {{ request.preferred_date }}
                        {% if request.preferred_time %}{{ request.preferred_time }}{% endif %}
                        {% if request.same_day_urgent %}
                        <span class="badge bg-warning ms-1">Same-day urgent</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="d-grid">
                        <button class="btn btn-outline-secondary" onclick="editRequest()">
                            <i class="fas fa-edit me-2"></i>Modify Request
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 12.A: Affiliate selection modal with updated copy -->
<div class="modal fade" id="affiliateSelectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Affiliate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Request <span id="selectedAffiliateName"></span> for your transport?</strong></p>
                
                <!-- Phase 12.B Fix: Enhanced selection modal -->
                <div class="quote-code-preview mb-3">
                    <div class="border rounded p-3 bg-light">
                        <h6>Quote Code: <span id="generatedQuoteCode" class="text-monospace font-weight-bold"></span></h6>
                        <p class="mb-1"><strong>Status:</strong> Awaiting affiliate confirmation</p>
                        <small class="text-muted">Booking will be confirmed once affiliate accepts and deposit/payment is secured.</small>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Provider identity remains masked until affiliate confirms with payment. You'll then receive full contact information for direct coordination.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmAffiliateSelection()">
                    <i class="fas fa-paper-plane me-2"></i>Send Request
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Phase 12.A: Enhanced quote styling */
.quotes-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.quote-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    background: white;
    transition: all 0.3s ease;
    overflow: hidden;
}

.quote-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.quote-card.concierge-quote {
    border-color: #0d6efd;
    background: linear-gradient(145deg, #f8f9ff 0%, #fff 100%);
}

.quote-header {
    padding: 1.5rem 1.5rem 1rem 1.5rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.provider-name {
    color: #212529;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.provider-details {
    color: #6c757d;
    font-size: 0.9rem;
}

.concierge-badge {
    position: relative;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #0d6efd, #6610f2) !important;
}

.quote-body {
    padding: 1.5rem;
}

.pricing-breakdown {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
}

.price-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
}

.concierge-line {
    color: #0d6efd;
    font-weight: 500;
}

.surcharge-line {
    color: #f59e0b;
    font-weight: 500;
}

.total-price {
    background: #e8f5e8;
    border-radius: 6px;
    padding: 0.75rem !important;
    margin: 0.5rem -0.5rem -0.5rem -0.5rem;
}

.quote-features {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
}

.feature-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.feature-list li {
    padding: 0.25rem 0;
    font-size: 0.9rem;
}

.quote-footer {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
}

.quote-code-display {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 1rem;
}

.request-detail {
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #f0f0f0;
}

.request-detail:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

/* Polling indicator */
#polling-indicator {
    font-size: 0.8rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .quote-card {
        margin: 0 -0.5rem;
        border-radius: 8px;
    }
    
    .concierge-badge {
        margin-top: 0.5rem;
        margin-left: 0 !important;
    }
    
    .pricing-breakdown {
        font-size: 0.9rem;
    }
}
</style>

<script>
// Phase 12.A: Enhanced quotes functionality
let selectedQuoteId = null;
let pollingInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    startQuotePolling();
    initializeTooltips();
});

function startQuotePolling() {
    // Poll for new quotes every 15 seconds
    pollingInterval = setInterval(function() {
        document.getElementById('polling-spinner').style.display = 'inline';
        checkForNewQuotes();
    }, 15000);
}

function checkForNewQuotes() {
    fetch('/quotes/poll?request_id={{ request.request_id }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('polling-spinner').style.display = 'none';
            
            if (data.new_quotes) {
                showNewQuoteNotification(data.count);
                // Optionally reload the page or update the quotes dynamically
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(error => {
            console.error('Polling error:', error);
            document.getElementById('polling-spinner').style.display = 'none';
        });
}

function showNewQuoteNotification(count) {
    // Show "New quote available" badge
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show';
    notification.innerHTML = `
        <i class="fas fa-bell me-2"></i>
        <strong>New quote${count > 1 ? 's' : ''} available!</strong> ${count} new quote${count > 1 ? 's' : ''} received.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.quotes-container').insertAdjacentElement('beforebegin', notification);
}

function selectAffiliate(quoteId, affiliateName) {
    selectedQuoteId = quoteId;
    document.getElementById('selectedAffiliateName').textContent = affiliateName;
    
    // Phase 12.B Fix: Generate quote code immediately for preview
    const quoteCode = generateQuoteCode();
    document.getElementById('generatedQuoteCode').textContent = quoteCode;
    
    const modal = new bootstrap.Modal(document.getElementById('affiliateSelectionModal'));
    modal.show();
}

function generateQuoteCode() {
    // Generate 8-character alphanumeric code
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

function confirmAffiliateSelection() {
    if (!selectedQuoteId) return;
    
    // Generate booking code and send request to affiliate
    fetch('/quotes/select', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            quote_id: selectedQuoteId,
            request_id: '{{ request.request_id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and show success message
            bootstrap.Modal.getInstance(document.getElementById('affiliateSelectionModal')).hide();
            
            alert(`Booking code ${data.booking_code} has been issued. Both you and the affiliate have been notified.`);
            
            // Lock the intake form
            lockIntakeEdits();
            
            // Refresh the page to show updated quote status
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Error selecting affiliate: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Selection error:', error);
        alert('Error selecting affiliate. Please try again.');
    });
}

function lockIntakeEdits() {
    // Disable the modify request button
    const editButton = document.querySelector('[onclick="editRequest()"]');
    if (editButton) {
        editButton.disabled = true;
        editButton.innerHTML = '<i class="fas fa-lock me-2"></i>Request Locked';
        editButton.classList.remove('btn-outline-secondary');
        editButton.classList.add('btn-secondary');
    }
}

function refreshQuotes() {
    location.reload();
}

function editRequest() {
    window.location.href = '/intake?edit={{ request.request_id }}';
}

function proceedToBooking(quoteId) {
    window.location.href = `/booking/confirm?quote_id=${quoteId}`;
}

function contactProvider(quoteId) {
    // Show provider contact information
    alert('Provider contact information will be provided after confirmation.');
}

function viewProviderDetails(quoteId) {
    // Show additional provider details (capabilities, certifications, etc.)
    alert('Additional provider details: Certified for critical care transport, 24/7 availability, experienced medical crew.');
}

function initializeTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// Cleanup polling on page unload
window.addEventListener('beforeunload', function() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});
</script>
{% endblock %}
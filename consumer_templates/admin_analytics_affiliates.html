{% extends "consumer_base.html" %}

{% block title %}Admin - Affiliate Analytics{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Affiliate Analytics - Flights per Provider</h1>
        <div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Success Rate Definition -->
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Success Rate Definition:</strong> Percentage of quotes that converted to a booked flight in the last 30 days.
    </div>

    <!-- Analytics Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Provider Performance Analytics</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Affiliate</th>
                            <th>Fee %</th>
                            <th>Recoup Remaining</th>
                            <th>Flights Completed</th>
                            <th>Response Rate (30d)</th>
                            <th>Spotlight</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in analytics %}
                        <tr>
                            <td>
                                <strong>{{ item.affiliate }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ item.fee_percent }}%</span>
                            </td>
                            <td>
                                <span class="text-muted">${{ "{:,}".format(item.recoup_remaining) }}</span>
                            </td>
                            <td>
                                <span class="badge bg-success">{{ item.flights_completed }}</span>
                            </td>
                            <td>
                                {% if item.response_rate_30d >= 80 %}
                                    <span class="badge bg-success">{{ item.response_rate_30d }}%</span>
                                {% elif item.response_rate_30d >= 60 %}
                                    <span class="badge bg-warning">{{ item.response_rate_30d }}%</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ item.response_rate_30d }}%</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.spotlight %}
                                    <span class="badge bg-warning">Yes</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="toggleFlightDetails('{{ loop.index0 }}')">
                                    <i class="fas fa-plus" id="icon-{{ loop.index0 }}"></i> Expand
                                </button>
                            </td>
                        </tr>
                        <tr id="details-{{ loop.index0 }}" style="display: none;">
                            <td colspan="7">
                                <div class="bg-light p-3 rounded">
                                    <h6>Recent Flight Details</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Base Fare</th>
                                                    <th>Concierge Add-on</th>
                                                    <th>Our Split</th>
                                                    <th>Commission (5%)</th>
                                                    <th>Total Revenue</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for flight in item.flight_details %}
                                                <tr>
                                                    <td>{{ flight.date }}</td>
                                                    <td>${{ "{:,}".format(flight.base_fare) }}</td>
                                                    <td>
                                                        {% if flight.concierge_addon > 0 %}
                                                            <span class="text-info">${{ "{:,}".format(flight.concierge_addon) }}</span>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if flight.our_split > 0 %}
                                                            <span class="text-success">${{ "{:,}".format(flight.our_split) }}</span>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>${{ "{:,}".format((flight.base_fare * 0.05) | int) }}</td>
                                                    <td>
                                                        <strong>${{ "{:,}".format(((flight.base_fare * 0.05) + flight.our_split) | int) }}</strong>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary">{{ analytics|sum(attribute='flights_completed') }}</h4>
                    <p class="text-muted mb-0">Total Flights</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">{{ ((analytics|sum(attribute='response_rate_30d')) / analytics|length) | round }}%</h4>
                    <p class="text-muted mb-0">Avg Response Rate</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info">{{ analytics|selectattr('spotlight')|list|length }}</h4>
                    <p class="text-muted mb-0">Spotlight Partners</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleFlightDetails(index) {
    const detailsRow = document.getElementById('details-' + index);
    const icon = document.getElementById('icon-' + index);
    
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = '';
        icon.className = 'fas fa-minus';
    } else {
        detailsRow.style.display = 'none';
        icon.className = 'fas fa-plus';
    }
}
</script>
{% endblock %}
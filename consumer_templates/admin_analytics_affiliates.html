{% extends "consumer_base.html" %}

{% block title %}Flights per Provider Analytics - MediFly Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Flights per Provider Analytics
                    </h4>
                    <div>
                        <input type="text" id="affiliateFilter" class="form-control form-control-sm" 
                               placeholder="Filter by affiliate name..." style="min-width: 200px;">
                    </div>
                </div>
                <div class="card-body">
                    {% if affiliates_data %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="affiliatesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="sortable" data-sort="company_name">
                                        Affiliate <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="sortable" data-sort="fee_percent">
                                        Fee % <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="sortable" data-sort="recoup_remaining">
                                        Recoup Remaining <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="sortable" data-sort="total_flights">
                                        Total Flights <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="sortable" data-sort="avg_response_time">
                                        Avg Response Time <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="sortable" data-sort="response_rate_30day">
                                        30-day Response Rate <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="sortable" data-sort="is_spotlight">
                                        Spotlight <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for affiliate in affiliates_data %}
                                <tr data-affiliate-name="{{ affiliate.company_name|lower }}">
                                    <td>
                                        <strong>{{ affiliate.company_name }}</strong>
                                        <br><small class="text-muted">ID: {{ affiliate.id }}</small>
                                    </td>
                                    <td>
                                        <form method="post" action="{{ url_for('admin_edit_affiliate_commission', affiliate_id=affiliate.id) }}" 
                                              class="d-inline-flex align-items-center" onsubmit="return confirm('Update commission rate?')">
                                            <input type="number" name="commission_percent" 
                                                   value="{{ '%.1f'|format(affiliate.fee_percent) }}" 
                                                   min="3.0" max="7.0" step="0.1" 
                                                   class="form-control form-control-sm me-2" style="width: 70px;">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-save"></i>
                                            </button>
                                        </form>
                                    </td>
                                    <td>
                                        <span class="fw-bold ${{'text-success' if affiliate.recoup_remaining == 0 else 'text-warning'}}">
                                            ${{ '{:,.2f}'.format(affiliate.recoup_remaining) }}
                                        </span>
                                        {% if affiliate.recoup_remaining == 0 %}
                                        <br><small class="text-success">Fully recouped</small>
                                        {% else %}
                                        <br><small class="text-muted">${{ '{:,.2f}'.format(affiliate.recouped_amount) }} / $25,000</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary fs-6">{{ affiliate.total_flights }}</span>
                                    </td>
                                    <td>
                                        {% if affiliate.avg_response_time > 0 %}
                                        {{ affiliate.avg_response_time }} min
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if affiliate.response_rate_30day > 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ affiliate.response_rate_30day }}%">
                                                {{ '%.1f'|format(affiliate.response_rate_30day) }}%
                                            </div>
                                        </div>
                                        {% else %}
                                        <span class="text-muted">No data</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if affiliate.is_spotlight %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-star"></i> Spotlight
                                        </span>
                                        <br><small class="text-muted">&lt;50 bookings or &lt;90 days</small>
                                        {% else %}
                                        <span class="text-muted">Standard</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="showAffiliateDetails({{ affiliate.id }})">
                                            <i class="fas fa-info-circle"></i> Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No affiliate data available</h5>
                        <p class="text-muted">Analytics will appear here once affiliates are added to the system.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Affiliate Details Modal -->
<div class="modal fade" id="affiliateDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Affiliate Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="affiliateDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
// Table sorting functionality
let currentSort = { column: null, direction: 'asc' };

document.querySelectorAll('.sortable').forEach(header => {
    header.addEventListener('click', function() {
        const column = this.dataset.sort;
        
        // Toggle direction if clicking same column
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        
        sortTable(column, currentSort.direction);
        updateSortIcons();
    });
});

function sortTable(column, direction) {
    const tbody = document.querySelector('#affiliatesTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aVal = getCellValue(a, column);
        let bVal = getCellValue(b, column);
        
        // Handle numeric values
        if (!isNaN(aVal) && !isNaN(bVal)) {
            aVal = parseFloat(aVal);
            bVal = parseFloat(bVal);
        }
        
        if (direction === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

function getCellValue(row, column) {
    const columnIndex = {
        'company_name': 0,
        'fee_percent': 1,
        'recoup_remaining': 2,
        'total_flights': 3,
        'avg_response_time': 4,
        'response_rate_30day': 5,
        'is_spotlight': 6
    };
    
    const cell = row.cells[columnIndex[column]];
    return cell.textContent.trim();
}

function updateSortIcons() {
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort ms-1';
    });
    
    if (currentSort.column) {
        const activeHeader = document.querySelector(`[data-sort="${currentSort.column}"] i`);
        if (activeHeader) {
            activeHeader.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} ms-1`;
        }
    }
}

// Search/filter functionality
document.getElementById('affiliateFilter').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#affiliatesTable tbody tr');
    
    rows.forEach(row => {
        const affiliateName = row.dataset.affiliateName;
        if (affiliateName.includes(filter)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

function showAffiliateDetails(affiliateId) {
    // Simple modal with basic info for now
    document.getElementById('affiliateDetailsContent').innerHTML = `
        <p>Detailed affiliate information for ID: ${affiliateId}</p>
        <p>Additional analytics and drill-down data would be implemented here.</p>
    `;
    new bootstrap.Modal(document.getElementById('affiliateDetailsModal')).show();
}
</script>

<style>
.sortable {
    cursor: pointer;
    user-select: none;
}

.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.table-responsive {
    border-radius: 0.375rem;
}

.progress {
    min-width: 60px;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
{% endblock %}
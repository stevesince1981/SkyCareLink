<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SkyCareLink Consumer - Get Your Loved One Home Safely{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- BotUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/botui/build/botui.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='consumer_css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='consumer_static/css/main.css') }}">
    
    <!-- Site Audit UX Tightening - Compact CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/compact.css') }}">
    
    <!-- Google Analytics 4 -->
    {% if config.get('GA_MEASUREMENT_ID') or config.get('ga_measurement_id') %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ config.get('GA_MEASUREMENT_ID') or config.get('ga_measurement_id') }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ config.get('GA_MEASUREMENT_ID') or config.get('ga_measurement_id') }}');
        
        // Custom event tracking functions
        function trackQuoteStarted() {
            gtag('event', 'quote_started', {
                event_category: 'quote',
                event_label: 'user_initiated'
            });
        }
        
        function trackQuoteSubmitted() {
            gtag('event', 'quote_submitted', {
                event_category: 'quote',
                event_label: 'form_completed'
            });
        }
        
        function trackAffiliateQuoteSubmitted() {
            gtag('event', 'affiliate_quote_submitted', {
                event_category: 'affiliate',
                event_label: 'provider_response'
            });
        }
        
        function trackBookingConfirmed() {
            gtag('event', 'booking_confirmed', {
                event_category: 'booking',
                event_label: 'payment_confirmed'
            });
        }
    </script>
    {% else %}
    <!-- Fallback functions when GA is not configured -->
    <script>
        function trackQuoteStarted() { console.log('Quote started (GA not configured)'); }
        function trackQuoteSubmitted() { console.log('Quote submitted (GA not configured)'); }
        function trackAffiliateQuoteSubmitted() { console.log('Affiliate quote submitted (GA not configured)'); }
        function trackBookingConfirmed() { console.log('Booking confirmed (GA not configured)'); }
    </script>
    {% endif %}
    
    <!-- Mobile-first responsive enhancements -->
    <style>
        /* Tightened spacing - 30-40% reduction */
        .py-5 { padding-top: 2.5rem !important; padding-bottom: 2.5rem !important; }
        .py-4 { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; }
        .py-3 { padding-top: 1rem !important; padding-bottom: 1rem !important; }
        .mb-5 { margin-bottom: 1.5rem !important; }
        .mb-4 { margin-bottom: 1rem !important; }
        .mb-3 { margin-bottom: 0.75rem !important; }
        
        /* Pancake accordions with chevrons */
        .pancake-accordion {
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            margin-bottom: 0.15rem;
        }
        
        .pancake-header {
            background: #f8f9fa;
            padding: 0.25rem 0.4rem;
            cursor: pointer;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            font-size: 0.8rem;
        }
        
        .pancake-header:hover {
            background: #e9ecef;
        }
        
        .pancake-content {
            padding: 0.3rem;
            display: none;
            font-size: 0.8rem;
        }
        
        .pancake-content.show {
            display: block;
        }
        
        .pancake-chevron {
            transition: transform 0.2s ease;
        }
        
        .pancake-chevron.rotated {
            transform: rotate(180deg);
        }
        
        /* Mobile-first design - 360-414px core actions */
        @media (max-width: 414px) {
            .btn-lg {
                font-size: 1rem;
                padding: 0.75rem 1rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .hero-content {
                padding: 1.5rem !important;
            }
            
            .display-3 {
                font-size: 2rem !important;
            }
            
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .row.g-4 {
                --bs-gutter-x: 1rem;
                --bs-gutter-y: 1rem;
            }
        }
        
        /* Accessibility improvements */
        .btn:focus, .nav-link:focus, .pancake-header:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }
        
        /* Enhanced contrast ratios */
        .text-muted {
            color: #495057 !important; /* 4.5:1 contrast on white */
        }
        
        .badge {
            font-weight: 600;
        }
        
        /* Performance - lazy loading hints */
        img[data-src] {
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        img[data-src].loaded {
            opacity: 1;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Top Transparent Click-Through Announcement Banners -->
    {% if active_announcements or session.get('user_role') == 'admin' %}
    <div class="annc-wrapper">
        {% if active_announcements %}
            {% for announcement in active_announcements %}
            <div class="annc {{ announcement.style or 'info' }}">
                {{ announcement.message }}
                {% if announcement.countdown_target and not announcement.countdown_expired %}
                    <span class="countdown-timer" data-target="{{ announcement.countdown_target }}">
                        ⏰ {{ announcement.countdown_display }}
                    </span>
                {% elif announcement.countdown_expired %}
                    <span>✅ We're live!</span>
                {% endif %}
            </div>
            {% endfor %}
        {% endif %}
        
        {% if session.get('user_role') == 'admin' %}
        <!-- Admin debug badge - small, non-intrusive -->
        <div style="position:absolute;top:2px;right:10px;font-size:10px;color:#666;pointer-events:auto;">
            Announcements loaded: {{ active_announcements|length }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Bubble-inspired Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('home') }}">
                <i class="fas fa-helicopter me-2 text-primary"></i>
                <i class="fas fa-plane me-2 text-info"></i>
                SkyCareLink
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('home') }}">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('consumer_intake') }}">
                            <i class="fas fa-plus me-1"></i>New Request
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('consumer_requests') }}">
                            <i class="fas fa-clipboard-list me-1"></i>My Requests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('portal_views') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Portal
                        </a>
                    </li>
                    {% if session.get('user_role') == 'admin' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('admin_dashboard') }}">
                                <i class="fas fa-chart-line me-2"></i>Dashboard
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_affiliates') }}">
                                <i class="fas fa-users me-2"></i>Affiliates
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_analytics_affiliates') }}">
                                <i class="fas fa-chart-bar me-2"></i>Analytics
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_reset_demo') }}">
                                <i class="fas fa-tools me-2"></i>Demo Tools
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_invoices') }}">
                                <i class="fas fa-file-invoice me-2"></i>Invoices
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_announcements') }}">
                                <i class="fas fa-bullhorn me-2"></i>Announcements
                            </a></li>
                        </ul>
                    </li>
                    {% endif %}
                    {% if session.get('logged_in') %}
                        <li class="nav-item">
                            <span class="nav-link text-success">
                                <i class="fas fa-user-md me-1"></i>{{ session.get('contact_name', 'User') }}
                            </span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn btn-outline-danger rounded-pill px-3 ms-2" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">
                                <i class="fas fa-sign-in-alt me-1"></i>Login
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="joinDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-plus me-1"></i>Join
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('join_affiliate') }}">
                                    <i class="fas fa-plane me-2"></i>Join as Affiliate
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('join_hospital') }}">
                                    <i class="fas fa-hospital me-2"></i>Join as Hospital/Clinic
                                </a></li>
                                <li><a class="dropdown-item" href="/join_individual">
                                    <i class="fas fa-user me-2"></i>Join as Individual
                                </a></li>
                            </ul>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Training Mode Banner -->
    {% if session.get('training_mode') %}
    <div class="training-banner">TRAINING MODE — DUMMY DATA</div>
    {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <p class="mb-1">
                        <i class="fas fa-heart text-primary me-2"></i>
                        <strong>We prioritize your family's peace of mind</strong>
                    </p>
                    <p class="text-muted small mb-0">
                        Secure transient data handling. All information is used only for matching services and is not stored permanently.
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <p class="mb-1">
                        <i class="fas fa-shield-alt text-success me-2"></i>
                        HIPAA Compliant Demo
                    </p>
                    <p class="text-muted small mb-0">
                        No data storage • Session-based only
                    </p>
                    <div class="disclaimer mt-2">
                        SkyCareLink aggregates requests and quotes. Affiliates are solely responsible for licensing, safety, availability, and service delivery. Availability and pricing are not guaranteed.
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="fas fa-question-circle me-2"></i>How Can We Help?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6><i class="fas fa-heartbeat me-2 text-primary"></i>Medical Severity Levels</h6>
                    <ul class="list-unstyled mb-3">
                        <li><strong>Level 1:</strong> Minor conditions (sprains, stable fractures)</li>
                        <li><strong>Level 2-3:</strong> Moderate conditions requiring monitoring</li>
                        <li><strong>Level 4:</strong> Serious conditions needing ICU care</li>
                        <li><strong>Level 5:</strong> Critical patients requiring life support</li>
                    </ul>
                    
                    <h6><i class="fas fa-stethoscope me-2 text-primary"></i>Medical Equipment</h6>
                    <ul class="list-unstyled mb-3">
                        <li><strong>Ventilator:</strong> For respiratory support</li>
                        <li><strong>Oxygen:</strong> Basic breathing assistance</li>
                        <li><strong>Medical Escort:</strong> Professional supervision</li>
                        <li><strong>ECMO:</strong> Heart/lung support machine</li>
                    </ul>
                    
                    <h6><i class="fas fa-phone me-2 text-primary"></i>Need More Help?</h6>
                    <p class="text-muted">Use the chat assistant in the bottom-right corner for personalized guidance based on your situation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating AI Assistant -->
    <div class="floating-ai-assistant" id="floatingAI">
        <div class="ai-toggle-btn" onclick="toggleAIAssistant()">
            <i class="fas fa-robot"></i>
        </div>
        <div class="ai-chat-panel" id="aiChatPanel" style="display: none;">
            <div class="ai-header">
                <h6><i class="fas fa-robot me-2"></i>AI Transport Assistant</h6>
                <button class="btn-close" onclick="toggleAIAssistant()"></button>
            </div>
            <div class="ai-body">
                <input type="text" class="form-control mb-3" id="floatingAICommand" 
                       placeholder="Click below to start conversation..." style="display: none;">
                <div class="ai-welcome" id="aiWelcome">
                    <p class="text-center mb-3"><strong>Click the button below to start our conversation:</strong></p>
                    <button class="btn btn-primary w-100" onclick="sendAICommand('start')">
                        <i class="fas fa-comments me-2"></i>Start AI Assistant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Environment indicator for admins -->
    {% if session.get('user_role') == 'admin' %}
    <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">
        <span class="badge bg-{{ 'danger' if config.env == 'prod' else 'warning' }} text-dark small">
            ENV: {{ config.env|upper }}
        </span>
    </div>
    {% endif %}

    <!-- Bootstrap JS - deferred for performance -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    
    <!-- BotUI JS -->
    <script src="https://unpkg.com/vue@2/dist/vue.min.js"></script>
    <script src="https://unpkg.com/botui/build/botui.min.js"></script>
    
    <!-- Pancake Accordion Functionality -->
    <script>
        // Pancake accordion state management with session persistence
        let pancakeStates = JSON.parse(sessionStorage.getItem('pancakeStates') || '{}');
        
        function togglePancake(id) {
            const content = document.getElementById(id);
            const chevron = document.getElementById('chevron-' + id);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                chevron.classList.remove('rotated');
                header.setAttribute('aria-expanded', 'false');
                pancakeStates[id] = false;
            } else {
                content.classList.add('show');
                chevron.classList.add('rotated');
                header.setAttribute('aria-expanded', 'true');
                pancakeStates[id] = true;
            }
            
            // Persist state in session
            sessionStorage.setItem('pancakeStates', JSON.stringify(pancakeStates));
        }
        
        // Restore pancake states on page load
        document.addEventListener('DOMContentLoaded', function() {
            Object.keys(pancakeStates).forEach(id => {
                if (pancakeStates[id]) {
                    const content = document.getElementById(id);
                    const chevron = document.getElementById('chevron-' + id);
                    const header = content?.previousElementSibling;
                    
                    if (content) {
                        content.classList.add('show');
                        chevron?.classList.add('rotated');
                        header?.setAttribute('aria-expanded', 'true');
                    }
                }
            });
            
            // Add keyboard support for accordion headers
            document.querySelectorAll('.pancake-header').forEach(header => {
                header.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
            
            // Lazy load images for performance
            const images = document.querySelectorAll('img[data-src]');
            if (images.length > 0 && 'IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.add('loaded');
                            imageObserver.unobserve(img);
                        }
                    });
                });
                
                images.forEach(img => imageObserver.observe(img));
            }
        });
        
        // Enhanced form tracking for analytics
        function enhancedTrackQuoteStarted(source = 'general') {
            if (typeof trackQuoteStarted === 'function') {
                trackQuoteStarted();
            }
            console.log('Quote started from:', source);
        }
    </script>

    <!-- Site Audit UX Tightening - UI.js -->
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Floating AI Assistant Styles and Script -->
    <style>
    .floating-ai-assistant {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .ai-toggle-btn {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
        transition: all 0.3s ease;
        animation: pulse 2s infinite;
    }
    
    .ai-toggle-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0, 123, 255, 0.6);
    }
    
    .ai-chat-panel {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 300px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border: 1px solid #e9ecef;
    }
    
    .ai-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 15px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .ai-body {
        padding: 20px;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4); }
        50% { box-shadow: 0 6px 25px rgba(0, 123, 255, 0.7); }
        100% { box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4); }
    }
    </style>
    
    <script>
    function toggleAIAssistant() {
        const panel = document.getElementById('aiChatPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }
    
    // Initialize AI Assistant with conversational flow
    let aiState = {
        userType: null,
        conversationStarted: false
    };

    function sendAICommand(command) {
        // Hide welcome screen and show conversation area
        const welcomeDiv = document.getElementById('aiWelcome');
        if (welcomeDiv && !aiState.conversationStarted) {
            welcomeDiv.style.display = 'none';
            startAIConversation();
            return;
        }
        
        handleAIResponse(command);
    }

    function startAIConversation() {
        aiState.conversationStarted = true;
        const message = "Hello! I'm your SkyCareLink transport assistant. I'm here to guide you through our medical air transport services with personalized information based on your needs.\n\nTo provide the most relevant assistance, could you please tell me which category best describes you?\n\n• Individual/Family Member - Seeking transport for a loved one\n• Hospital/Clinic - Medical facility needing transport coordination\n• Affiliate Provider - Transport company interested in partnership\n\nPlease select your category to continue.";
        
        // Create uniform sized buttons for user types
        const panel = document.getElementById('aiChatPanel');
        if (panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'block';
        }
        
        let chatArea = document.getElementById('aiChatArea');
        if (!chatArea) {
            chatArea = document.createElement('div');
            chatArea.id = 'aiChatArea';
            chatArea.style.cssText = 'max-height: 250px; overflow-y: auto; padding: 8px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ddd;';
            const aiBody = panel.querySelector('.ai-body');
            if (aiBody) {
                aiBody.insertBefore(chatArea, aiBody.firstChild);
            }
        }
        
        chatArea.innerHTML = '';
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message';
        messageDiv.style.cssText = 'background: #f8f9fa; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #007bff;';
        messageDiv.innerHTML = `<div style="color: #0056b3; font-weight: bold; margin-bottom: 3px; font-size: 0.65rem;">SkyCareLink Assistant</div><div class="ai-message-text" style="line-height: 1.2; white-space: pre-line; font-size: 0.6rem;">${message}</div>`;
        chatArea.appendChild(messageDiv);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.style.cssText = 'margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;';
        
        const buttonOptions = [
            { text: 'Individual/<br>Family', value: 'Individual/Family Member' },
            { text: 'Hospital/<br>Clinic', value: 'Hospital/Clinic' },
            { text: 'Affiliate<br>Provider', value: 'Affiliate Provider' }
        ];
        
        buttonOptions.forEach(option => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary';
            button.style.cssText = 'font-size: 0.5rem; padding: 3px 1px; height: 32px; line-height: 0.9; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 500;';
            button.innerHTML = option.text;
            button.onclick = () => handleAIResponse(option.value);
            optionsDiv.appendChild(button);
        });
        
        chatArea.appendChild(optionsDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function handleAIResponse(command) {
        // Handle user type selection
        if (!aiState.userType) {
            aiState.userType = command;
            showUserTypeQuestions(command);
            return;
        }
        
        // Handle specific questions based on user type
        const responses = getResponsesForUserType(aiState.userType);
        const response = responses[command];
        
        // Debug logging
        console.log("AI Debug - User Type:", aiState.userType);
        console.log("AI Debug - Command:", command);
        console.log("AI Debug - Response Found:", response ? "YES" : "NO");
        
        if (response && response !== "conversation_restart") {
            // Show question first, then response below
            showSelectedQuestion(command);
            showAIResponse(response, [], true);
        } else if (response === "conversation_restart") {
            aiState = { userType: null, conversationStarted: false };
            startAIConversation();
        } else {
            console.log("AI Debug - No response found, showing fallback");
            showAIResponse('I can help with any questions about SkyCareLink transport services. Please select from the options below:', getQuestionsForUserType(aiState.userType));
        }
    }

    function showUserTypeQuestions(userType) {
        const questions = getQuestionsForUserType(userType);
        const welcomeMessages = {
            'Individual/Family Member': `I understand you're seeking transport for a loved one during what may be a difficult time. I'm here to guide you through this process with compassion and clarity.

Medical air transport can feel overwhelming, but I'll help you understand what to expect, what information you'll need, and how to prepare for this journey.`,
            'Hospital/Clinic': `Welcome! I'm here to assist with your medical transport coordination needs. Whether you're arranging critical transfers, scheduled transports, or need information about our partnership program, I can provide detailed operational guidance.`,
            'Affiliate Provider': `Thank you for your interest in partnering with SkyCareLink. I can provide comprehensive information about our affiliate program, commission structure, operational requirements, and partnership benefits.`
        };
        
        // Clear previous content and show focused view
        const chatArea = document.getElementById('aiChatArea');
        if (chatArea) {
            chatArea.innerHTML = '';
        }
        
        showAIResponse(welcomeMessages[userType], questions, true);
    }

    function getQuestionsForUserType(userType) {
        const questionSets = {
            'Individual/Family Member': [
                'What should I expect during the transport process?',
                'What information do I need to provide?',
                'Can family members travel with the patient?',
                'How much will this cost and what payment options are available?',
                'What happens if we need to cancel?',
                'How quickly can transport be arranged?',
                'What medical equipment is available?',
                'How do I prepare my loved one for transport?'
            ],
            'Hospital/Clinic': [
                'How do I join the SkyCareLink network?',
                'What are the referral commission rates?',
                'How does the quote distribution system work?',
                'What documentation is required for transfers?',
                'How are invoices generated and payments processed?',
                'What transport types and equipment are available?',
                'How do I track patient transfers?',
                'What are the quality assurance standards?'
            ],
            'Affiliate Provider': [
                'How do I become a SkyCareLink affiliate?',
                'What are the commission rates and payment terms?',
                'How does the fair quote distribution system work?',
                'What are the operational requirements?',
                'How do priority partnerships work?',
                'What insurance and certification requirements exist?',
                'How are disputes and quality issues handled?',
                'What marketing support is provided?'
            ]
        };
        
        return questionSets[userType] || [];
    }

    function getResponsesForUserType(userType) {
        const responses = {};
        
        if (userType === "Individual/Family Member") {
            responses["What should I expect during the transport process?"] = "The transport process includes: 1) Complete our 5-step intake form (5-10 minutes), 2) Receive quotes from certified providers (15-30 minutes), 3) Select your preferred provider, 4) Pre-transport preparation with medical team coordination (1-2 hours), 5) Transport day with professional medical crew. You will receive regular updates throughout the process.";
            responses["What information do I need to provide?"] = "Please have ready: Patient information (name, age, medical condition, severity level), location details (pickup and destination hospitals), family seating needs (up to 3 seats at $1,200 per seat), and insurance/payment information. Our hospital autofill helps with major medical centers.";
            responses["Can family members travel with the patient?"] = "Yes! Family seating is available at industry-standard rate of $1,200 per seat. Large jets support up to 3 family seats, mid-size jets support 1-2 seats, and helicopters cannot accommodate family due to space constraints. Family presence provides important emotional support.";
            responses["How much will this cost and what payment options are available?"] = "Transport costs range from $20,000-$72,000 depending on distance, aircraft type, and medical needs. Additional costs: Family seating ($1,200 per seat), same-day transport (20% surcharge). Payment options include insurance coverage, CareCredit financing, payment plans, and direct payment. First quote is always free.";
            responses["What happens if we need to cancel?"] = "Cancellation policies vary by timing: 24+ hours before (full or partial refunds possible), less than 24 hours (30-50% fees typical), day of transport (significant penalties apply). Special circumstances like patient death or weather are handled compassionately. All refunds processed directly with the affiliate provider.";
            responses["How quickly can transport be arranged?"] = "Same-day transport available 24/7 for critical cases (2-4 hour response, 20% surcharge). Scheduled transport recommended 12-48 hours advance (better pricing and options). Level 3 critical patients receive priority scheduling.";
            responses["What medical equipment is available?"] = "Equipment varies by severity: Level 1 (basic monitoring, oxygen), Level 2 (advanced monitoring, ventilators), Level 3 (ECMO, advanced life support, NICU equipment). All transports include certified medical staff. Equipment automatically recommended based on your severity selection.";
            responses["How do I prepare my loved one for transport?"] = "Preparation includes: Medical (gather medications, records, clearance), Personal (pack essentials, comfort items), Communication (explain process to patient), Family coordination (arrange airport transportation), Documentation (insurance cards, emergency contacts). Our medical team handles all clinical aspects during transport.";
        } else if (userType === "Hospital/Clinic") {
            responses["How do I join the SkyCareLink network?"] = "Network membership requires: licensed healthcare facility, current malpractice insurance, EMR system, dedicated transport coordinator. Application process takes 4 weeks: initial application, verification, integration setup, activation. Benefits include access to certified providers, commission earnings, and streamlined coordination.";
            responses["What are the referral commission rates?"] = "Commission structure: 4% standard rate, 5% premium rate (25+ referrals/quarter), volume bonuses available. Monthly ACH payments, Net 30 terms, detailed reporting provided. Quality bonuses available for high satisfaction scores. Real-time tracking in partner dashboard.";
            responses["How does the quote distribution system work?"] = "Fair distribution system prioritizes: geographic proximity, capability matching, response history, quality metrics. Standard quotes have 6-hour response window, urgent cases 2-hour window. Maximum 6 quotes per request to prevent overwhelm. Performance-based adjustments ensure quality providers get more opportunities.";
            responses["What documentation is required for transfers?"] = "Required documentation includes: Complete medical history and physical exam (within 48 hours), current medications list, diagnostic results from past 72 hours, physician transfer orders with medical necessity, receiving facility acceptance confirmation, insurance pre-authorization, HIPAA authorization, and EMTALA compliance documentation. Our platform streamlines this process with automated workflows.";
            responses["How are invoices generated and payments processed?"] = "Automated monthly invoices generated on the 1st with detailed case-by-case breakdown. Commission payments processed via ACH on the 15th (Net 30 terms). Real-time tracking available in partner dashboard. Annual 1099 tax reporting provided. International wire transfers available for international partners.";
            responses["What transport types and equipment are available?"] = "Complete transport capabilities: Heavy jets (1000+ miles, full ICU), mid-size jets (500-1000 miles, advanced life support), light aircraft (under 500 miles), helicopters (emergency response under 150 miles). Medical equipment levels: Level 1 (basic monitoring), Level 2 (advanced monitoring, ventilators), Level 3 (ECMO, CRRT, IABP). Specialized services: neonatal, pediatric, cardiac, organ transport.";
            responses["How do I track patient transfers?"] = "Real-time tracking through partner portal: Live flight tracking with GPS coordinates, crew communication updates, departure/arrival notifications, patient status reports during transport, destination facility handoff confirmation. Mobile app and SMS notifications available. Family communication coordination included.";
            responses["What are the quality assurance standards?"] = "Comprehensive quality program: All providers maintain DOT Part 135 certificates, minimum $10M liability insurance, certified medical crews with ongoing training, regular safety audits, patient satisfaction tracking (target 95%+), outcome monitoring, 24/7 medical direction, HIPAA compliance verification, and continuous improvement protocols.";
        } else if (userType === "Affiliate Provider") {
            responses["How do I become a SkyCareLink affiliate?"] = "Requirements include: DOT Part 135 certificate, $10M liability insurance, certified medical crews, exemplary safety record. 4-week application process with operational assessment. Benefits: steady referral stream, fair quote distribution, 24/7 dispatch support, professional network access.";
            responses["What are the commission rates and payment terms?"] = "Affiliates set pricing within $20k-$72k range. SkyCareLink takes 15% platform fee. Net 15 payment processing. Volume incentives: 15% standard (1-25 transports), 12% premium (26-50), 10% elite (51+). Quality bonuses for 98%+ satisfaction scores.";
            responses["How does the fair quote distribution system work?"] = "Equitable system based on: geographic proximity, capability matching, response history, quality scores. Round-robin distribution prevents single provider dominance. 90-day support for new providers. Performance transparency through individual dashboards and benchmarking.";
            responses["What are the operational requirements?"] = "24/7 dispatch capability, geographic coverage area definition, medical equipment inventory matching service commitments, real-time tracking systems, crew qualification maintenance, backup aircraft arrangements, FAA-approved maintenance schedules, communication systems integration, and quality reporting capabilities.";
            responses["How do priority partnerships work?"] = "Priority partners receive enhanced quote distribution visibility, reduced platform fees (10% vs standard 15%), dedicated account management, co-branded marketing materials, priority customer support, quarterly performance reviews, and expansion support. Requirements: 100+ annual transports, 98%+ satisfaction scores, zero safety incidents.";
            responses["What insurance and certification requirements exist?"] = "Required coverage: $10M liability insurance, $1M per occurrence, hull insurance for aircraft value, crew life insurance. Certifications needed: DOT Part 135 operating certificate, flight crew medical certifications, aircraft airworthiness certificates, medical equipment certifications, HIPAA compliance certification, state operating permits.";
            responses["How are disputes and quality issues handled?"] = "Structured resolution process: 24-hour acknowledgment for all issues, dedicated quality assurance team review, patient safety priority protocols, documentation requirements, escalation procedures to management, mediation services available, performance improvement plans when needed, and transparent communication throughout resolution.";
            responses["What marketing support is provided?"] = "Comprehensive support package: Co-branded marketing materials, website integration assistance, referral network introductions, trade show participation opportunities, case study development, testimonial coordination, digital marketing support, local market analysis, competitive positioning guidance, and lead generation assistance.";
        }
        
        responses["Start Over"] = "conversation_restart";
        return responses;
    }

    function showAIResponse(message, options = [], isNewSection = false) {
        console.log("AI Debug - showAIResponse called with message:", message ? "YES" : "NO");
        console.log("AI Debug - Message length:", message ? message.length : 0);
        console.log("AI Debug - Options count:", options.length);
        
        const panel = document.getElementById('aiChatPanel');
        if (panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'block';
        }
        
        // Create or update chat area
        let chatArea = document.getElementById('aiChatArea');
        if (!chatArea) {
            chatArea = document.createElement('div');
            chatArea.id = 'aiChatArea';
            chatArea.style.cssText = 'max-height: 250px; overflow-y: auto; padding: 8px; background: white; border-radius: 6px; margin-bottom: 8px; border: 1px solid #ddd;';
            const aiBody = panel.querySelector('.ai-body');
            if (aiBody) {
                aiBody.insertBefore(chatArea, aiBody.firstChild);
            }
        }
        
        // Add response message with smaller text
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message';
        messageDiv.style.cssText = 'background: #f8f9fa; padding: 6px; border-radius: 4px; margin-bottom: 6px; border-left: 2px solid #007bff;';
        messageDiv.innerHTML = `<div style="color: #0056b3; font-weight: bold; margin-bottom: 3px; font-size: 0.65rem;">SkyCareLink Assistant</div><div class="ai-message-text" style="line-height: 1.2; white-space: pre-line; font-size: 0.6rem;">${message || 'No message provided'}</div>`;
        
        chatArea.appendChild(messageDiv);
        
        // Add option buttons if provided (remove Start Over from question lists)
        if (options.length > 0) {
            const optionsDiv = document.createElement('div');
            optionsDiv.style.cssText = 'margin-top: 10px; margin-bottom: 8px;';
            
            options.forEach(option => {
                // Skip "Start Over" button in question lists since we have floating controls
                if (option === 'Start Over') return;
                
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary me-2 mb-2';
                button.style.cssText = 'font-size: 0.6rem; padding: 3px 6px; min-height: 24px; min-width: 100px;';
                button.textContent = option;
                button.onclick = () => {
                    handleAIResponse(option);
                };
                optionsDiv.appendChild(button);
            });
            
            chatArea.appendChild(optionsDiv);
        }
        
        // Add floating navigation controls - only one set at bottom, remove any existing first
        if (isNewSection && aiState.userType) {
            // Remove any existing floating controls
            const existingControls = chatArea.querySelector('.floating-navigation-controls');
            if (existingControls) {
                existingControls.remove();
            }
            
            const floatingControls = document.createElement('div');
            floatingControls.className = 'floating-navigation-controls';
            floatingControls.style.cssText = 'position: sticky; bottom: 0; background: #fff; padding: 6px 0; border-top: 1px solid #eee; margin-top: 6px; text-align: center;';
            floatingControls.innerHTML = `
                <button class="btn btn-outline-secondary btn-sm me-2" onclick="goBackInConversation();" style="font-size: 0.6rem; padding: 3px 6px;"><i class="fas fa-arrow-left me-1"></i>Go Back</button>
                <button class="btn btn-secondary btn-sm" onclick="aiState = { userType: null, conversationStarted: false }; startAIConversation();" style="font-size: 0.6rem; padding: 3px 6px;"><i class="fas fa-redo me-1"></i>Start Over</button>
            `;
            chatArea.appendChild(floatingControls);
        }
        
        // Scroll to bottom
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    

    
    // Go back function - always go back to initial screen
    function goBackInConversation() {
        aiState = { userType: null, conversationStarted: false };
        startAIConversation();
    }
    
    // Show selected question function
    function showSelectedQuestion(question) {
        const chatArea = document.getElementById('aiChatArea');
        if (chatArea) {
            const questionDiv = document.createElement('div');
            questionDiv.style.cssText = 'background: #e3f2fd; padding: 4px; border-radius: 4px; margin-bottom: 4px; border-left: 2px solid #2196f3;';
            questionDiv.innerHTML = `<div style="color: #1976d2; font-weight: bold; font-size: 0.6rem;">${question}</div>`;
            chatArea.appendChild(questionDiv);
        }
    }
    
    // Live countdown updates for announcement banners
    function updateCountdowns() {
        document.querySelectorAll('.countdown-timer').forEach(timer => {
            const target = timer.getAttribute('data-target');
            if (!target) return;
            
            const targetTime = new Date(target);
            const now = new Date();
            const diff = targetTime - now;
            
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                timer.innerHTML = `<i class="fas fa-clock me-1"></i>${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            } else {
                timer.innerHTML = `<i class="fas fa-check me-1"></i>We're live!`;
                timer.classList.add('text-success');
            }
        });
    }
    
    // Update countdowns every 60 seconds and on page load
    setInterval(updateCountdowns, 60000);
    document.addEventListener('DOMContentLoaded', updateCountdowns);
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
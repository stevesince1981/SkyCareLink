<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MediFly Consumer - Get Your Loved One Home Safely{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- BotUI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/botui/build/botui.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='consumer_css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='consumer_static/css/main.css') }}">
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- Top Transparent Click-Through Announcement Banners -->
    {% if active_announcements or session.get('user_role') == 'admin' %}
    <div class="annc-wrapper">
        {% if active_announcements %}
            {% for announcement in active_announcements %}
            <div class="annc {{ announcement.style or 'info' }}">
                {{ announcement.message }}
                {% if announcement.countdown_target and not announcement.countdown_expired %}
                    <span class="countdown-timer" data-target="{{ announcement.countdown_target }}">
                        ⏰ {{ announcement.countdown_display }}
                    </span>
                {% elif announcement.countdown_expired %}
                    <span>✅ We're live!</span>
                {% endif %}
            </div>
            {% endfor %}
        {% endif %}
        
        {% if session.get('user_role') == 'admin' %}
        <!-- Admin debug badge - small, non-intrusive -->
        <div style="position:absolute;top:2px;right:10px;font-size:10px;color:#666;pointer-events:auto;">
            Announcements loaded: {{ active_announcements|length }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Bubble-inspired Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('home') }}">
                <i class="fas fa-helicopter me-2 text-primary"></i>
                <i class="fas fa-plane me-2 text-info"></i>
                MediFly
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('home') }}">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('consumer_intake') }}">
                            <i class="fas fa-plus me-1"></i>New Request
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('consumer_requests') }}">
                            <i class="fas fa-clipboard-list me-1"></i>My Requests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('portal_views') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Portal
                        </a>
                    </li>
                    {% if session.get('user_role') == 'admin' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('admin_dashboard') }}">
                                <i class="fas fa-chart-line me-2"></i>Dashboard
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_affiliates') }}">
                                <i class="fas fa-users me-2"></i>Affiliates
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_analytics_affiliates') }}">
                                <i class="fas fa-chart-bar me-2"></i>Analytics
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_reset_demo') }}">
                                <i class="fas fa-tools me-2"></i>Demo Tools
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_invoices') }}">
                                <i class="fas fa-file-invoice me-2"></i>Invoices
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin_announcements') }}">
                                <i class="fas fa-bullhorn me-2"></i>Announcements
                            </a></li>
                        </ul>
                    </li>
                    {% endif %}
                    {% if session.get('logged_in') %}
                        <li class="nav-item">
                            <span class="nav-link text-success">
                                <i class="fas fa-user-md me-1"></i>{{ session.get('contact_name', 'User') }}
                            </span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn btn-outline-danger rounded-pill px-3 ms-2" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">
                                <i class="fas fa-sign-in-alt me-1"></i>Login
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="joinDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-plus me-1"></i>Join
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('join_affiliate') }}">
                                    <i class="fas fa-plane me-2"></i>Join as Affiliate
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('join_hospital') }}">
                                    <i class="fas fa-hospital me-2"></i>Join as Hospital/Clinic
                                </a></li>
                                <li><a class="dropdown-item" href="/join_individual">
                                    <i class="fas fa-user me-2"></i>Join as Individual
                                </a></li>
                            </ul>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Training Mode Banner -->
    {% if session.get('training_mode') %}
    <div class="training-banner">TRAINING MODE — DUMMY DATA</div>
    {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <p class="mb-1">
                        <i class="fas fa-heart text-primary me-2"></i>
                        <strong>We prioritize your family's peace of mind</strong>
                    </p>
                    <p class="text-muted small mb-0">
                        Secure transient data handling. All information is used only for matching services and is not stored permanently.
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <p class="mb-1">
                        <i class="fas fa-shield-alt text-success me-2"></i>
                        HIPAA Compliant Demo
                    </p>
                    <p class="text-muted small mb-0">
                        No data storage • Session-based only
                    </p>
                    <div class="disclaimer mt-2">
                        MediFly aggregates requests and quotes. Affiliates are solely responsible for licensing, safety, availability, and service delivery. Availability and pricing are not guaranteed.
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="fas fa-question-circle me-2"></i>How Can We Help?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6><i class="fas fa-heartbeat me-2 text-primary"></i>Medical Severity Levels</h6>
                    <ul class="list-unstyled mb-3">
                        <li><strong>Level 1:</strong> Minor conditions (sprains, stable fractures)</li>
                        <li><strong>Level 2-3:</strong> Moderate conditions requiring monitoring</li>
                        <li><strong>Level 4:</strong> Serious conditions needing ICU care</li>
                        <li><strong>Level 5:</strong> Critical patients requiring life support</li>
                    </ul>
                    
                    <h6><i class="fas fa-stethoscope me-2 text-primary"></i>Medical Equipment</h6>
                    <ul class="list-unstyled mb-3">
                        <li><strong>Ventilator:</strong> For respiratory support</li>
                        <li><strong>Oxygen:</strong> Basic breathing assistance</li>
                        <li><strong>Medical Escort:</strong> Professional supervision</li>
                        <li><strong>ECMO:</strong> Heart/lung support machine</li>
                    </ul>
                    
                    <h6><i class="fas fa-phone me-2 text-primary"></i>Need More Help?</h6>
                    <p class="text-muted">Use the chat assistant in the bottom-right corner for personalized guidance based on your situation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating AI Assistant -->
    <div class="floating-ai-assistant" id="floatingAI">
        <div class="ai-toggle-btn" onclick="toggleAIAssistant()">
            <i class="fas fa-robot"></i>
        </div>
        <div class="ai-chat-panel" id="aiChatPanel" style="display: none;">
            <div class="ai-header">
                <h6><i class="fas fa-robot me-2"></i>AI Transport Assistant</h6>
                <button class="btn-close" onclick="toggleAIAssistant()"></button>
            </div>
            <div class="ai-body">
                <input type="text" class="form-control mb-3" id="floatingAICommand" 
                       placeholder="Click below to start conversation..." style="display: none;">
                <div class="ai-welcome" id="aiWelcome">
                    <p class="text-center mb-3"><strong>Click the button below to start our conversation:</strong></p>
                    <button class="btn btn-primary w-100" onclick="sendAICommand('start')">
                        <i class="fas fa-comments me-2"></i>Start AI Assistant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Environment indicator for admins -->
    {% if session.get('user_role') == 'admin' %}
    <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">
        <span class="badge bg-{{ 'danger' if config.env == 'prod' else 'warning' }} text-dark small">
            ENV: {{ config.env|upper }}
        </span>
    </div>
    {% endif %}

    <!-- Bootstrap JS - deferred for performance -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    
    <!-- BotUI JS -->
    <script src="https://unpkg.com/vue@2/dist/vue.min.js"></script>
    <script src="https://unpkg.com/botui/build/botui.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Floating AI Assistant Styles and Script -->
    <style>
    .floating-ai-assistant {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    .ai-toggle-btn {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
        transition: all 0.3s ease;
        animation: pulse 2s infinite;
    }
    
    .ai-toggle-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0, 123, 255, 0.6);
    }
    
    .ai-chat-panel {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 300px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border: 1px solid #e9ecef;
    }
    
    .ai-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 15px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .ai-body {
        padding: 20px;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4); }
        50% { box-shadow: 0 6px 25px rgba(0, 123, 255, 0.7); }
        100% { box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4); }
    }
    </style>
    
    <script>
    function toggleAIAssistant() {
        const panel = document.getElementById('aiChatPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }
    
    // Initialize AI Assistant with conversational flow
    let aiState = {
        userType: null,
        conversationStarted: false
    };

    function sendAICommand(command) {
        // Hide welcome screen and show conversation area
        const welcomeDiv = document.getElementById('aiWelcome');
        if (welcomeDiv && !aiState.conversationStarted) {
            welcomeDiv.style.display = 'none';
            startAIConversation();
            return;
        }
        
        handleAIResponse(command);
    }

    function startAIConversation() {
        aiState.conversationStarted = true;
        const message = `Hello! I'm your MediFly transport assistant. I'm here to guide you through our medical air transport services with personalized information based on your needs.

To provide the most relevant assistance, could you please tell me which category best describes you?

• Individual/Family Member - Seeking transport for a loved one
• Hospital/Clinic - Medical facility needing transport coordination  
• Affiliate Provider - Transport company interested in partnership

Please select your category to continue.`;
        
        showAIResponse(message, [
            'Individual/Family Member',
            'Hospital/Clinic', 
            'Affiliate Provider'
        ]);
    }

    function handleAIResponse(command) {
        // Handle user type selection
        if (!aiState.userType) {
            aiState.userType = command;
            showUserTypeQuestions(command);
            return;
        }
        
        // Handle specific questions based on user type
        const responses = getResponsesForUserType(aiState.userType);
        const response = responses[command];
        
        if (response) {
            showAIResponse(response, getQuestionsForUserType(aiState.userType));
        } else {
            showAIResponse('I can help with any questions about MediFly transport services. Please select from the options below:', getQuestionsForUserType(aiState.userType));
        }
    }

    function showUserTypeQuestions(userType) {
        const questions = getQuestionsForUserType(userType);
        const welcomeMessages = {
            'Individual/Family Member': `I understand you're seeking transport for a loved one during what may be a difficult time. I'm here to guide you through this process with compassion and clarity.

Medical air transport can feel overwhelming, but I'll help you understand what to expect, what information you'll need, and how to prepare for this journey.`,
            'Hospital/Clinic': `Welcome! I'm here to assist with your medical transport coordination needs. Whether you're arranging critical transfers, scheduled transports, or need information about our partnership program, I can provide detailed operational guidance.`,
            'Affiliate Provider': `Thank you for your interest in partnering with MediFly. I can provide comprehensive information about our affiliate program, commission structure, operational requirements, and partnership benefits.`
        };
        
        showAIResponse(welcomeMessages[userType], questions);
    }

    function getQuestionsForUserType(userType) {
        const questionSets = {
            'Individual/Family Member': [
                'What should I expect during the transport process?',
                'What information do I need to provide?',
                'Can family members travel with the patient?',
                'How much will this cost and what payment options are available?',
                'What happens if we need to cancel?',
                'How quickly can transport be arranged?',
                'What medical equipment is available?',
                'How do I prepare my loved one for transport?',
                'Start Over'
            ],
            'Hospital/Clinic': [
                'How do I join the MediFly network?',
                'What are the referral commission rates?',
                'How does the quote distribution system work?',
                'What documentation is required for transfers?',
                'How are invoices generated and payments processed?',
                'What transport types and equipment are available?',
                'How do I track patient transfers?',
                'What are the quality assurance standards?',
                'Start Over'
            ],
            'Affiliate Provider': [
                'How do I become a MediFly affiliate?',
                'What are the commission rates and payment terms?',
                'How does the fair quote distribution system work?',
                'What are the operational requirements?',
                'How do priority partnerships work?',
                'What insurance and certification requirements exist?',
                'How are disputes and quality issues handled?',
                'What marketing support is provided?',
                'Start Over'
            ]
        };
        
        return questionSets[userType] || [];
    }

    function getResponsesForUserType(userType) {
        const responseSets = {
            'Individual/Family Member': {
                'What should I expect during the transport process?': `The medical transport process typically unfolds in these stages:

**Initial Request (5-10 minutes):** Complete our guided intake form with patient information, medical needs, and destination details.

**Quote Generation (15-30 minutes):** Receive multiple quotes from certified providers with aircraft details, pricing, and estimated arrival times.

**Provider Selection:** Choose your preferred provider based on cost, timing, and aircraft capabilities.

**Pre-Transport Preparation (1-2 hours):** Medical team coordinates with current providers, reviews patient status, and prepares necessary equipment.

**Transport Day:** Professional medical crew arrives, conducts patient assessment, manages all medical care during flight, and ensures smooth handoff at destination.

Throughout this process, you'll receive regular updates and have direct communication with the medical team.`,

                'What information do I need to provide?': `To ensure the best possible care and accurate quotes, please have this information ready:

**Patient Information:**
• Full name, age, and medical record number
• Current medical condition and severity level
• Required medical equipment (ventilator, ECMO, etc.)
• Mobility status and special accommodations needed

**Location Details:**
• Pick-up hospital/facility (we have autofill for major centers)
• Destination hospital/facility
• Preferred transport timing

**Family Information:**
• Number of family members traveling (up to 3 seats available, $1,200 per seat)
• Emergency contact information

**Insurance/Payment:**
• Insurance carrier and policy information
• Preferred payment method for any out-of-pocket costs

Having this information ready will streamline the process and ensure accurate quotes.`,

                'Can family members travel with the patient?': `Yes, family support during medical transport is important for patient comfort and care continuity.

**Family Seating Options:**
• Up to 3 additional seats available (aircraft dependent)
• Industry-standard rate: $1,200 per family seat
• Helicopter aircraft cannot accommodate family members due to space constraints

**Aircraft Capacity:**
• Large jets (Learjet 60, King Air 350): Up to 3 family seats
• Mid-size jets (Citation X, Hawker 400XP): Up to 2 family seats  
• Light aircraft (Beechcraft 1900, Cessna Citation): 1 family seat
• Helicopters (MD 902, Bell 429): No family seating available

**What's Included:**
• Safety briefing and equipment
• Meal service during long flights
• Communication with medical team
• Assistance with logistics at both endpoints

Family presence often provides emotional support that aids in the patient's recovery process.`,

                'How much will this cost and what payment options are available?': `Medical air transport costs vary based on distance, aircraft type, medical complexity, and timing:

**Typical Cost Range:** $20,000 - $72,000
**Additional Costs:**
• Family seating: $1,200 per seat
• Same-day transport: 20% urgency surcharge
• Specialized equipment: Varies by complexity

**Payment Options:**
• Insurance coverage (we work with most major carriers)
• CareCredit financing for qualified families
• Payment plans available for approved applications
• Direct payment via credit card or bank transfer

**Cost Factors:**
• Flight distance and aircraft requirements
• Medical equipment and staffing needs
• Transport urgency (scheduled vs. same-day)
• Destination airport accessibility

**First Quote Always Free:** No cost for initial assessment and quote. Additional quotes require account verification for quality assurance.

Our team can work with your insurance provider to maximize coverage and minimize out-of-pocket expenses.`,

                'What happens if we need to cancel?': `We understand medical situations can change rapidly. Our cancellation policy is designed to be fair while protecting against operational costs:

**24+ Hours Before Transport:**
• Most affiliates offer full or partial refunds
• Cancellation policies vary by provider
• Administrative fees may apply ($200-500 typical)

**Less Than 24 Hours:**
• Cancellation fees typically apply (30-50% of transport cost)
• Crew and aircraft positioning costs may be charged
• Insurance may cover some cancellation costs

**Day of Transport:**
• Significant penalties apply due to operational commitments
• Full costs may be charged once crew dispatch begins
• Emergency medical changes may qualify for exceptions

**Special Circumstances:**
• Patient death: Handled directly with affiliate provider, most offer compassionate refund policies
• Medical contraindications: Subject to provider assessment
• Weather cancellations: No patient charges, rescheduling priority

**Important:** All cancellations and refunds are processed directly with the affiliate provider, not MediFly. We recommend reviewing specific terms when selecting your provider.`,

                'How quickly can transport be arranged?': `Transport timing depends on several factors, but we prioritize urgent medical needs:

**Same-Day Transport (Critical Cases):**
• Available 24/7 for life-threatening situations
• Typical response: 2-4 hours from request to departure
• 20% urgency surcharge applies
• Helicopter options for nearby destinations (under 150 miles)

**Scheduled Transport (Non-Critical):**
• 12-48 hours advance booking recommended
• More provider options and competitive pricing
• Better aircraft selection and family seating availability
• Coordination with receiving facility schedules

**Factors Affecting Timing:**
• Aircraft and crew availability in your region
• Weather conditions and airport operations
• Patient medical stability and clearance requirements
• Receiving facility bed availability and acceptance

**Emergency Coordination:**
• Direct communication with your medical team
• Real-time updates on aircraft positioning
• Continuous monitoring of patient status
• Backup options if primary transport encounters issues

**Level 3 (Critical) patients typically receive priority scheduling, while Level 1 (stable) patients have more flexible timing options.`',

                'What medical equipment is available?': `Our affiliate network maintains comprehensive medical equipment to handle all levels of patient acuity:

**Level 1 (Low Severity) - Standard Equipment:**
• Basic cardiac monitoring
• Oxygen delivery systems
• Standard stretcher with restraints
• Basic IV capabilities
• Blood pressure monitoring

**Level 2 (Medium Severity) - Enhanced Monitoring:**
• Advanced cardiac monitoring with telemetry
• Ventilator support capabilities
• Multiple IV pump systems
• Arterial line monitoring
• Defibrillation equipment

**Level 3 (High Severity) - Critical Care:**
• ECMO (Extracorporeal Membrane Oxygenation)
• Advanced ventilator systems with PEEP
• Continuous renal replacement therapy (CRRT)
• Intraaortic balloon pump support
• Neonatal intensive care setups
• Specialized pediatric equipment

**Custom Equipment:**
• Special medical devices can be accommodated with advance notice
• Coordination with equipment manufacturers
• Additional costs may apply for specialized items

**Medical Staffing:**
• All transports include certified flight nurses
• Critical cases include flight physicians
• Pediatric specialists available for children
• NICU teams for neonatal transports

Equipment selection is automatically recommended based on your selected severity level, with options to add or modify based on specific patient needs.`,

                'How do I prepare my loved one for transport?': `Proper preparation can help reduce stress and ensure a smooth transport experience:

**Medical Preparation:**
• Ensure all current medications are documented and available
• Gather recent test results, imaging studies, and medical records
• Confirm patient has been medically cleared for transport by attending physician
• Complete any required pre-transport medical procedures

**Personal Preparation:**
• Pack essential personal items in a small bag (space is limited)
• Include comfort items like photos or small personal objects
• Prepare any religious or cultural items that provide comfort
• Ensure patient is wearing appropriate hospital clothing

**Communication:**
• Explain the process to your loved one if they're conscious and alert
• Reassure them about the medical team's expertise and care
• Discuss the flight duration and what to expect
• Share information about the destination facility and care team

**Family Coordination:**
• Arrange transportation to departure and arrival airports
• Coordinate with destination hospital for admission procedures
• Ensure someone will be available to receive patient at destination
• Plan accommodation if family members are traveling

**Documentation:**
• Bring copies of insurance cards and identification
• Have emergency contact information readily available
• Prepare advance directive or power of attorney documents if applicable

**Emotional Support:**
• This process can be overwhelming - that's completely normal
• Stay in communication with our coordination team throughout
• Focus on the positive step of getting your loved one the best possible care
• Remember that our medical teams are highly experienced in providing compassionate care during transport

The flight medical team will handle all clinical aspects, allowing you to focus on emotional support and coordination.`',

                'Start Over': 'conversation_restart'
            },
            
            'Hospital/Clinic': {
                'How do I join the MediFly network?': `Joining the MediFly network creates new revenue opportunities while enhancing patient care options:

**Eligibility Requirements:**
• Licensed healthcare facility with medical transport needs
• Current malpractice insurance and facility accreditation
• Electronic medical records system for case coordination
• Dedicated transport coordination staff member

**Application Process:**
1. **Initial Application:** Complete online partner application with facility credentials
2. **Verification:** Document review and license validation (5-7 business days)
3. **Integration Setup:** Platform training and system integration (1-2 weeks)
4. **Activation:** Begin receiving referral commissions and coordinating transports

**Network Benefits:**
• Access to vetted, certified transport providers nationwide
• Streamlined quote comparison and selection process
• Real-time tracking and communication systems
• Commission earnings on successful referrals

**Training and Support:**
• Comprehensive platform training for staff
• 24/7 coordination support for urgent cases
• Regular network updates and best practice sharing
• Dedicated account management team

**Quality Assurance:**
• All transport providers meet strict certification standards
• Regular performance monitoring and patient outcome tracking
• Feedback integration for continuous improvement
• Compliance with HIPAA and medical transport regulations

Partner facilities typically see increased patient satisfaction scores and expanded referral network capabilities within the first quarter of membership.`,

                'What are the referral commission rates?': `Our commission structure rewards facilities for expanding patient access to quality transport services:

**Commission Tiers:**
• **Standard Rate:** 4% of completed transport revenue
• **Premium Rate:** 5% for facilities exceeding 25 referrals per quarter
• **Volume Bonuses:** Additional 1% for facilities exceeding 100 annual referrals

**Payment Structure:**
• Monthly commission payments via ACH transfer
• Detailed commission reports with individual case tracking
• Net 30 payment terms from completed transport
• Quarterly performance bonuses for quality metrics

**Qualifying Transports:**
• All successfully completed air medical transports
• Ground transport coordination (reduced rate: 2%)
• International medical repatriation services
• Scheduled and emergency transport categories

**Commission Calculation Examples:**
• $50,000 transport at 4% = $2,000 commission
• $30,000 transport at 5% (premium tier) = $1,500 commission
• Volume bonus: Additional $500-1,500 quarterly

**Quality-Based Adjustments:**
• Patient satisfaction scores above 95%: Bonus 0.5%
• Zero quality incidents: Quarterly bonus eligibility
• Exceptional coordination: Recognition and increased rates

**Recoup Protection:**
• Commission advanced for verified bookings
• Recoup occurs only in cases of patient no-show or cancellation
• 30-day recoup window with dispute resolution process

**Tracking and Reporting:**
• Real-time commission tracking in partner dashboard
• Monthly detailed statements with case-by-case breakdown
• Annual 1099 tax reporting for accounting compliance

This structure ensures facilities are rewarded for quality referrals while maintaining sustainable partnership economics.`,

                'How does the quote distribution system work?': `Our fair quote distribution system ensures equitable opportunity for all affiliate providers while prioritizing patient needs:

**Distribution Algorithm:**
• **Geographic Priority:** Providers within optimal transport radius receive priority
• **Capability Matching:** Equipment and certification requirements matched to patient needs
• **Response History:** 30-day response rate tracking influences distribution frequency
• **Quality Metrics:** Patient satisfaction and safety scores factor into selection

**Quote Window Management:**
• Standard quotes: 6-hour response window
• Urgent transports: 2-hour response window for critical cases
• Same-day requests: 1-hour response window with immediate notification

**Provider Rotation System:**
• **Round-robin base:** Equal distribution opportunity among qualified providers
• **Priority Partners:** Enhanced visibility for premium partnership tier
• **New Provider Integration:** Graduated introduction with monitoring period
• **Performance-Based Adjustments:** High-performing providers receive increased opportunities

**Quality Controls:**
• Maximum 6 quotes per request to prevent patient overwhelm
• Minimum response standards (48-hour acknowledgment required)
• Automatic removal from rotation for non-responsive providers
• Regular performance review and feedback integration

**Transparency Features:**
• Providers can view their distribution statistics and performance metrics
• Clear criteria communication for quote eligibility
• Regular reporting on network utilization and opportunities
• Open feedback system for continuous improvement

**Anti-Gaming Measures:**
• Automated monitoring for pricing manipulation
• Review of consistently high or low quotes
• Quality assurance checks on provider capabilities
• Regular network audits and compliance verification

This system maintains competitive pricing while ensuring all qualified providers have fair access to transport opportunities.`,

                'What documentation is required for transfers?': `Proper documentation ensures smooth transfers and regulatory compliance:

**Required Medical Documentation:**
• **Patient History & Physical:** Complete H&P within 48 hours of transport
• **Current Medications:** Full medication reconciliation with dosages and timing
• **Diagnostic Results:** Lab values, imaging studies, and test results from past 72 hours
• **Treatment Records:** Progress notes, procedure reports, and current treatment plan

**Transfer Authorization:**
• **Physician Orders:** Signed transfer orders with medical necessity justification
• **Receiving Facility Acceptance:** Written or electronic acceptance from destination
• **Insurance Pre-Authorization:** Prior authorization documentation when required
• **Family Consent:** Signed consent forms for transport and treatment continuation

**Regulatory Compliance:**
• **EMTALA Compliance:** Medical screening exam documentation and stabilization records
• **HIPAA Authorization:** Patient authorization for information sharing during transport
• **State Requirements:** Jurisdiction-specific transfer documentation
• **Transport Provider Credentials:** Verification of provider licenses and certifications

**Insurance and Financial:**
• **Insurance Verification:** Current coverage verification and benefit confirmation
• **Benefit Authorization:** Pre-authorization or notification as required by payer
• **Financial Responsibility:** Clear documentation of payment responsibility
• **Cost Estimates:** Transparent pricing information provided to patient/family

**Quality Assurance Documentation:**
• **Risk Assessment:** Patient acuity and transport risk evaluation
• **Equipment Needs:** Detailed requirements for specialized medical equipment
• **Communication Plan:** Contact information and communication protocols
• **Outcome Tracking:** Post-transport follow-up and quality metrics collection

**Electronic Integration:**
• **EMR Integration:** Seamless documentation transfer between systems
• **Real-Time Updates:** Live communication during transport process
• **Outcome Reporting:** Post-transport status and arrival confirmation
• **Audit Trail:** Complete documentation trail for quality review and compliance

Our platform streamlines this documentation process with automated workflows and integrated systems to reduce administrative burden while ensuring comprehensive compliance.`,

                'How are invoices generated and payments processed?': `Our automated billing system ensures accurate, timely processing of commissions and payments:

**Invoice Generation:**
• **Automated Processing:** Monthly invoices generated on the 1st of each month
• **Case-by-Case Detail:** Individual transport details with commission calculations
• **Cumulative Reporting:** Quarterly and annual summary reports
• **Electronic Delivery:** PDF invoices delivered via secure email and portal access

**Commission Calculation:**
• **Real-Time Tracking:** Transport completion triggers immediate commission calculation
• **Tiered Rate Application:** Automatic application of appropriate commission rate (4-5%)
• **Volume Bonus Integration:** Quarterly bonuses calculated and included automatically
• **Quality Adjustments:** Performance-based adjustments applied transparently

**Payment Processing:**
• **ACH Direct Deposit:** Electronic payments processed on 15th of each month
• **Net 30 Terms:** Payment 30 days after transport completion
• **International Options:** Wire transfers available for international partners
• **Payment Confirmation:** Automated confirmation emails with transaction details

**Accounting Integration:**
• **1099 Reporting:** Annual tax documents generated automatically
• **Chart of Accounts Mapping:** Integration with common accounting systems
• **Audit Trail:** Complete transaction history for compliance and review
• **Custom Reporting:** Tailored reports for specific accounting needs

**Dispute Resolution:**
• **24-Hour Response:** Billing inquiries addressed within one business day
• **Documentation Review:** Complete case file review for disputed charges
• **Escalation Process:** Structured resolution pathway with management involvement
• **Hold Protection:** Disputed amounts held separately pending resolution

**Revenue Optimization:**
• **Performance Analytics:** Detailed reporting on referral patterns and revenue trends
• **Opportunity Identification:** Recommendations for increased commission earning
• **Seasonal Adjustments:** Flexible terms during high-volume periods
• **Partnership Growth:** Structured pathway to premium commission tiers

**Security and Compliance:**
• **PCI DSS Compliance:** Secure payment processing meeting industry standards
• **HIPAA Compliance:** Protected health information security in billing processes
• **Data Encryption:** End-to-end encryption for all financial communications
• **Audit Compliance:** Regular third-party audits for process verification

This comprehensive billing system provides transparency and reliability while minimizing administrative overhead for partner facilities.`,

                'What transport types and equipment are available?': `Our network provides comprehensive transport capabilities for all medical scenarios:

**Aircraft Categories:**
• **Heavy Jets:** Long-distance transports (1000+ miles), full ICU capabilities, up to 3 family seats
• **Mid-Size Jets:** Regional transports (500-1000 miles), advanced life support, 1-2 family seats
• **Light Aircraft:** Local/regional (under 500 miles), basic to intermediate life support, limited family seating
• **Helicopters:** Emergency response (under 150 miles), critical care capabilities, no family seating

**Medical Equipment Levels:**
• **Level 1 (Stable):** Basic monitoring, oxygen, standard IV capabilities, non-critical transport
• **Level 2 (Moderate):** Advanced monitoring, ventilator support, multiple IV pumps, telemetry
• **Level 3 (Critical):** ECMO, CRRT, IABP, advanced ventilators, full ICU replication

**Specialized Transport Services:**
• **Neonatal/Pediatric:** Specialized NICU equipment, pediatric-trained staff, family accommodation
• **Cardiac:** Advanced cardiac monitoring, intervention capabilities, direct catheter lab transport
• **Organ Transport:** Time-critical coordination, specialized preservation equipment
• **Bariatric:** Reinforced stretchers, specialized aircraft configuration, enhanced crew training

**Ground Transport Integration:**
• **Airport to Facility:** Coordinated ambulance services at both endpoints
• **Critical Care Ground:** Extended ground transport with flight-level medical care
• **Specialty Vehicles:** Neonatal ambulances, stroke-capable units, cardiac intervention transport

**Crew Configurations:**
• **Nurse/Paramedic Teams:** Standard for Level 1-2 transports
• **Physician/Nurse Teams:** Required for Level 3 critical cases
• **Specialty Teams:** Neonatal, cardiac, or other specialty-trained crews
• **Multiple Crew Options:** Extended flights or high-acuity cases

**Network Coverage:**
• **National Coverage:** 50-state provider network with 24/7 availability
• **International Capability:** Medical repatriation and international transport coordination
• **Remote Area Access:** Specialized providers for challenging geographic locations
• **Disaster Response:** Emergency network activation for mass casualty or disaster scenarios

**Quality Standards:**
• **Certification Requirements:** All providers maintain DOT, FDA, and state certifications
• **Equipment Standards:** Regular maintenance and calibration protocols
• **Crew Training:** Ongoing education and certification maintenance programs
• **Safety Monitoring:** Continuous safety record monitoring and improvement initiatives

This comprehensive network ensures appropriate transport options are available regardless of patient acuity, geographic location, or special requirements.`,

                'Start Over': 'conversation_restart'
            },
            
            'Affiliate Provider': {
                'How do I become a MediFly affiliate?': `Joining the MediFly affiliate network connects you with a steady stream of qualified transport requests:

**Eligibility Requirements:**
• **Operating Certificates:** Current DOT Part 135 certificate (aircraft) or DOT vehicle permits (ground)
• **Insurance Coverage:** Minimum $10M liability, $1M per occurrence, current certificates
• **Medical Certifications:** Flight crews with current medical training certifications
• **Safety Standards:** Exemplary safety record with no major incidents in past 24 months

**Application Process:**
1. **Initial Application (Week 1):** Complete affiliate application with company credentials and certifications
2. **Documentation Review (Week 2):** Insurance verification, certificate validation, safety record review
3. **Operational Assessment (Week 3):** Fleet inspection, crew interviews, procedure review
4. **Network Integration (Week 4):** Platform training, system integration, test case coordination
5. **Go-Live Activation:** Begin receiving quote requests and transport opportunities

**Required Capabilities:**
• **24/7 Operations:** Round-the-clock dispatch and crew availability
• **Geographic Coverage:** Primary coverage area definition with backup arrangements
• **Equipment Standards:** Medical equipment inventory matching service level commitments
• **Communication Systems:** Real-time tracking, family communication, medical coordination

**Fleet and Crew Requirements:**
• **Aircraft Standards:** Well-maintained fleet with current certifications and medical configurations
• **Crew Qualifications:** Flight nurses, paramedics, or physicians with current certifications
• **Backup Systems:** Redundant aircraft and crew for operational reliability
• **Maintenance Programs:** FAA-approved maintenance schedules and documentation

**Technology Integration:**
• **Dispatch Systems:** Integration with MediFly quote distribution and communication platform
• **Tracking Capabilities:** Real-time flight tracking and status updates
• **Billing Integration:** Automated invoicing and payment processing systems
• **Quality Reporting:** Patient satisfaction and outcome reporting capabilities

**Onboarding Support:**
• **Dedicated Account Manager:** Personal support throughout integration process
• **Training Programs:** Comprehensive platform and process training for all staff
• **Marketing Materials:** Co-branded materials and referral network introduction
• **Performance Monitoring:** 90-day intensive support period with regular check-ins

**Network Benefits:**
• **Consistent Referrals:** Access to steady stream of qualified transport requests
• **Fair Distribution:** Equitable quote distribution based on geographic and capability matching
• **Quality Patients:** Pre-screened requests with verified medical necessity and payment capability
• **Professional Network:** Connection with leading hospitals and medical facilities nationwide

The affiliate network provides structured growth opportunities while maintaining the highest standards of patient care and operational excellence.`,

                'What are the commission rates and payment terms?': `Our affiliate compensation structure is designed to reward quality service while ensuring sustainable operations:

**Revenue Structure:**
• **Base Transport Fees:** Affiliates set their own pricing within market parameters ($20k-$72k typical range)
• **MediFly Commission:** 15% platform fee on completed transports (industry standard)
• **Payment Processing:** 2.9% credit card processing fee (standard rates)
• **Net Revenue:** Affiliates retain 82.1% of transport revenue on credit card transactions

**Payment Terms:**
• **Net 15 Processing:** Payments processed within 15 days of completed transport
• **ACH Direct Deposit:** Electronic payments to designated business account
• **Payment Confirmation:** Detailed remittance with case information and deductions
• **International Options:** Wire transfer capabilities for international affiliates

**Volume Incentives:**
• **Standard Tier:** 15% commission for 1-25 transports per quarter
• **Premium Tier:** 12% commission for 26-50 transports per quarter  
• **Elite Tier:** 10% commission for 51+ transports per quarter
• **Quality Bonuses:** Additional 1% reduction for 98%+ patient satisfaction scores

**Performance Metrics:**
• **Response Time:** 2-hour quote response required, 1-hour preferred
• **Completion Rate:** 95%+ completion rate for accepted quotes
• **Patient Satisfaction:** Target 95%+ satisfaction scores
• **Safety Record:** Zero tolerance for preventable safety incidents

**Additional Revenue Opportunities:**
• **Ground Transport Coordination:** Additional fees for airport-to-facility transport
• **Equipment Rental:** Revenue for specialized medical equipment provision
• **Standby Services:** Compensation for dedicated aircraft positioning
• **International Services:** Premium rates for medical repatriation services

**Cost Considerations:**
• **Fuel Costs:** Affiliates responsible for all fuel and operational costs
• **Crew Expenses:** All crew wages, benefits, and training costs
• **Insurance:** Comprehensive liability and hull insurance required
• **Maintenance:** All aircraft and equipment maintenance responsibilities

**Financial Protection:**
• **Payment Guarantee:** MediFly guarantees payment for completed services within terms
• **Dispute Resolution:** Structured process for billing or service disputes
• **Insurance Backup:** Additional coverage for non-payment scenarios
• **Legal Support:** Legal assistance for collection or dispute issues

**Competitive Analysis:**
• **Industry-Leading Rates:** Commission rates competitive with major networks
• **Faster Payments:** 15-day payment terms versus 30-45 day industry standard
• **Volume Recognition:** Tiered structure rewards growth and partnership
• **Quality Focus:** Performance bonuses reward excellence over volume alone

**Financial Reporting:**
• **Real-Time Tracking:** Live dashboard showing pending and processed payments
• **Monthly Statements:** Detailed financial statements with case-by-case breakdown
• **Annual Reporting:** 1099 tax documents and annual partnership summary
• **Analytics:** Revenue trends, opportunity analysis, and performance metrics

This compensation structure provides predictable revenue while rewarding quality service and operational excellence.`,

                'How does the fair quote distribution system work?': `Our distribution system ensures equitable access to transport opportunities while prioritizing patient care:

**Core Distribution Principles:**
• **Geographic Priority:** Providers within optimal response radius receive first consideration
• **Capability Matching:** Medical equipment and crew certifications matched to patient requirements
• **Performance-Based:** Response history and service quality influence distribution frequency
• **Fair Rotation:** Equal opportunity system prevents any single provider from dominating requests

**Request Distribution Process:**
1. **Initial Screening:** Patient requirements analyzed for medical complexity and geographic needs
2. **Provider Matching:** All qualified providers within service area identified
3. **Priority Assignment:** Geographic proximity, capability match, and performance scores calculated
4. **Quote Distribution:** Up to 6 qualified providers receive simultaneous quote requests
5. **Response Collection:** Providers submit quotes within designated time window
6. **Selection Support:** Customer receives comparative analysis for informed decision-making

**Performance Factors:**
• **Response Rate:** Percentage of quotes responded to within time limits (target: 90%+)
• **Acceptance Rate:** Percentage of accepted quotes successfully completed (target: 95%+)
• **Quality Scores:** Patient satisfaction and safety metrics (target: 95%+)
• **Communication:** Real-time updates and professional patient/family interaction

**Quote Window Management:**
• **Standard Requests:** 6-hour response window for routine transports
• **Urgent Cases:** 2-hour response window for time-sensitive situations
• **Emergency Transport:** 1-hour response window for critical cases
• **Automatic Escalation:** Non-responsive providers removed, backup providers notified

**Fair Access Protections:**
• **New Provider Integration:** 90-day supported introduction with guaranteed minimum quotes
• **Volume Distribution:** Monitoring to prevent excessive concentration with single providers
• **Geographic Balance:** Ensuring coverage in all service areas with multiple provider options
• **Seasonal Adjustments:** Distribution modifications during high-volume periods or weather events

**Quality Controls:**
• **Pricing Monitoring:** Review of consistently high or low quotes for reasonableness
• **Service Verification:** Post-transport quality checks and patient feedback integration
• **Provider Audits:** Regular review of certifications, insurance, and operational capabilities
• **Dispute Resolution:** Structured process for distribution complaints or concerns

**Performance Transparency:**
• **Individual Dashboards:** Real-time statistics on quotes received, response rates, and selections
• **Comparative Analysis:** Anonymous benchmarking against network performance standards
• **Improvement Recommendations:** Specific guidance for enhancing competitive position
• **Network Statistics:** Overall network performance and opportunity trends

**Anti-Gaming Measures:**
• **Quote Manipulation Detection:** Automated monitoring for pricing anomalies or gaming attempts
• **Response Gaming Prevention:** Systems to prevent false responses or quote inflation
• **Quality Gaming Protection:** Multiple verification points for patient satisfaction and safety
• **Regular Audits:** Periodic comprehensive reviews of distribution fairness and effectiveness

**Opportunity Enhancement:**
• **Performance Coaching:** Support for providers looking to improve competitive position  
• **Capability Development:** Guidance on equipment or certification upgrades for better matching
• **Geographic Expansion:** Support for providers expanding service coverage areas
• **Network Relationships:** Introduction to complementary providers for backup and partnership opportunities

This system maintains competitive dynamics while ensuring patient access to quality transport services and fair provider opportunity distribution.`,

                'Start Over': 'conversation_restart'
            }
        };
        
        return responseSets[userType] || {};
    }

    function showAIResponse(message, options = []) {
        const panel = document.getElementById('aiChatPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
        }
        
        // Create or update chat area
        let chatArea = document.getElementById('aiChatArea');
        if (!chatArea) {
            chatArea = document.createElement('div');
            chatArea.id = 'aiChatArea';
            chatArea.style.cssText = 'max-height: 400px; overflow-y: auto; padding: 15px; background: white; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;';
            panel.querySelector('.ai-body').insertBefore(chatArea, panel.querySelector('.ai-body').firstChild);
        }
        
        // Add response message
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = 'background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #007bff;';
        messageDiv.innerHTML = `<div style="color: #0056b3; font-weight: bold; margin-bottom: 8px;">MediFly Assistant</div><div style="line-height: 1.5; white-space: pre-line;">${message}</div>`;
        
        // Clear previous content and add new message
        chatArea.innerHTML = '';
        chatArea.appendChild(messageDiv);
        
        // Add option buttons if provided
        if (options.length > 0) {
            const optionsDiv = document.createElement('div');
            optionsDiv.style.cssText = 'margin-top: 15px;';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary btn-sm me-2 mb-2';
                button.textContent = option;
                button.onclick = () => {
                    if (option === 'Start Over') {
                        aiState = { userType: null, conversationStarted: false };
                        startAIConversation();
                    } else {
                        handleAIResponse(option);
                    }
                };
                optionsDiv.appendChild(button);
            });
            
            chatArea.appendChild(optionsDiv);
        }
        
        // Scroll to bottom
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    // Live countdown updates for announcement banners
    function updateCountdowns() {
        document.querySelectorAll('.countdown-timer').forEach(timer => {
            const target = timer.getAttribute('data-target');
            if (!target) return;
            
            const targetTime = new Date(target);
            const now = new Date();
            const diff = targetTime - now;
            
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                timer.innerHTML = `<i class="fas fa-clock me-1"></i>${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            } else {
                timer.innerHTML = `<i class="fas fa-check me-1"></i>We're live!`;
                timer.classList.add('text-success');
            }
        });
    }
    
    // Update countdowns every 60 seconds and on page load
    setInterval(updateCountdowns, 60000);
    document.addEventListener('DOMContentLoaded', updateCountdowns);
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
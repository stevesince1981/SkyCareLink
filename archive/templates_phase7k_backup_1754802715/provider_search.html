{% extends "consumer_base.html" %}

{% block title %}Provider Search - MediFly{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Hospital/Provider Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-hospital me-2"></i>Affiliate Dashboard</h1>
                <div class="btn-group">
                    <a href="{{ url_for('admin_panel') }}" class="btn btn-outline-primary">
                        <i class="fas fa-cog"></i> Admin Panel
                    </a>
                    <a href="{{ url_for('provider_rewards') }}" class="btn btn-outline-success">
                        <i class="fas fa-trophy"></i> My Rewards
                    </a>
                </div>
            </div>
            <p class="text-muted">Search and manage medical transport bookings</p>
        </div>
    </div>

    <!-- Search Interface -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-search me-2"></i>Booking Search</h5>
                </div>
                <div class="card-body">
                    <form method="get" action="{{ url_for('provider_search') }}">
                        <div class="row">
                            <div class="col-md-8">
                                <input type="text" 
                                       class="form-control" 
                                       name="search" 
                                       value="{{ search_query }}" 
                                       placeholder="Search by Booking ID, Provider, Origin, or Destination..."
                                       autofocus>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="filterBookings('all')">
                    All Bookings
                </button>
                <button type="button" class="btn btn-outline-success" onclick="filterBookings('completed')">
                    Completed
                </button>
                <button type="button" class="btn btn-outline-warning" onclick="filterBookings('high-severity')">
                    High Severity
                </button>
                <button type="button" class="btn btn-outline-info" onclick="filterBookings('recent')">
                    Last 7 Days
                </button>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list me-2"></i>Booking Results</h5>
                    <span class="badge bg-primary">{{ bookings|length }} results</span>
                </div>
                <div class="card-body">
                    {% if bookings %}
                    <div class="table-responsive">
                        <table class="table table-striped" id="bookingsTable">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Date</th>
                                    <th>Patient</th>
                                    <th>Route</th>
                                    <th>Affiliate</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in bookings %}
                                <tr data-status="{{ booking.status }}" data-severity="{{ booking.severity }}" data-date="{{ booking.date }}">
                                    <td>
                                        <strong class="text-primary">{{ booking.id }}</strong>
                                    </td>
                                    <td>{{ booking.date }}</td>
                                    <td>
                                        <div>
                                            <strong>{{ booking.patient_name }}</strong>
                                            <br><small class="text-muted">Contact: {{ booking.family_contact }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">{{ booking.origin }}</span>
                                            <i class="fas fa-arrow-right text-muted me-2"></i>
                                            <span>{{ booking.destination }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ booking.provider }}</strong>
                                            {% if booking.provider in provider_rewards %}
                                            <br><span class="badge bg-{{ 'warning' if provider_rewards[booking.provider].tier == 'Gold' else 'primary' if provider_rewards[booking.provider].tier == 'Platinum' else 'success' }} badge-sm">
                                                {{ provider_rewards[booking.provider].tier }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if booking.severity >= 4 else 'warning' if booking.severity == 3 else 'success' }}">
                                            Level {{ booking.severity }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ booking.status }}</span>
                                    </td>
                                    <td>
                                        <strong>${{ "{:,}".format(booking.cost) }}</strong>
                                    </td>
                                    <td>
                                        <div class="btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewBookingDetails('{{ booking.id }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" onclick="contactFamily('{{ booking.family_contact }}')">
                                                <i class="fas fa-phone"></i>
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" onclick="downloadReport('{{ booking.id }}')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>No bookings found</h5>
                        <p class="text-muted">
                            {% if search_query %}
                                No results for "{{ search_query }}". Try a different search term.
                            {% else %}
                                Start by searching for booking IDs, providers, or locations.
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Provider Performance Stats -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-primary">{{ bookings|length }}</h4>
                            <small>Total Bookings</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">100%</h4>
                            <small>Completion Rate</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">4.9</h4>
                            <small>Avg Rating</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-trophy me-2"></i>Reward Status</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <h4 class="text-success">Platinum Tier</h4>
                        <p>Rewards earned: <strong>$15,000</strong></p>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: 75%"></div>
                        </div>
                        <small class="text-muted">75% to Diamond tier</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filterBookings(filter) {
    const table = document.getElementById('bookingsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        let showRow = true;
        
        switch(filter) {
            case 'completed':
                showRow = row.getAttribute('data-status') === 'Completed';
                break;
            case 'high-severity':
                showRow = parseInt(row.getAttribute('data-severity')) >= 4;
                break;
            case 'recent':
                const bookingDate = new Date(row.getAttribute('data-date'));
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                showRow = bookingDate >= sevenDaysAgo;
                break;
            case 'all':
            default:
                showRow = true;
        }
        
        row.style.display = showRow ? '' : 'none';
    }
}

function viewBookingDetails(bookingId) {
    alert(`📋 Booking Details: ${bookingId}\n\n• Medical records available\n• Flight path tracked\n• Family notifications sent\n• Post-transport follow-up completed\n\nFull details would be shown in provider portal.`);
}

function contactFamily(familyContact) {
    alert(`📞 Family Contact: ${familyContact}\n\nContact options:\n• Phone call\n• SMS update\n• Email notification\n• Emergency contact\n\nFamily communication logged for HIPAA compliance.`);
}

function downloadReport(bookingId) {
    alert(`📥 Downloading report for ${bookingId}\n\nReport includes:\n• Transport summary\n• Medical equipment used\n• Timeline and notifications\n• Family feedback\n• HIPAA-compliant documentation\n\nFile will be downloaded securely.`);
}
</script>
{% endblock %}